<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FreezeSense - Commercial & Residential Ice Machine Monitoring</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%230ea5e9'/%3E%3Cpath d='M50 20 L30 35 L50 50 L70 35 Z' fill='white'/%3E%3Cpath d='M50 40 L30 55 L50 70 L70 55 Z' fill='%23e0f2fe'/%3E%3Cpath d='M50 60 L30 75 L50 90 L70 75 Z' fill='white'/%3E%3C/svg%3E" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="app" class="min-h-screen bg-gray-100">
        <div id="nav-placeholder"></div>
        
        <!-- Placeholders for dynamically loaded content -->
        <div id="main-content"></div>
        <div id="modals-placeholder"></div>
        <div id="footer-placeholder"></div>

    </div> <!-- Close #app -->

    <script>
        // Declare variables in outer scope
        let statusEl;
        let errorEl;
        let errorMessageEl;
        let devicesContainer;
        let consoleOutput;
        let debugConsole;

        // Function to load HTML components
        function loadComponent(componentPath, placeholderId) {
            // Return the fetch promise
            return fetch(componentPath)
                .then(response => {
                    if (!response.ok) {
                        console.error(`Failed to load ${componentPath}:`, response.status, response.statusText);
                        throw new Error(`Failed to load ${componentPath}: ${response.status}`);
                    }
                    return response.text();
                })
                .then(html => {
                    const placeholder = document.getElementById(placeholderId);
                    if (placeholder) {
                        placeholder.innerHTML = html;
                    } else {
                        console.error(`Placeholder element not found: ${placeholderId}`);
                    }
                })
                .catch(error => {
                    console.error(`Error loading ${componentPath}:`, error);
                    // Display error in a user-friendly way if possible
                    showError(`Failed to load essential component: ${componentPath}. Please refresh.`);
                    // Rethrow the error so Promise.all catches it
                    throw error; 
                });
        }

        // Single Load Handler
        window.onload = () => {
            Promise.all([
                loadComponent('/components/navigation.html', 'nav-placeholder'),
                loadComponent('/components/main-content.html', 'main-content'),
                loadComponent('/components/modals.html', 'modals-placeholder'),
                loadComponent('/components/footer.html', 'footer-placeholder')
            ]).then(() => {
                console.log("Essential components loaded.");

                // Assign element variables now that components are loaded
                statusEl = document.getElementById('status');
                errorEl = document.getElementById('error');
                errorMessageEl = document.getElementById('error-message');
                devicesContainer = document.getElementById('devices');
                consoleOutput = document.getElementById('console-output');
                debugConsole = document.getElementById('debug-console');

                // Now that components are loaded, perform actions dependent on them
                addRefreshButton(); // Assuming this depends on nav or main content
                fetchDevices(); // Initial fetch depends on nav potentially (lastUpdateTime)

                // Corrected Modal Check (run AFTER modals are loaded)
                setTimeout(() => { // Use setTimeout to ensure DOM has rendered
                    const requiredModals = ['faq-modal', 'disclaimer-modal', 'contact-modal'];
                    const missingModals = requiredModals.filter(id => !document.getElementById(id));
                    
                    if (missingModals.length > 0) {
                        console.error('Missing modals after component load:', missingModals);
                        // Optional: Attempt re-injection using modals-placeholder
                        missingModals.forEach(modalId => {
                             // Simplified re-injection logic - might need refinement
                             if (document.getElementById('modals-placeholder')) {
                                 console.warn(`Attempting to handle missing modal: ${modalId}`);
                                 // Basic idea: fetch modals.html again and append the specific missing modal
                                 // This is complex and might be better handled by ensuring loadComponent works reliably
                             } else {
                                 console.error("Cannot re-inject modal, placeholder 'modals-placeholder' not found.")
                             }
                        });
                    } else {
                        console.log('All required modals verified after component load');
                    }
                }, 100); // Short delay

                // Set up the refresh interval (can start after initial load)
                const interval = setInterval(fetchDevices, 21600000); // 6 hours

                // Cleanup interval when page is unloaded
                window.addEventListener('unload', () => {
                    clearInterval(interval);
                });

            }).catch(error => {
                console.error("Failed to load one or more essential components:", error);
                // Display a generic error message since showError might rely on loaded components
                const errorDiv = document.getElementById('error');
                const errorMsgSpan = document.getElementById('error-message');
                if(errorDiv && errorMsgSpan) {
                    errorMsgSpan.textContent = 'Failed to load page components. Please refresh.';
                    errorDiv.classList.remove('hidden');
                }
            });
        };

        // Update this at the start of your script
        const API_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:3000'
            : 'https://freezesense.up.railway.app';

        // Debug Console Functions
        function toggleConsole() {
            debugConsole.classList.toggle('hidden');
        }

        function clearConsole() {
            consoleOutput.innerHTML = '';
        }

        function logToConsole(data, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type === 'error' ? 'text-red-400' : 
                             type === 'warning' ? 'text-yellow-400' : 
                             'text-green-400';
            
            const logEntry = document.createElement('div');
            logEntry.className = colorClass;
            logEntry.innerHTML = `[${timestamp}] ${typeof data === 'object' ? JSON.stringify(data, null, 2) : data}`;
            
            consoleOutput.appendChild(logEntry);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }
        function parseTsArray(arr) {
            // Log the raw input for debugging
            logToConsole('parseTsArray raw input:', {
                isArray: Array.isArray(arr),
                length: arr?.length || 0,
                sample: arr?.slice(0, 3),
                type: typeof arr
            }, 'info');

            if (!Array.isArray(arr)) {
                logToConsole('parseTsArray received non-array input:', arr, 'warning');
                return { times: [], values: [] };
            }

            // Map the data, handling different possible property names
            const result = {
                times: arr.map(obj => {
                    // Try different possible timestamp properties
                    const timestamp = obj.time || obj.timestamp || obj.created_at || obj.date;
                    if (!timestamp) {
                        logToConsole('Missing timestamp in object:', obj, 'warning');
                    }
                    return timestamp;
                }),
                values: arr.map(obj => {
                    // Try to get value, handling different possible structures
                    const value = obj.hasOwnProperty('value') ? obj.value :
                                 obj.hasOwnProperty('data') ? obj.data :
                                 obj.hasOwnProperty('reading') ? obj.reading : null;
                    
                    if (value === undefined || value === null) {
                        logToConsole('Missing value in object:', obj, 'warning');
                    }
                    return value;
                })
            };

            // Validate array lengths match
            if (result.times.length !== result.values.length) {
                logToConsole('Array length mismatch in parseTsArray:', {
                    timesLength: result.times.length,
                    valuesLength: result.values.length,
                    sampleTimes: result.times.slice(0, 3),
                    sampleValues: result.values.slice(0, 3)
                }, 'error');
            }

            // Remove any entries where either time or value is null/undefined
            const validIndices = result.times.map((time, i) => 
                time && result.values[i] !== undefined && result.values[i] !== null ? i : -1
            ).filter(i => i !== -1);

            const cleanResult = {
                times: validIndices.map(i => result.times[i]),
                values: validIndices.map(i => result.values[i])
            };

            // Log the final processed result
            logToConsole('parseTsArray processed result:', {
                originalLength: arr.length,
                validLength: cleanResult.times.length,
                sample: validIndices.slice(0, 3).map(i => ({
                    time: new Date(cleanResult.times[i]).toLocaleString(),
                    value: cleanResult.values[i]
                }))
            }, 'info');

            return cleanResult;
        }
        function showLoading() {
            statusEl.classList.remove('hidden');
            errorEl.classList.add('hidden');
            devicesContainer.innerHTML = '';
        }

        function showError(message) {
            statusEl.classList.add('hidden');
            errorEl.classList.remove('hidden');
            errorMessageEl.textContent = message;
            logToConsole(message, 'error');
        }

        function hideLoading() {
            statusEl.classList.add('hidden');
        }

        async function checkServerHealth() {
            try {
                const response = await fetch(`${API_URL}/health`);
                if (!response.ok) throw new Error('Server health check failed');
                return true;
            } catch (error) {
                console.error('Server health check failed:', error);
                logToConsole('Server health check failed: ' + error.message, 'error');
                return false;
            }
        }

        function updateLastUpdateTime() {
            const now = new Date();
            document.getElementById('lastUpdateTime').textContent = now.toLocaleTimeString();
        }

        async function fetchDevices() {
            showLoading();
            
            try {
                // First check if server is healthy
                const isHealthy = await checkServerHealth();
                if (!isHealthy) {
                    throw new Error('Server is not responding. Please make sure the server is running.');
                }

                const response = await fetch(`${API_URL}/api/devices`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const devices = await response.json();
                
                if (devices.error) {
                    throw new Error(devices.message || devices.error);
                }
                
                // Sort devices by name
                devices.sort((a, b) => {
                    // Extract numbers from device names (assuming format like "001", "002", etc.)
                    const aNum = parseInt(a.name.replace(/\D/g, '')) || 0;
                    const bNum = parseInt(b.name.replace(/\D/g, '')) || 0;
                    return aNum - bNum;
                });
                
                // Store the sorted devices data for modal use
                window.lastDevicesData = devices;
                
                // Update last update time
                updateLastUpdateTime();
                
                // Log raw device data to console
                logToConsole('Received device data (sorted):');
                logToConsole(devices);
                
                displayDevices(devices);
                hideLoading();
            } catch (error) {
                console.error('Error fetching devices:', error);
                showError(error.message || 'Failed to fetch devices. Please try again later.');
            }
        }

        function formatPropertyValue(property) {
            if (property.last_value === undefined || property.last_value === null) {
                return 'N/A';
            }

            switch(property.type) {
                case 'BOOL':
                    return property.last_value ? 'True' : 'False';
                case 'FLOAT':
                    if (property.name === 'sensorplacement') {
                        const percentage = property.last_value * 100;
                        return `${percentage}%`;
                    }
                    if (property.name.toLowerCase().includes('temp')) {
                        const fahrenheit = celsiusToFahrenheit(property.last_value);
                        return `${fahrenheit.toFixed(1)}°F`;
                    }
                    if (property.name.toLowerCase().includes('flow')) {
                        return `${Number(property.last_value).toFixed(2)} L/min`;
                    }
                    return Number(property.last_value).toFixed(2);
                case 'INT':
                    return property.last_value.toString();
                case 'STRING':
                    return property.last_value;
                default:
                    return property.last_value;
            }
        }

        function getPropertyInputType(property) {
            switch(property.type) {
                case 'BOOL':
                    return 'checkbox';
                case 'INT':
                case 'FLOAT':
                    return 'number';
                default:
                    return 'text';
            }
        }

        function getPropertyStep(property) {
            switch(property.type) {
                case 'FLOAT':
                    return '0.01';
                case 'INT':
                    return '1';
                default:
                    return 'any';
            }
        }

        function fahrenheitToCelsius(fahrenheit) {
            return (fahrenheit - 32) * 5/9;
        }

        async function updatePropertyValue(deviceId, property) {
            try {
                if (!deviceId || !property) {
                    throw new Error('Device ID and Property are required');
                }

                // Log the update attempt with all details
                logToConsole({
                    message: 'Attempting to update property',
                    deviceId: deviceId,
                    propertyName: property.name,
                    currentValue: property.last_value,
                    newValue: property.new_value,
                    propertyType: property.type
                }, 'info');

                // Format the value based on type
                let formattedValue;
                switch(property.type) {
                    case 'INT':
                        formattedValue = parseInt(property.new_value);
                        if (isNaN(formattedValue)) {
                            throw new Error('Invalid integer value');
                        }
                        break;
                    case 'FLOAT':
                        // Convert Fahrenheit to Celsius if this is a temperature property
                        if (property.name.toLowerCase().includes('temp')) {
                            formattedValue = fahrenheitToCelsius(parseFloat(property.new_value));
                        } else {
                            formattedValue = parseFloat(property.new_value);
                        }
                        if (isNaN(formattedValue)) {
                            throw new Error('Invalid float value');
                        }
                        break;
                    case 'BOOL':
                        // Convert to actual boolean instead of string
                        formattedValue = property.new_value === true || property.new_value === 'true';
                        break;
                    case 'CHARSTRING':
                    case 'STATUS':
                        formattedValue = String(property.new_value).trim();
                        if (!formattedValue) {
                            throw new Error('Value cannot be empty');
                        }
                        break;
                    default:
                        formattedValue = property.new_value;
                }

                // Using V2 API endpoint format and structure
                const apiUrl = `${API_URL}/api/iot/v2/devices/${deviceId}/properties`;

                // Construct payload exactly as per Arduino V2 API docs
                const requestBody = {
                    propertiesValues: {
                        input: true,
                        properties: [{
                            name: property.name,
                            type: property.type,
                            value: formattedValue // Send raw value without converting to string
                        }]
                    }
                };

                logToConsole({
                    message: 'Sending update request',
                    url: apiUrl,
                    body: requestBody
                }, 'info');

                const response = await fetch(apiUrl, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'X-Organization': property.organization_id || ''  // Add organization ID if available
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => null);
                    throw new Error(errorData?.error || `HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                logToConsole({
                    message: 'Update successful',
                    deviceId: deviceId,
                    propertyName: property.name,
                    response: result
                }, 'info');

                // Refresh the devices list to show the new value
                await fetchDevices();
                setTimeout(() => {
                    location.reload(true);
                }, 3000); // Wait 3 seconds before reloading
                
            } catch (error) {
                logToConsole({
                    message: 'Error updating property',
                    error: error.message,
                    deviceId: deviceId,
                    propertyName: property?.name
                }, 'error');
                showError(`Failed to update property: ${error.message}`);
            }
        }

       

        // Enter key handler - triggers the update button click
        function handlePropertyInputKeydown(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const input = event.target;
                const button = input.nextElementSibling;
                if (button) {
                    button.click();
                }
            }
        }

        // Remove all other handlers to avoid conflicts
        function handlePropertyUpdate(event) {
            if (event.key === 'Enter') {
                handlePropertyInputKeydown(event);
            }
        }

        function handlePropertyInputChange(event) {
            const input = event.target;
            if (input.type === 'checkbox') {
                const button = input.nextElementSibling;
                if (button) {
                    button.click();
                }
            }
        }

        // Remove keyboard shortcut for auto-commit since it's no longer needed
        document.removeEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'C') {
                autoCommitChanges();
            }
        });

        // Add date validation function
        function isValidMaintenanceDate(dateStr) {
            // Check if the format is correct (MM/DD/YYYY)
            const regex = /^(0[1-9]|1[0-2])\/(0[1-9]|[12][0-9]|3[01])\/[0-9]{4}$/;
            if (!regex.test(dateStr)) return false;

            // Parse the date
            const [month, day, year] = dateStr.split('/').map(num => parseInt(num));
            const date = new Date(year, month - 1, day); // month is 0-based in JS

            // Check if the date is valid and not in the future
            const now = new Date();
            now.setHours(23, 59, 59, 999); // End of today
            if (date > now) return false;

            // Check if the parsed date matches the input
            // This catches invalid dates like 02/31/2024
            return date.getMonth() === month - 1 && 
                   date.getDate() === day && 
                   date.getFullYear() === year;
        }

        // Modify the property update handling
        function handlePropertyInputKeydown(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const input = event.target;
                const button = input.nextElementSibling;
                if (button) {
                    button.click(); // Use native click instead of dispatching event
                }
            }
        }

        function handlePropertyInputChange(event) {
            const input = event.target;
            const deviceId = input.dataset.deviceId;
            
            try {
                const property = JSON.parse(input.dataset.property);
                property.new_value = input.type === 'checkbox' ? input.checked : input.value;
                
                if (!deviceId) {
                    throw new Error('Device ID is missing');
                }
                
                updatePropertyValue(deviceId, property);
            } catch (error) {
                logToConsole(`Error handling property input: ${error.message}`, 'error');
                showError(`Failed to handle property input: ${error.message}`);
            }
        }

        function getPropertyBgColor(propertyName) {
            const colorMap = {
                'temp': 'bg-blue-50',
                'temperature': 'bg-blue-50',
                'humidity': 'bg-green-50',
                'flow': 'bg-purple-50',
                'pressure': 'bg-yellow-50',
                'level': 'bg-indigo-50',
                'status': 'bg-gray-50',
                'Last_Maintenance': 'bg-amber-50',
                'location': 'bg-teal-50',
                'sensorplacement': 'bg-indigo-50'
            };

            for (const [key, color] of Object.entries(colorMap)) {
                if (propertyName.toLowerCase().includes(key) || propertyName === key) {
                    return color;
                }
            }
            return 'bg-gray-50';
        }

        function getPropertyTextColor(propertyName) {
            const colorMap = {
                'temp': 'text-blue-800',
                'temperature': 'text-blue-800',
                'humidity': 'text-green-800',
                'flow': 'text-purple-800',
                'pressure': 'text-yellow-800',
                'level': 'text-indigo-800',
                'status': 'text-gray-800',
                'Last_Maintenance': 'text-amber-800',
                'location': 'text-teal-800',
                'sensorplacement': 'text-indigo-800'
            };

            for (const [key, color] of Object.entries(colorMap)) {
                if (propertyName.toLowerCase().includes(key) || propertyName === key) {
                    return color;
                }
            }
            return 'text-gray-800';
        }

        function celsiusToFahrenheit(celsius) {
            if (celsius === undefined || celsius === null) return undefined;
            return (celsius * 9/5) + 32;
        }

        function formatTemperature(celsius, maxThreshold = null) {
            if (celsius === undefined || celsius === null) return 'N/A';
            const fahrenheit = celsiusToFahrenheit(celsius);
            const value = `${fahrenheit.toFixed(1)}°F`;
            // Remove conditional span wrapper
            return value;
        }

        function getTemperatureCardClass(temp, maxThreshold) {
            if (temp === undefined || temp === null || maxThreshold === undefined || maxThreshold === null) {
                // Return empty string if no data
                return '';
            }
            // Return only the border class if critical, otherwise empty string
            return temp >= maxThreshold ? 'border-red-500 border-2' : '';
        }

        function formatTimeDuration(milliseconds) {
            if (!milliseconds) return 'N/A';
            
            const seconds = Math.floor(milliseconds / 1000);
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const remainingSeconds = seconds % 60;
            
            return `${hours}h ${minutes}m ${remainingSeconds}s`;
        }

        // Helper function to format durations for the status graph
        function formatDuration(milliseconds) {
            if (!milliseconds) return '0s';
            
            const seconds = Math.floor(milliseconds / 1000);
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const remainingSeconds = seconds % 60;
            
            let parts = [];
            if (hours > 0) parts.push(`${hours}h`);
            if (minutes > 0) parts.push(`${minutes}m`);
            if (remainingSeconds > 0 || parts.length === 0) parts.push(`${remainingSeconds}s`);
            
            return parts.join(' ');
        }

        // Store timers for cleanup
        let timeSinceFlowTimers = [];

        function clearTimeSinceFlowTimers() {
            timeSinceFlowTimers.forEach(timer => clearInterval(timer));
            timeSinceFlowTimers = [];
        }


        // Function to calculate time since last flow and update the display
        function updateTimeSinceFlow(deviceId, startTime, criticalTime, element, cardElement) {
            let lastCriticalState = null; // Track the last critical state
            const update = () => {
                const timeSinceFlowMs = new Date() - new Date(startTime);
                const timeSinceFlowHours = timeSinceFlowMs / (1000 * 60 * 60);
                element.textContent = formatTimeDuration(timeSinceFlowMs);

                // Directly check if the current time exceeds the critical threshold
                const isCriticalNow = timeSinceFlowHours !== null && criticalTime !== undefined && criticalTime !== null && parseFloat(timeSinceFlowHours) >= parseFloat(criticalTime);

                // Add or remove styling based on the critical state
                if (isCriticalNow) {
                    cardElement.classList.add('border-red-500', 'border-2');
                    // Make text red
                    element.classList.remove('text-blue-900');
                    element.classList.add('text-red-700');
                } else {
                    cardElement.classList.remove('border-red-500', 'border-2');
                    // Make text blue
                    element.classList.remove('text-red-700');
                    element.classList.add('text-blue-900');
                }

                // Only log when critical state changes
                if (isCriticalNow !== lastCriticalState) {
                    lastCriticalState = isCriticalNow;
                    if (isCriticalNow) {
                        logToConsole(`Flow state changed to critical for device ${deviceId}:`, {
                            timeSinceFlowHours,
                            criticalTime,
                            lastUpdate: startTime
                        });
                    }
                }
            };

            update(); // Initial update
            const timer = setInterval(update, 1000); // Update every second
            timeSinceFlowTimers.push(timer);
            return timer;
        }

        // Add cooldown tracking for warning and critical updates
        const lastStatusUpdate = {
            warning: {},
            critical: {}
        };

        const COOLDOWN_TIME = 5000; // 5 seconds in milliseconds

        function canUpdateStatus(deviceId, statusType) {
            const lastUpdate = lastStatusUpdate[statusType][deviceId];
            if (!lastUpdate) return true;
            
            const timeSinceLastUpdate = Date.now() - lastUpdate;
            return timeSinceLastUpdate >= COOLDOWN_TIME;
        }

        function updateLastStatusTime(deviceId, statusType) {
            lastStatusUpdate[statusType][deviceId] = Date.now();
            logToConsole(`Updated ${statusType} status for device ${deviceId}. Next update allowed after ${new Date(Date.now() + COOLDOWN_TIME).toLocaleTimeString()}`);
        }

        function calculateDeviceStatus(device) {
            // Check connection status from Arduino Cloud
            const statusEvent = device.events?.find(event => event.name === 'r_status');
            const isConnected = statusEvent?.value === 'CONNECTED';
            const lastConnectedTime = statusEvent?.updated_at;

            // Find key properties
            const properties = device.thing?.properties || [];
            
            // Get current warning and critical states with normalized boolean values
            const warningProperty = properties.find(p => p.name === 'warning');
            const criticalProperty = properties.find(p => p.name === 'critical');
            
            // Helper function to normalize boolean values
            const normalizeBoolean = (value) => {
                if (value === 'true' || value === true) return true;
                if (value === 'false' || value === false) return false;
                return false; // default value
            };
            
            // Normalize current values
            const currentWarning = normalizeBoolean(warningProperty?.last_value);
            const currentCritical = normalizeBoolean(criticalProperty?.last_value);

            // Get cloud temperature
            const cloudTemp = properties.find(p => 
                p.name === 'cloudtemp'
            )?.last_value;

            // Get temperature threshold max
            const tempThresholdMax = properties.find(p => 
                p.name === 'tempThresholdMax'
            )?.last_value;

            // Get flow related properties
            const cloudFlowRate = properties.find(p => 
                p.name === 'cloudflowrate'
            );

            const noFlowCriticalTime = properties.find(p => 
                p.name === 'noFlowCriticalTime'
            )?.last_value;

            // Calculate time since last flow
            const flowLastUpdate = cloudFlowRate?.value_updated_at;
            const timeSinceFlowMs = flowLastUpdate ? new Date() - new Date(flowLastUpdate) : null;
            const timeSinceFlowHours = timeSinceFlowMs ? timeSinceFlowMs / (1000 * 60 * 60) : null;

            // Status conditions
            const isTemperatureBad = cloudTemp !== undefined && cloudTemp > tempThresholdMax;
            const isFlowBad = timeSinceFlowHours !== null && !isNaN(noFlowCriticalTime) && timeSinceFlowHours >= noFlowCriticalTime;

            // Great: Device must be connected AND temperature is below threshold AND flow time is below critical threshold
            const isGreat = isConnected && !isTemperatureBad && !isFlowBad;

            // Warning: Device must be connected AND exactly one condition is bad (temp XOR flow)
            const isWarning = isConnected && ((isTemperatureBad || isFlowBad) && !(isTemperatureBad && isFlowBad));

            // Critical: Device is disconnected OR both temperature and flow are bad
            const isCritical = !isConnected || (isTemperatureBad && isFlowBad);

            // Compare normalized boolean values
            const shouldUpdateWarning = currentWarning !== isWarning;
            const shouldUpdateCritical = currentCritical !== isCritical;

            // Debug logging
            if (shouldUpdateWarning || shouldUpdateCritical) {
                logToConsole('Status update check:', {
                    deviceId: device.id,
                    currentWarning,
                    isWarning,
                    currentCritical,
                    isCritical,
                    shouldUpdateWarning,
                    shouldUpdateCritical,
                    temperature: cloudTemp,
                    tempThreshold: tempThresholdMax,
                    timeSinceFlowHours,
                    noFlowCriticalTime
                });
            }

            // Only update if the values are actually different and cooldown period has elapsed
            if (shouldUpdateWarning && canUpdateStatus(device.id, 'warning')) {
                logToConsole(`Auto-updating warning status for device ${device.id} from ${currentWarning} to ${isWarning}`);
                handleManualStatusUpdate(device.id, 'warning', isWarning);
            }

            if (shouldUpdateCritical && canUpdateStatus(device.id, 'critical')) {
                logToConsole(`Auto-updating critical status for device ${device.id} from ${currentCritical} to ${isCritical}`);
                handleManualStatusUpdate(device.id, 'critical', isCritical);
            }

            // Get sensor placement
            const sensorPlacement = properties.find(p => 
                p.name === 'sensorplacement'
            )?.last_value;

            // Calculate ice level based on temperature and sensor placement
            // const tempF = cloudTemp !== undefined ? celsiusToFahrenheit(cloudTemp) : undefined; // No longer needed for this calculation
            // const isIceAboveSensor = tempF !== undefined && tempF <= 34; // OLD LOGIC - Incorrectly used hardcoded 34F
            const isIceAboveSensor = cloudTemp !== undefined && tempThresholdMax !== undefined && cloudTemp <= tempThresholdMax; // NEW LOGIC - Use dynamic threshold

            // If temperature is ≤ threshold, ice is above the sensor placement
            // If temperature is > threshold, ice is below the sensor placement
            const iceLevel = {
                isAboveSensor: isIceAboveSensor,
                sensorPlacement: sensorPlacement
            };

            return {
                isConnected,
                isGreat,
                isWarning,
                isCritical,
                cloudTemp,
                tempThresholdMax,
                cloudFlowRate: cloudFlowRate?.last_value,
                timeSinceFlowMs,
                timeSinceFlowHours,
                noFlowCriticalTime,
                flowLastUpdate,
                lastConnectedTime,
                iceLevel,
                sensorPlacement
            };
        }

        // Update the ice level display in the device card
        function getIceLevelText(status) {
            if (status.sensorPlacement === undefined || status.sensorPlacement === null) {
                return 'Sensor placement not set';
            }
            
            const placement = (status.sensorPlacement * 100).toFixed(0);
            if (status.cloudTemp === undefined || status.tempThresholdMax === undefined) {
                return 'Temperature data unavailable';
            }

            // Compare with threshold temperature
            return status.cloudTemp <= status.tempThresholdMax ? 
                `More than ${placement}% full` : 
                `Less than ${placement}% full`;
        }

        // Add this sorting function before displayDevices
        function sortProperties(properties) {
            // Define priority properties
            const priorityProps = ['cloudtemp', 'cloudflowrate'];
            
            return [...properties].sort((a, b) => {
                // Get indices in priority array (-1 if not found)
                const aIndex = priorityProps.indexOf(a.name);
                const bIndex = priorityProps.indexOf(b.name);
                
                // If both are priority properties, sort by priority array order
                if (aIndex !== -1 && bIndex !== -1) {
                    return aIndex - bIndex;
                }
                
                // If only a is priority property, it goes first
                if (aIndex !== -1) return -1;
                
                // If only b is priority property, it goes first
                if (bIndex !== -1) return 1;
                
                // For non-priority properties, maintain original order
                return 0;
            });
        }

        function displayDevices(devices) {
            // Clear existing timers before updating display
            clearTimeSinceFlowTimers();

            // Update device counts
            const activeDevices = devices.length;
            const deviceStatuses = devices.map(device => calculateDeviceStatus(device));
            const connectedDevices = deviceStatuses.filter(status => status.isConnected).length;
            const greatDevices = deviceStatuses.filter(status => status.isGreat).length;
            const warningDevices = deviceStatuses.filter(status => status.isWarning).length;
            const criticalDevices = deviceStatuses.filter(status => status.isCritical).length;
            const disconnectedDevices = activeDevices - connectedDevices;
            
            document.getElementById('connectedDevicesCount').textContent = `${connectedDevices} / ${activeDevices}`;

            // Update disconnected badge
            const badgeElement = document.getElementById('disconnectedBadgeCount');
            if (badgeElement) {
                if (disconnectedDevices > 0) {
                    badgeElement.textContent = disconnectedDevices;
                    badgeElement.classList.remove('hidden');
                } else {
                    badgeElement.classList.add('hidden');
                }
            }

            if (!Array.isArray(devices) || devices.length === 0) {
                devicesContainer.innerHTML = `
                    <div class="col-span-full text-center py-8">
                        <div class="max-w-sm mx-auto">
                            <svg class="w-12 h-12 mx-auto text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M12 12h.01M12 12h.01M12 12h.01M12 12h.01M12 12h.01M12 12h.01M12 12h.01M12 12h.01M12 12h.01M12 12h.01M12 12h.01M12 12h.01M12 12h.01M12 12h.01M12 12h.01M12 12h.01M12 12h.01" />
                            </svg>
                            <p class="mt-4 text-gray-500 text-lg">No devices found</p>
                            <p class="mt-2 text-gray-400 text-sm">Connect a device to get started</p>
                        </div>
                    </div>
                `;
                logToConsole('No devices found', 'warning');
                return;
            }

            // Log each device's data individually with more detail
            devices.forEach((device, idx) => {
                logToConsole(`Device ${idx + 1} (${device.name || device.id}):`);
                if (device.thing && device.thing.properties) {
                    logToConsole('Properties found:');
                    device.thing.properties.forEach(prop => {
                        logToConsole(`- ${prop.name}: ${prop.last_value} (${prop.type})`);
                    });
                } else {
                    logToConsole('No properties found for this device');
                }
            });

            devicesContainer.innerHTML = devices.map((device, index) => {
                const status = calculateDeviceStatus(device);

                // Determine conditional border classes
                const isTempCritical = status.cloudTemp !== undefined && status.tempThresholdMax !== undefined && status.cloudTemp >= status.tempThresholdMax;
                const isIceLevelCritical = !status.iceLevel.isAboveSensor && status.sensorPlacement !== undefined;

                const tempBorderClass = isTempCritical ? 'border-red-500 border-2' : '';
                const iceLevelBorderClass = isIceLevelCritical ? 'border-red-500 border-2' : '';
                const statusBorderClass = status.isCritical ? 'border-red-500 border-2' : '';

                // Determine conditional text classes
                // const iceLevelTextClass = isIceLevelCritical ? 'text-red-700' : 'text-blue-900'; // Removed: Handled by parent class
                // const tempTextClass = isTempCritical ? 'text-red-700' : 'text-blue-900'; // Removed: Handled by parent class
                // Status text color is handled inline based on isGreat/isWarning/isCritical

                // Determine parent-level style class for Ice Level card when critical
                const iceLevelParentStyleClass = isIceLevelCritical ? '[&_svg]:text-red-600 [&_p]:text-red-700' : '';
                // Determine parent-level style class for Temperature card when critical
                const tempParentStyleClass = isTempCritical ? '[&_svg]:text-red-600 [&_p]:text-red-700' : '';
                // Determine parent-level style class for Status card when critical
                const statusParentStyleClass = status.isCritical ? '[&_svg]:text-red-600 [&_p]:text-red-700' : '';

                return `
                <div class="device-card bg-white rounded-xl shadow-sm border border-gray-200 p-4 relative overflow-hidden">
                    <!-- Device Header -->
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="text-base font-bold text-gray-800 mb-0.5">
                                ${device.thing?.properties?.find(p => p.name === 'devicename')?.last_value || `Device ${device.name.replace(/[^0-9]/g, '')}`}
                            </h3>
                            <p class="text-xs text-gray-600 flex items-center">
                                <svg class="w-3 h-3 mr-1 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                                ${device.thing?.properties?.find(p => p.name === 'location')?.last_value || 'Location not set'}
                            </p>
                        </div>
                        <div class="flex flex-col items-end">
                            <span class="connected-badge px-2 py-0.5 text-xs font-medium rounded-full ${status.isConnected ? 'bg-green-100 text-green-800 border border-green-200' : 'bg-red-100 text-red-800 border border-red-200'} shadow-sm">
                        <div class="flex items-center">
                                    <div class="w-1.5 h-1.5 rounded-full ${status.isConnected ? 'bg-green-500' : 'bg-red-500'} mr-1"></div>
                                ${status.isConnected ? 'Connected' : 'Disconnected'}
                                </div>
                            </span>
                            ${!status.isConnected && status.lastConnectedTime ? `
                                <p class="text-[10px] text-red-600 mt-1">Last Connected:<br>${new Date(status.lastConnectedTime).toLocaleString()}</p>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2 mb-3">
                        <!-- Ice Level -->
                        <div class="property-card bg-gradient-to-br from-blue-50 to-blue-100 p-2.5 rounded-lg ${iceLevelBorderClass} ${iceLevelParentStyleClass}">
                            <div class="flex items-center mb-1">
                                <svg class="w-3 h-3 text-blue-600 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                                </svg>
                            <p class="text-blue-800 font-medium text-xs">Ice Level</p>
                            </div>
                            <p class="text-sm font-bold leading-tight text-blue-900">
                                ${getIceLevelText(status)}
                            </p>
                        </div>
                        
                        <!-- Temperature -->
                        <div class="property-card bg-gradient-to-br from-blue-50 to-blue-100 p-2.5 rounded-lg ${tempBorderClass} ${tempParentStyleClass}">
                            <div class="flex items-center mb-1">
                                <svg class="w-3 h-3 text-blue-600 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                                </svg>
                            <p class="text-blue-800 font-medium text-xs">Temperature</p>
                            </div>
                            <p class="text-sm font-bold leading-tight text-blue-900">${formatTemperature(status.cloudTemp)}</p>
                            <p class="text-[10px] text-blue-600 mt-0.5 flex items-center">
                                <svg class="w-2.5 h-2.5 mr-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                                </svg>
                                Max: ${formatTemperature(status.tempThresholdMax)}
                            </p>
                        </div>
                        
                        <!-- Time Since Flow -->
                        <div class="property-card bg-gradient-to-br from-blue-50 to-blue-100 p-2.5 rounded-lg"> <!-- Border and Text color handled by JS -->
                            <div class="flex items-center mb-1">
                                <svg class="w-3 h-3 text-blue-600 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                </svg>
                            <p class="text-blue-800 font-medium text-xs">Time Since Flow</p>
                            </div>
                            <p class="text-sm font-bold text-blue-900 leading-tight time-since-flow" {/* Base text color is blue, JS toggles red */}
                               data-start-time="${status.flowLastUpdate || ''}"
                               data-critical-time="${status.noFlowCriticalTime || ''}"
                               data-device-id="${device.id}">
                                ${formatTimeDuration(status.timeSinceFlowMs)}
                            </p>
                            <div class="text-[10px] text-blue-600 mt-0.5">
                                <div class="flex items-center">
                                    <svg class="w-2.5 h-2.5 mr-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    Critical: ${status.noFlowCriticalTime !== undefined ? status.noFlowCriticalTime + 'h' : 'N/A'}
                                </div>
                                <div class="flex items-center mt-0.5">
                                    <svg class="w-2.5 h-2.5 mr-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                    </svg>
                                Last: ${status.flowLastUpdate ? new Date(status.flowLastUpdate).toLocaleString('en-US', {
                                    year: 'numeric',
                                    month: 'numeric',
                                    day: 'numeric',
                                    hour: 'numeric',
                                    minute: 'numeric',
                                    hour12: true
                                }) : 'N/A'}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Status -->
                        <div class="property-card bg-gradient-to-br from-blue-50 to-blue-100 p-2.5 rounded-lg ${statusBorderClass} ${statusParentStyleClass}">
                            <div class="flex items-center mb-1">
                                <svg class="w-3 h-3 text-blue-600 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"> {/* Default: text-blue-600 */}
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            <p class="text-blue-800 font-medium text-xs">Status</p> 
                            </div>
                            <p class="text-sm font-bold leading-tight ${
                                status.isGreat ? 'text-emerald-600' :
                                status.isWarning ? 'text-yellow-600' :
                                'text-blue-900'
                            }">
                                ${ status.isGreat ? 'Great' : status.isWarning ? 'Warning' : status.isCritical ? 'Critical' : 'Not Available' }
                            </p>
                            <div class="text-[10px] mt-0.5">
                                ${(() => {
                                    const issues = [];
                                    if (!status.isConnected) {
                                        issues.push('Disconnected');
                                    }
                                    if (status.cloudTemp > status.tempThresholdMax) {
                                        issues.push('Temperature High');
                                    }
                                    if (status.timeSinceFlowHours >= status.noFlowCriticalTime) {
                                        issues.push('No Flow');
                                    }
                                    return issues.length > 0 ? /* Issue list is already red or green */
                                        `<div class="flex items-center text-red-600">
                                            <svg class="w-2.5 h-2.5 mr-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"> {/* text-red-600 handled by parent */}
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                            </svg>
                                            ${issues.join(', ')}
                                        </div>` :
                                        status.isGreat ? '<div class="flex items-center text-emerald-600"><svg class="w-2.5 h-2.5 mr-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>All Systems Normal</div>' : '';
                                })()}
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-between items-center border-t pt-2">
                        <button 
                            onclick="showDeviceSettings(${index})"
                            class="inline-flex items-center px-2 py-1 bg-gray-600 text-white text-xs font-medium rounded-lg hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-gray-500 transition-colors shadow-sm"
                        >
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                            <span>Settings</span>
                        </button>
                        <button 
                            onclick="showDeviceDetails(${index})"
                            class="inline-flex items-center px-2 py-1 bg-blue-600 text-white text-xs font-medium rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-blue-500 transition-colors shadow-sm"
                        >
                            <span>More Details</span>
                            <svg class="w-3 h-3 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                            </svg>
                        </button>
                    </div>
                </div>
                `;
            }).join('');

            // Start timers for all time-since-flow elements
            document.querySelectorAll('.time-since-flow').forEach(element => {
                const startTime = element.dataset.startTime;
                if (startTime) {
                    logToConsole(`Starting flow timer for device ${element.dataset.deviceId} with start time ${startTime}`);
                }
                updateTimeSinceFlow(element, startTime);
            });

            // Add the modal container if it doesn't exist
            if (!document.getElementById('device-modal')) {
                const modalContainer = document.createElement('div');
                modalContainer.id = 'device-modal';
                modalContainer.className = 'fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50';
                modalContainer.style.position = 'fixed';
                modalContainer.style.top = '0';
                modalContainer.style.left = '0';
                modalContainer.style.right = '0';
                modalContainer.style.bottom = '0';
                modalContainer.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl p-6 m-4 max-w-4xl w-full max-h-[90vh] overflow-y-auto relative">
                        <div class="flex justify-between items-start mb-4">
                            <h2 id="modal-title" class="text-2xl font-bold text-gray-800"></h2>
                            <button onclick="hideDeviceDetails()" class="text-gray-500 hover:text-gray-700">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div id="modal-content"></div>
                    </div>
                `;
                document.body.appendChild(modalContainer);
            }

            // Add the active devices modal if it doesn't exist
            if (!document.getElementById('active-devices-modal')) {
                const activeDevicesModal = document.createElement('div');
                activeDevicesModal.id = 'active-devices-modal';
                activeDevicesModal.className = 'fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50';
                activeDevicesModal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl p-6 m-4 max-w-xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-gray-800">Active Devices</h2>
                            <button onclick="hideActiveDevices()" class="text-gray-500 hover:text-gray-700">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div id="active-devices-list" class="space-y-2"></div>
                    </div>
                `;
                document.body.appendChild(activeDevicesModal);
            }

            // Add the connected devices modal if it doesn't exist
            if (!document.getElementById('connected-devices-modal')) {
                const connectedDevicesModal = document.createElement('div');
                connectedDevicesModal.id = 'connected-devices-modal';
                connectedDevicesModal.className = 'fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50';
                connectedDevicesModal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl p-6 m-4 max-w-xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-gray-800">Connected Devices</h2>
                            <button onclick="hideConnectedDevices()" class="text-gray-500 hover:text-gray-700">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div id="connected-devices-list" class="space-y-2"></div>
                    </div>
                `;
                document.body.appendChild(connectedDevicesModal);
            }

            // Add the great devices modal if it doesn't exist
            if (!document.getElementById('great-devices-modal')) {
                const greatDevicesModal = document.createElement('div');
                greatDevicesModal.id = 'great-devices-modal';
                greatDevicesModal.className = 'fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50';
                greatDevicesModal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl p-6 m-4 max-w-xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-gray-800">Devices in Great Condition</h2>
                            <button onclick="hideGreatDevices()" class="text-gray-500 hover:text-gray-700">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div id="great-devices-list" class="space-y-2"></div>
                    </div>
                `;
                document.body.appendChild(greatDevicesModal);
            }

            // Add the warning devices modal if it doesn't exist
            if (!document.getElementById('warning-devices-modal')) {
                const warningDevicesModal = document.createElement('div');
                warningDevicesModal.id = 'warning-devices-modal';
                warningDevicesModal.className = 'fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50';
                warningDevicesModal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl p-6 m-4 max-w-xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-gray-800">Devices with Warnings</h2>
                            <button onclick="hideWarningDevices()" class="text-gray-500 hover:text-gray-700">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div id="warning-devices-list" class="space-y-2"></div>
                    </div>
                `;
                document.body.appendChild(warningDevicesModal);
            }

            // Add the critical devices modal if it doesn't exist
            if (!document.getElementById('critical-devices-modal')) {
                const criticalDevicesModal = document.createElement('div');
                criticalDevicesModal.id = 'critical-devices-modal';
                criticalDevicesModal.className = 'fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50';
                criticalDevicesModal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl p-6 m-4 max-w-xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-gray-800">Devices in Critical State</h2>
                            <button onclick="hideCriticalDevices()" class="text-gray-500 hover:text-gray-700">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div id="critical-devices-list" class="space-y-2"></div>
                    </div>
                `;
                document.body.appendChild(criticalDevicesModal);
            }
        }

        function showDeviceDetails(deviceIndex) {
            const device = window.lastDevicesData[deviceIndex];
            const modal = document.getElementById('device-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalContent = document.getElementById('modal-content');
            const status = calculateDeviceStatus(device);

            modalTitle.textContent = device.thing?.properties?.find(p => p.name === 'devicename')?.last_value || device.name || 'Device Details';
            
            // Generate the detailed view with improved layout
            modalContent.innerHTML = `
                <div class="space-y-6">
                    <!-- Device Info -->
                    <div class="bg-white rounded-lg shadow-lg border border-gray-100 p-4 mb-6">
                        <div class="flex items-center space-x-2 mb-4">
                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" />
                            </svg>
                            <h3 class="text-xl font-semibold text-gray-900">Device Information</h3>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <!-- Basic Info Column -->
                            <div class="space-y-3">
                                <div>
                                    <p class="text-xs font-medium text-gray-500">Device Name</p>
                                    <p class="text-sm font-semibold text-gray-900">${device.thing?.properties?.find(p => p.name === 'devicename')?.last_value || `Device ${device.name.replace(/[^0-9]/g, '')}`}</p>
                                </div>
                                <div>
                                    <p class="text-xs font-medium text-gray-500">Location</p>
                                    <p class="text-sm font-semibold text-gray-900">${device.thing?.properties?.find(p => p.name === 'location')?.last_value || 'Location not set'}</p>
                                </div>
                                <div>
                                    <p class="text-xs font-medium text-gray-500">Ice Machine PN/SN</p>
                                    <p class="text-sm font-semibold text-gray-900">${device.thing?.properties?.find(p => p.name === 'Icemachine_PN_SN')?.last_value || 'N/A'}</p>
                                    <p class="text-xs text-gray-500 mt-1 italic">Track which ice machine this FreezeSense device is currently installed in</p>
                                </div>
                            </div>

                            <!-- Status Column -->
                            <div class="space-y-3">
                                <div>
                                    <p class="text-xs font-medium text-gray-500">Connection Status</p>
                                    <div class="flex items-center mt-1">
                                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${
                                            status.isConnected ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                                        }">
                                            <span class="w-2 h-2 mr-1 rounded-full ${
                                                status.isConnected ? 'bg-green-400' : 'bg-red-400'
                                            }"></span>
                                            ${status.isConnected ? 'Connected' : 'Disconnected'}
                                        </span>
                                    </div>
                                    ${!status.isConnected && status.lastConnectedTime ? `
                                        <p class="text-xs text-red-600 mt-1">Last seen: ${new Date(status.lastConnectedTime).toLocaleString('en-US', {
                                            dateStyle: 'medium',
                                            timeStyle: 'short'
                                        })}</p>
                                    ` : ''}
                                </div>
                                <div>
                                    <p class="text-xs font-medium text-gray-500">Device Status</p>
                                    <span class="inline-flex items-center px-2 py-0.5 mt-1 rounded-full text-xs font-medium ${
                                        status.isGreat ? 'bg-emerald-100 text-emerald-800' :
                                        status.isWarning ? 'bg-yellow-100 text-yellow-800' :
                                        'bg-red-100 text-red-800'
                                    }">
                                        ${status.isGreat ? 'Great' : status.isWarning ? 'Warning' : 'Critical'}
                                    </span>
                                </div>
                                <div>
                                    <p class="text-xs font-medium text-gray-500">Device ID</p>
                                    <p class="text-xs font-mono bg-gray-50 px-2 py-1 rounded border border-gray-200 select-all">${device.id}</p>
                                </div>
                            </div>

                            <!-- Maintenance Column -->
                            <div class="col-span-2 md:col-span-1 space-y-3">
                                <div class="bg-gray-50 p-3 rounded-lg">
                                    <p class="text-xs font-medium text-gray-500">Last Maintenance</p>
                                    <p class="text-sm font-semibold text-gray-900 mt-1">${device.thing?.properties?.find(p => p.name === 'Last_Maintenance')?.last_value || 'Not recorded'}</p>
                                    ${(() => {
                                        const lastMaintenance = device.thing?.properties?.find(p => p.name === 'Last_Maintenance')?.last_value;
                                        if (lastMaintenance) {
                                            const [month, day, year] = lastMaintenance.split('/').map(num => parseInt(num));
                                            const maintenanceDate = new Date(year, month - 1, day); // month is 0-based in JS
                                            const now = new Date();
                                            
                                            // Calculate total months difference
                                            const monthsDiff = (now.getFullYear() - maintenanceDate.getFullYear()) * 12 + 
                                                                 (now.getMonth() - maintenanceDate.getMonth());
                                            
                                            // Calculate remaining days
                                            const tempDate = new Date(now.getFullYear(), now.getMonth(), maintenanceDate.getDate());
                                            const daysDiff = Math.floor((now - tempDate) / (1000 * 60 * 60 * 24));
                                            
                                            return `
                                                <div class="flex items-center mt-2 ${monthsDiff >= 6 ? 'bg-red-50 text-red-700 p-1.5 rounded' : ''}">
                                                    ${monthsDiff >= 6 ? '<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>' : ''}
                                                    <span class="text-xs ${monthsDiff >= 6 ? 'font-medium' : 'text-gray-600'}">
                                                        ${monthsDiff > 0 ? `${monthsDiff} month${monthsDiff > 1 ? 's' : ''}` : ''}
                                                        ${daysDiff > 0 ? `${monthsDiff > 0 ? ' and ' : ''}${daysDiff} day${daysDiff > 1 ? 's' : ''}` : ''}
                                                        since last maintenance
                                                        ${monthsDiff >= 6 ? ' (Overdue - Recommended every 6 months)' : ''}
                                                    </span>
                                                </div>
                                                ${monthsDiff < 6 ? `
                                                <div class="text-xs text-gray-600 mt-1">
                                                    <span class="italic">Recommended maintenance period: 6 months</span>
                                                </div>
                                                ` : ''}
                                            `;
                                        }
                                        return `
                                            <div class="text-xs text-gray-600 mt-1">
                                                <span class="italic">Recommended maintenance period: 6 months</span>
                                            </div>
                                        `;
                                    })()}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recommendations Section -->
                    <div class="bg-white rounded-lg shadow-lg border border-gray-100 p-4 mb-6">
                        <div class="flex items-center space-x-2 mb-4">
                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                            </svg>
                            <h3 class="text-xl font-semibold text-gray-900">Recommendations</h3>
                        </div>
                        <div class="space-y-3">
                            ${(() => {
                                const recommendations = [];
                                
                                // Connection Status Recommendations
                                if (!status.isConnected) {
                                    recommendations.push({
                                        type: 'error',
                                        title: 'Connection Lost',
                                        message: 'Device is currently offline. Click below to view troubleshooting steps:',
                                        action: `<div class="space-y-2 mt-1">
                                            <details class="group bg-red-50 rounded-lg">
                                                <summary class="flex items-center justify-between p-2 font-medium cursor-pointer list-none hover:bg-red-100 rounded-lg transition-colors">
                                                    <div class="flex items-center space-x-2">
                                                        <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-red-100 text-red-800 text-xs font-bold">1</span>
                                                        <span>Verify Ice Machine Operation</span>
                                                    </div>
                                                    <svg class="w-5 h-5 text-red-700 transform group-open:rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                                    </svg>
                                                </summary>
                                                <div class="p-2 pt-0 text-red-700">
                                                    <ul class="mt-0.5 ml-4 list-disc text-sm space-y-0.5">
                                                        <li>Check if the ice machine is powered on and running</li>
                                                        <li>If the machine is off, turn it on and wait for it to start</li>
                                                    </ul>
                                                </div>
                                            </details>

                                            <details class="group bg-red-50 rounded-lg">
                                                <summary class="flex items-center justify-between p-2 font-medium cursor-pointer list-none hover:bg-red-100 rounded-lg transition-colors">
                                                    <div class="flex items-center space-x-2">
                                                        <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-red-100 text-red-800 text-xs font-bold">2</span>
                                                        <span>Check Power Supply</span>
                                                    </div>
                                                    <svg class="w-5 h-5 text-red-700 transform group-open:rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                                    </svg>
                                                </summary>
                                                <div class="p-2 pt-0 text-red-700">
                                                    <ul class="mt-0.5 ml-4 list-disc text-sm space-y-0.5">
                                                        <li>Ensure the FreezeSense device is receiving power:
                                                            <ul class="ml-4 mt-0.5 list-circle space-y-0.5">
                                                                <li>Inspect the power cable to confirm it is securely connected</li>
                                                                <li>Check the wall socket where the power adapter is plugged in</li>
                                                                <li>Look for the LED indicator on the power supply—it should be lit</li>
                                                                <li>Try plugging the power supply into a different socket if needed</li>
                                                            </ul>
                                                        </li>
                                                    </ul>
                                                </div>
                                            </details>

                                            <details class="group bg-red-50 rounded-lg">
                                                <summary class="flex items-center justify-between p-2 font-medium cursor-pointer list-none hover:bg-red-100 rounded-lg transition-colors">
                                                    <div class="flex items-center space-x-2">
                                                        <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-red-100 text-red-800 text-xs font-bold">3</span>
                                                        <span>Verify WiFi Connection</span>
                                                    </div>
                                                    <svg class="w-5 h-5 text-red-700 transform group-open:rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                                    </svg>
                                                </summary>
                                                <div class="p-2 pt-0 text-red-700">
                                                    <ul class="mt-0.5 ml-4 list-disc text-sm space-y-0.5">
                                                        <li>Confirm network connectivity:
                                                            <ul class="ml-4 mt-0.5 list-circle space-y-0.5">
                                                                <li>Check if other devices on the same WiFi network are working</li>
                                                                <li>If WiFi is down, restart the router and wait for network recovery</li>
                                                                <li>Ensure the device is within range of the WiFi router</li>
                                                            </ul>
                                                        </li>
                                                    </ul>
                                                </div>
                                            </details>

                                            <details class="group bg-red-50 rounded-lg">
                                                <summary class="flex items-center justify-between p-2 font-medium cursor-pointer list-none hover:bg-red-100 rounded-lg transition-colors">
                                                    <div class="flex items-center space-x-2">
                                                        <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-red-100 text-red-800 text-xs font-bold">4</span>
                                                        <span>Restart Device</span>
                                                    </div>
                                                    <svg class="w-5 h-5 text-red-700 transform group-open:rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                                    </svg>
                                                </summary>
                                                <div class="p-2 pt-0 text-red-700">
                                                    <ul class="mt-0.5 ml-4 list-disc text-sm space-y-0.5">
                                                        <li>Perform a manual reboot:
                                                            <ul class="ml-4 mt-0.5 list-circle space-y-0.5">
                                                                <li>Unplug the power supply from the wall socket</li>
                                                                <li>Wait for 10 seconds</li>
                                                                <li>Plug the power supply back in</li>
                                                                <li>Allow the device to restart and monitor reconnection</li>
                                                            </ul>
                                                        </li>
                                                    </ul>
                                                </div>
                                            </details>

                                            <details class="group bg-red-50 rounded-lg">
                                                <summary class="flex items-center justify-between p-2 font-medium cursor-pointer list-none hover:bg-red-100 rounded-lg transition-colors">
                                                    <div class="flex items-center space-x-2">
                                                        <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-red-100 text-red-800 text-xs font-bold">5</span>
                                                        <span>Contact Support</span>
                                                    </div>
                                                    <svg class="w-5 h-5 text-red-700 transform group-open:rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                                    </svg>
                                                </summary>
                                                <div class="p-2 pt-0 text-red-700">
                                                    <ul class="mt-0.5 ml-4 list-disc text-sm space-y-0.5">
                                                        <li>If all previous steps fail:
                                                            <ul class="ml-4 mt-0.5 list-circle space-y-0.5">
                                                                <li>Support is for FreezeSense device issues only</li>
                                                                <li>For ice machine issues, refer to machine troubleshooting guide</li>
                                                            </ul>
                                                        </li>
                                                        <li class="mt-0.5">Contact your maintenance team</li>
                                                    </ul>
                                                </div>
                                            </details>
                                        </div>`
                                    });
                                }

                                // Temperature Recommendations
                                if (status.cloudTemp > status.tempThresholdMax) {
                                    recommendations.push({
                                        type: 'warning',
                                        title: 'High Temperature Detected',
                                        message: 'High temperature likely means there is no ice at the sensor level. Follow these steps in order:',
                                        action: `<div class="space-y-2 mt-1">
                                            <details class="group bg-yellow-50 rounded-lg">
                                                <summary class="flex items-center justify-between p-2 font-medium cursor-pointer list-none hover:bg-yellow-100 rounded-lg transition-colors">
                                                    <div class="flex items-center space-x-2">
                                                        <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-yellow-100 text-yellow-800 text-xs font-bold">1</span>
                                                        <span>Check Ice Usage</span>
                                                    </div>
                                                    <svg class="w-5 h-5 text-yellow-700 transform group-open:rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                                    </svg>
                                                </summary>
                                                <div class="p-2 pt-0 text-yellow-700">
                                                    <div class="space-y-2">
                                                        <p class="text-sm">Has ice been used at a higher rate than usual?</p>
                                                        <ul class="mt-0.5 ml-4 list-disc text-sm space-y-0.5">
                                                            <li>If yes, the machine may not have had enough time to produce and replenish ice at the sensor level</li>
                                                            <li>Allow the ice machine to continue running and monitor if the ice level recovers</li>
                                                            <li>Check usage patterns to determine if demand has recently increased beyond the machine's capacity</li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </details>

                                            <details class="group bg-yellow-50 rounded-lg">
                                                <summary class="flex items-center justify-between p-2 font-medium cursor-pointer list-none hover:bg-yellow-100 rounded-lg transition-colors">
                                                    <div class="flex items-center space-x-2">
                                                        <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-yellow-100 text-yellow-800 text-xs font-bold">2</span>
                                                        <span>Inspect Ice Levels Manually</span>
                                                    </div>
                                                    <svg class="w-5 h-5 text-yellow-700 transform group-open:rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                                    </svg>
                                                </summary>
                                                <div class="p-2 pt-0 text-yellow-700">
                                                    <ul class="mt-0.5 ml-4 list-disc text-sm space-y-0.5">
                                                        <li>Open the ice machine bin and check if there is ice at the sensor level</li>
                                                        <li>If there is no ice at the sensor level, proceed to Step 3</li>
                                                        <li>If there is ice at the sensor level, but the system still detects high temperature, proceed to Step 4</li>
                                                    </ul>
                                                </div>
                                            </details>

                                            <details class="group bg-yellow-50 rounded-lg">
                                                <summary class="flex items-center justify-between p-2 font-medium cursor-pointer list-none hover:bg-yellow-100 rounded-lg transition-colors">
                                                    <div class="flex items-center space-x-2">
                                                        <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-yellow-100 text-yellow-800 text-xs font-bold">3</span>
                                                        <span>If No Ice is Present</span>
                                                    </div>
                                                    <svg class="w-5 h-5 text-yellow-700 transform group-open:rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                                    </svg>
                                                </summary>
                                                <div class="p-2 pt-0 text-yellow-700">
                                                    <div class="space-y-2">
                                                        <div>
                                                            <p class="font-medium">🔹 Machine Operation:</p>
                                                            <ul class="mt-0.5 ml-4 list-disc text-sm space-y-0.5">
                                                                <li>Verify the ice machine is powered on and operating</li>
                                                                <li>If the machine is off, turn it on and allow it to cycle</li>
                                                                <li>Check if the ice machine is producing ice</li>
                                                                <li>Listen for the sound of water filling and freezing</li>
                                                            </ul>
                                                        </div>
                                                        <div>
                                                            <p class="font-medium">🔹 Environmental Checks:</p>
                                                            <ul class="mt-0.5 ml-4 list-disc text-sm space-y-0.5">
                                                                <li>Ensure proper airflow and ventilation</li>
                                                                <li>Check for blocked vents that could cause overheating</li>
                                                                <li>Inspect the water supply and pressure</li>
                                                                <li>Look for clogged filters that might restrict water flow</li>
                                                            </ul>
                                                        </div>
                                                        <div>
                                                            <p class="font-medium">🔹 Monitor Progress:</p>
                                                            <ul class="mt-0.5 ml-4 list-disc text-sm space-y-0.5">
                                                                <li>Watch the next production cycle</li>
                                                                <li>If ice production resumes, the issue may have been temporary</li>
                                                                <li>If ice is still not being produced, maintenance may be required</li>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </div>
                                            </details>

                                            <details class="group bg-yellow-50 rounded-lg">
                                                <summary class="flex items-center justify-between p-2 font-medium cursor-pointer list-none hover:bg-yellow-100 rounded-lg transition-colors">
                                                    <div class="flex items-center space-x-2">
                                                        <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-yellow-100 text-yellow-800 text-xs font-bold">4</span>
                                                        <span>If Ice is Present but Temperature High</span>
                                                    </div>
                                                    <svg class="w-5 h-5 text-yellow-700 transform group-open:rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                                    </svg>
                                                </summary>
                                                <div class="p-2 pt-0 text-yellow-700">
                                                    <div class="space-y-2">
                                                        <p class="text-sm">This suggests a false high-temperature reading due to an incorrect threshold setting.</p>
                                                        <div>
                                                            <p class="font-medium">🔹 Adjust Temperature Threshold:</p>
                                                            <ul class="mt-0.5 ml-4 list-disc text-sm space-y-0.5">
                                                                <li>Navigate to the FreezeSense Properties Section in the system settings</li>
                                                                <li>Locate the Temperature Threshold setting</li>
                                                                <li>Increase the threshold slightly to reduce false alerts</li>
                                                                <li>Save the settings and monitor to ensure proper functionality</li>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </div>
                                            </details>

                                            <details class="group bg-yellow-50 rounded-lg">
                                                <summary class="flex items-center justify-between p-2 font-medium cursor-pointer list-none hover:bg-yellow-100 rounded-lg transition-colors">
                                                    <div class="flex items-center space-x-2">
                                                        <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-yellow-100 text-yellow-800 text-xs font-bold">5</span>
                                                        <span>If Issue Persists</span>
                                                    </div>
                                                    <svg class="w-5 h-5 text-yellow-700 transform group-open:rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                                    </svg>
                                                </summary>
                                                <div class="p-2 pt-0 text-yellow-700">
                                                    <div class="space-y-2">
                                                        <div>
                                                            <p class="font-medium">🔹 Full Machine Inspection:</p>
                                                            <ul class="mt-0.5 ml-4 list-disc text-sm space-y-0.5">
                                                                <li>Clean the machine thoroughly, including:</li>
                                                                <ul class="ml-4 list-circle">
                                                                    <li>Sensors and vents</li>
                                                                    <li>Ice bin and production area</li>
                                                                    <li>Ultrasonic sensor position and clearance</li>
                                                                </ul>
                                                            </ul>
                                                        </div>
                                                        <div>
                                                            <p class="font-medium">🔹 Check for Mechanical Issues:</p>
                                                            <ul class="mt-0.5 ml-4 list-disc text-sm space-y-0.5">
                                                                <li>Inspect for problems with:</li>
                                                                <ul class="ml-4 list-circle">
                                                                    <li>Compressor operation</li>
                                                                    <li>Thermostat function</li>
                                                                    <li>Internal components</li>
                                                                </ul>
                                                            </ul>
                                                        </div>
                                                        <div>
                                                            <p class="font-medium">🔹 Next Steps:</p>
                                                            <ul class="mt-0.5 ml-4 list-disc text-sm space-y-0.5">
                                                                <li>If troubleshooting doesn't resolve the issue:</li>
                                                                <ul class="ml-4 list-circle">
                                                                    <li>Schedule a maintenance inspection</li>
                                                                    <li>Contact your maintenance team</li>
                                                                </ul>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </div>
                                            </details>
                                        </div>`
                                    });
                                }

                                // Maintenance Recommendations
                                const lastMaintenance = device.thing?.properties?.find(p => p.name === 'Last_Maintenance')?.last_value;
                                if (lastMaintenance) {
                                    const maintenanceDate = new Date(lastMaintenance);
                                    const now = new Date();
                                    const diffDays = Math.ceil(Math.abs(now - maintenanceDate) / (1000 * 60 * 60 * 24));
                                    
                                    if (diffDays > 180) {  // 180 days = 6 months
                                        recommendations.push({
                                            type: 'warning',
                                            title: 'Maintenance Overdue',
                                            message: `Regular maintenance (recommended every 6 months) is overdue by ${(diffDays - 180)} days.`,
                                            action: 'Schedule maintenance service as soon as possible to ensure optimal performance.'
                                        });
                                    } else if (diffDays > 150) {  // Start warning 30 days before 6-month mark
                                        recommendations.push({
                                            type: 'info',
                                            title: 'Maintenance Due Soon',
                                            message: `Regular 6-month maintenance will be due in ${(180 - diffDays)} days.`,
                                            action: 'Plan to schedule maintenance service in the coming weeks.'
                                        });
                                    }
                                } else {
                                    recommendations.push({
                                        type: 'info',
                                        title: 'Maintenance Status Unknown',
                                        message: 'No maintenance history found. Regular maintenance is recommended every 6 months.',
                                        action: 'Please schedule initial maintenance service.'
                                    });
                                }

                                if (recommendations.length === 0 && status.isGreat) {
                                    recommendations.push({
                                        type: 'success',
                                        title: 'System Operating Normally',
                                        message: 'All parameters are within normal ranges.',
                                        action: 'Continue regular monitoring and maintenance schedule.'
                                    });
                                }

                                // No Flow Recommendations
                                if (status.timeSinceFlowHours >= status.noFlowCriticalTime) {
                                    recommendations.push({
                                        type: 'warning',
                                        title: 'No Flow Detected',
                                        message: 'No water flow has been detected for an extended period. Follow these steps to troubleshoot:',
                                        action: `<div class="space-y-2 mt-1">
                                            <details class="group bg-yellow-50 rounded-lg">
                                                <summary class="flex items-center justify-between p-2 font-medium cursor-pointer list-none hover:bg-yellow-100 rounded-lg transition-colors">
                                                    <div class="flex items-center space-x-2">
                                                        <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-yellow-100 text-yellow-800 text-xs font-bold">1</span>
                                                        <span>Check Water Supply</span>
                                                    </div>
                                                    <svg class="w-5 h-5 text-yellow-700 transform group-open:rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                                    </svg>
                                                </summary>
                                                <div class="p-2 pt-0 text-yellow-700">
                                                    <div class="space-y-2">
                                                        <div>
                                                            <p class="font-medium">🔹 Verify Water Source:</p>
                                                            <ul class="mt-0.5 ml-4 list-disc text-sm space-y-0.5">
                                                                <li>Check if the main water supply valve is open</li>
                                                                <li>Verify water pressure is adequate</li>
                                                                <li>Look for any visible leaks in supply lines</li>
                                                                <li>Ensure no maintenance work is affecting water supply</li>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </div>
                                            </details>

                                            <details class="group bg-yellow-50 rounded-lg">
                                                <summary class="flex items-center justify-between p-2 font-medium cursor-pointer list-none hover:bg-yellow-100 rounded-lg transition-colors">
                                                    <div class="flex items-center space-x-2">
                                                        <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-yellow-100 text-yellow-800 text-xs font-bold">2</span>
                                                        <span>Inspect for Blockages</span>
                                                    </div>
                                                    <svg class="w-5 h-5 text-yellow-700 transform group-open:rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                                    </svg>
                                                </summary>
                                                <div class="p-2 pt-0 text-yellow-700">
                                                    <div class="space-y-2">
                                                        <div>
                                                            <p class="font-medium">🔹 Check Common Blockage Points:</p>
                                                            <ul class="mt-0.5 ml-4 list-disc text-sm space-y-0.5">
                                                                <li>Inspect and clean the water filter if necessary</li>
                                                                <li>Check for kinked or bent water lines</li>
                                                                <li>Look for mineral buildup in water lines</li>
                                                                <li>Verify the water inlet valve is functioning</li>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </div>
                                            </details>

                                            <details class="group bg-yellow-50 rounded-lg">
                                                <summary class="flex items-center justify-between p-2 font-medium cursor-pointer list-none hover:bg-yellow-100 rounded-lg transition-colors">
                                                    <div class="flex items-center space-x-2">
                                                        <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-yellow-100 text-yellow-800 text-xs font-bold">3</span>
                                                        <span>Test Water Flow</span>
                                                    </div>
                                                    <svg class="w-5 h-5 text-yellow-700 transform group-open:rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                                    </svg>
                                                </summary>
                                                <div class="p-2 pt-0 text-yellow-700">
                                                    <div class="space-y-2">
                                                        <div>
                                                            <p class="font-medium">🔹 Flow Testing Steps:</p>
                                                            <ul class="mt-0.5 ml-4 list-disc text-sm space-y-0.5">
                                                                <li>Initiate a manual water fill cycle if possible</li>
                                                                <li>Listen for water flow sounds</li>
                                                                <li>Check if water is reaching the ice making unit</li>
                                                                <li>Measure water pressure if a gauge is available</li>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </div>
                                            </details>

                                            <details class="group bg-yellow-50 rounded-lg">
                                                <summary class="flex items-center justify-between p-2 font-medium cursor-pointer list-none hover:bg-yellow-100 rounded-lg transition-colors">
                                                    <div class="flex items-center space-x-2">
                                                        <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-yellow-100 text-yellow-800 text-xs font-bold">4</span>
                                                        <span>Reset and Monitor</span>
                                                    </div>
                                                    <svg class="w-5 h-5 text-yellow-700 transform group-open:rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                                    </svg>
                                                </summary>
                                                <div class="p-2 pt-0 text-yellow-700">
                                                    <div class="space-y-2">
                                                        <div>
                                                            <p class="font-medium">🔹 Reset Procedure:</p>
                                                            <ul class="mt-0.5 ml-4 list-disc text-sm space-y-0.5">
                                                                <li>Power cycle the ice machine:</li>
                                                                <ul class="ml-4 list-circle">
                                                                    <li>Turn off the machine</li>
                                                                    <li>Wait for 5 minutes</li>
                                                                    <li>Turn the machine back on</li>
                                                                </ul>
                                                                <li>Monitor for normal operation</li>
                                                                <li>Check if water flow resumes</li>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </div>
                                            </details>

                                            <details class="group bg-yellow-50 rounded-lg">
                                                <summary class="flex items-center justify-between p-2 font-medium cursor-pointer list-none hover:bg-yellow-100 rounded-lg transition-colors">
                                                    <div class="flex items-center space-x-2">
                                                        <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-yellow-100 text-yellow-800 text-xs font-bold">5</span>
                                                        <span>If Issue Persists</span>
                                                    </div>
                                                    <svg class="w-5 h-5 text-yellow-700 transform group-open:rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                                    </svg>
                                                </summary>
                                                <div class="p-2 pt-0 text-yellow-700">
                                                    <div class="space-y-2">
                                                        <div>
                                                            <p class="font-medium">🔹 Next Steps:</p>
                                                            <ul class="mt-0.5 ml-4 list-disc text-sm space-y-0.5">
                                                                <li>If all troubleshooting steps fail:</li>
                                                                <ul class="ml-4 list-circle">
                                                                    <li>Contact your maintenance team</li>
                                                                    <li>Schedule a professional inspection</li>
                                                                    <li>Document all steps taken for maintenance reference</li>
                                                                </ul>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </div>
                                            </details>
                                        </div>`
                                    });
                                }

                                return recommendations.length > 0 ? recommendations.map(rec => `
                                    <div class="flex items-start p-3 rounded-lg ${
                                        rec.type === 'error' ? 'bg-red-50 border border-red-200' :
                                        rec.type === 'warning' ? 'bg-yellow-50 border border-yellow-200' :
                                        rec.type === 'info' ? 'bg-blue-50 border border-blue-200' :
                                        'bg-emerald-50 border border-emerald-200'
                                    }">
                                        <div class="flex-shrink-0">
                                            <svg class="w-5 h-5 ${
                                                rec.type === 'error' ? 'text-red-600' :
                                                rec.type === 'warning' ? 'text-yellow-600' :
                                                rec.type === 'info' ? 'text-blue-600' :
                                                'text-emerald-600'
                                            }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                ${rec.type === 'error' ? 
                                                    '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />' :
                                                    rec.type === 'warning' ?
                                                    '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />' :
                                                    rec.type === 'info' ?
                                                    '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />' :
                                                    '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />'
                                                }
                                            </svg>
                                        </div>
                                        <div class="ml-3 flex-1">
                                            <h5 class="text-sm font-medium ${
                                                rec.type === 'error' ? 'text-red-800' :
                                                rec.type === 'warning' ? 'text-yellow-800' :
                                                rec.type === 'info' ? 'text-blue-800' :
                                                'text-emerald-800'
                                            }">${rec.title}</h5>
                                            <p class="mt-1 text-xs ${
                                                rec.type === 'error' ? 'text-red-700' :
                                                rec.type === 'warning' ? 'text-yellow-700' :
                                                rec.type === 'info' ? 'text-blue-700' :
                                                'text-emerald-700'
                                            }">${rec.message}</p>
                                            <p class="mt-1 text-xs font-medium ${
                                                rec.type === 'error' ? 'text-red-900' :
                                                rec.type === 'warning' ? 'text-yellow-900' :
                                                rec.type === 'info' ? 'text-blue-900' :
                                                'text-emerald-900'
                                            }">Recommended Action: ${rec.action}</p>
                                        </div>
                                    </div>
                                `).join('') : '<p class="text-gray-500 text-sm">No recommendations at this time.</p>';
                            })()}
                        </div>
                    </div>

                    <!-- Time Series Graphs Section -->
                    <div class="bg-white rounded-lg shadow-lg border border-gray-100 p-4 mb-6">
                        <div class="flex items-center space-x-2 mb-4">
                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                            </svg>
                            <h3 class="text-xl font-semibold text-gray-900">Time Series Data</h3>
                        </div>
                        
                        <!-- Temperature & Ice Level Graph -->
                        <div class="mb-6">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="text-sm font-medium text-gray-700">Temperature & Ice Level</h4>
                                <div class="flex items-center space-x-4 mb-4">
                                <div class="time-range-selector" id="temp-time-range">
                                        <button class="time-range-button active" data-days="0" onclick="toggleTempGraph(window.currentDeviceIndex || 0, 0)">Today</button>
                                        <button class="time-range-button" data-days="1" onclick="toggleTempGraph(window.currentDeviceIndex || 0, 1)">Yesterday</button>
                                        <button class="time-range-button" data-days="2" onclick="toggleTempGraph(window.currentDeviceIndex || 0, 2)">2 Days Ago</button>
                                    </div>
                                    <div class="flex items-center space-x-4">
                                        <label class="flex items-center space-x-2 cursor-pointer">
                                            <input 
                                                type="checkbox" 
                                                id="temp-line-toggle" 
                                                class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500"
                                                onclick="toggleTempLine()"
                                                checked
                                            >
                                            <span class="text-sm text-gray-700">Show Temperature</span>
                                        </label>
                                        <label class="flex items-center space-x-2 cursor-pointer">
                                            <input 
                                                type="checkbox" 
                                                id="ice-level-toggle" 
                                                class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500"
                                                onclick="toggleIceLevel()"
                                                checked
                                            >
                                            <span class="text-sm text-gray-700">Show Ice Level</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <!-- Add Statistics Summary Box -->
                            <div id="tempStats" class="grid grid-cols-1 gap-4 mb-4 p-4 bg-gray-50 rounded-lg">
                                <!-- Info Message -->
                                <div class="col-span-full mb-2">
                                    <p class="text-xs text-gray-600 italic">
                                        Note: Statistics are only available when a single time period is selected.
                                        Multi-day selections will disable these statistics.
                                    </p>
                                </div>
                                
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="stat-box">
                                        <h5 class="text-xs font-medium text-gray-500">
                                            Daily Range
                                            <span class="ml-1 cursor-help group relative">
                                                <svg class="w-3 h-3 inline text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                                </svg>
                                                <span class="hidden group-hover:block absolute bottom-full left-0 w-48 p-2 bg-gray-800 text-xs text-white rounded shadow-lg mb-2">
                                                    Shows min-max temperature range from 12:01 AM to 11:59 PM. Calculated using available data for the selected day.
                                                </span>
                                            </span>
                                        </h5>
                                    <p class="text-sm font-bold text-gray-900" id="tempRange">-</p>
                                </div>
                                <div class="stat-box">
                                        <h5 class="text-xs font-medium text-gray-500">Daily Average</h5>
                                    <p class="text-sm font-bold text-gray-900" id="tempAvg">-</p>
                                </div>
                                <div class="stat-box">
                                    <h5 class="text-xs font-medium text-gray-500">Std Deviation</h5>
                                    <p class="text-sm font-bold text-gray-900" id="tempStdDev">-</p>
                                </div>
                                <div class="stat-box">
                                    <h5 class="text-xs font-medium text-gray-500">Mode</h5>
                                    <p class="text-sm font-bold text-gray-900" id="tempMode">-</p>
                                    </div>
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas id="tempChart"></canvas>
                            </div>
                        </div>

                        <!-- Status Graph -->
                        <div class="mb-6">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="text-sm font-medium text-gray-700">Device Status</h4>
                                <div class="time-range-selector" id="status-time-range">
                                    <button class="time-range-button active" data-days="0" onclick="updateStatusGraph(${deviceIndex}, 0)">Today</button>
                                    <button class="time-range-button" data-days="1" onclick="updateStatusGraph(${deviceIndex}, 1)">Yesterday</button>
                                    <button class="time-range-button" data-days="2" onclick="updateStatusGraph(${deviceIndex}, 2)">2 Days Ago</button>
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas id="statusChart"></canvas>
                            </div>
                        </div>

                        <!-- Flow Time Graph -->
                        <div class="mb-6">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="text-sm font-medium text-gray-700">Flow Rate</h4>
                                <div class="time-range-selector" id="flow-time-range">
                                    <button class="time-range-button active" data-days="0" onclick="updateFlowGraph(${deviceIndex}, 0)">Today</button>
                                    <button class="time-range-button" data-days="1" onclick="updateFlowGraph(${deviceIndex}, 1)">Yesterday</button>
                                    <button class="time-range-button" data-days="2" onclick="updateFlowGraph(${deviceIndex}, 2)">2 Days Ago</button>
                                </div>
                            </div>
                            <!-- Add Flow Rate Statistics Summary Box -->
                            <div id="flowStats" class="grid grid-cols-1 gap-4 mb-4 p-4 bg-gray-50 rounded-lg">
                                <!-- Info Message -->
                                <div class="col-span-full mb-2">
                                    <p class="text-xs text-gray-600 italic">
                                        Note: Statistics are only available when a single time period is selected.
                                        Multi-day selections will disable these statistics.
                                    </p>
                                </div>
                                
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div class="stat-box">
                                        <h5 class="text-xs font-medium text-gray-500">
                                            Daily Range
                                            <span class="ml-1 cursor-help group relative">
                                                <svg class="w-3 h-3 inline text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                                </svg>
                                                <span class="hidden group-hover:block absolute bottom-full left-0 w-48 p-2 bg-gray-800 text-xs text-white rounded shadow-lg mb-2">
                                                    Shows min-max flow rate from 12:01 AM to 11:59 PM. Calculated using available data for the selected day.
                                                </span>
                                            </span>
                                        </h5>
                                        <p class="text-sm font-bold text-gray-900" id="flowRange">-</p>
                                    </div>
                                    <div class="stat-box">
                                        <h5 class="text-xs font-medium text-gray-500">Total Flow</h5>
                                        <p class="text-sm font-bold text-gray-900" id="flowTotal">-</p>
                                    </div>
                                    <div class="stat-box">
                                        <h5 class="text-xs font-medium text-gray-500">Std Deviation</h5>
                                        <p class="text-sm font-bold text-gray-900" id="flowStdDev">-</p>
                                    </div>
                                    <div class="stat-box">
                                        <h5 class="text-xs font-medium text-gray-500">Frequency</h5>
                                        <p class="text-sm font-bold text-gray-900" id="flowFrequency">-</p>
                                    </div>
                                    <div class="stat-box col-span-2 md:col-span-1">
                                        <h5 class="text-xs font-medium text-gray-500">Time Since Last Flow</h5>
                                        <p class="text-sm font-bold text-gray-900" id="timeSinceLastFlow">-</p>
                                    </div>
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas id="flowChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Status Controls -->
                    ${device.thing ? getStatusControls(device.id, device.thing.properties || []) : ''}

                    <!-- Properties Section -->
                    ${device.thing ? `
                        <div class="bg-white rounded-lg shadow-lg border border-gray-100 p-4">
                            <div class="flex items-center space-x-2 mb-6">
                                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                                </svg>
                                <h3 class="text-xl font-semibold text-gray-900">Properties</h3>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                ${device.thing?.properties ? 
                                    sortProperties(device.thing.properties).filter(property => 
                                        !['warning', 'critical'].includes(property.name)
                                    ).map(property => `
                                        <div class="property-card ${getPropertyBgColor(property.name)} rounded-xl shadow-sm border border-gray-100 overflow-hidden transition-all duration-200 hover:shadow-md">
                                            <div class="px-5 py-4">
                                                <div class="flex justify-between items-start mb-3">
                                                    <div class="space-y-1">
                                                        <div class="flex items-center space-x-2">
                                                            <h4 class="${getPropertyTextColor(property.name)} font-semibold">${
    property.name === 'Icemachine_PN_SN' ? 'Ice Machine Part Number and Serial Number' :
    property.name === 'cloudtemp' ? 'Temperature' :
    property.name === 'cloudflowrate' ? 'Flow Rate' :
    property.name === 'Last_Maintenance' ? 'Last Maintenance' :
    property.name === 'location' ? 'Ice Machine Location' :
    property.name === 'sensorplacement' ? 'Sensor Placement' :
    property.name === 'tempThresholdMax' ? 'Temperature Threshold' :
    property.name === 'noFlowCriticalTime' ? 'No Flow Critical Time' :
    property.name === 'notificationEmail' ? 'Notification Email Address' :
    property.name
}</h4>
                                                            <span class="px-2 py-0.5 text-xs font-medium rounded-full ${property.permission === 'READ_WRITE' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800'}">
                                                                ${property.permission === 'READ_WRITE' ? 'Editable' : 'Read Only'}
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>

                                                ${property.name === 'Icemachine_PN_SN' ? `
                                                    <div class="mt-3 p-3 bg-rose-50 rounded-lg border border-rose-100">
                                                        <div class="flex items-start space-x-2">
                                                            <svg class="w-4 h-4 text-rose-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/>
                                                            </svg>
                                                            <div>
                                                                <p class="text-sm font-medium text-rose-800 mb-1">What is Ice Machine PN/SN?</p>
                                                                <p class="text-xs text-rose-600 leading-relaxed">This field helps track which ice machine this FreezeSense device is currently installed in. Enter the part number (PN) or serial number (SN) of the ice machine for easy identification and maintenance tracking.</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                ` : property.name === 'notificationEmail' ? `
                                                    <div class="mt-3 p-3 bg-orange-50 rounded-lg border border-orange-100">
                                                        <div class="flex items-start space-x-2">
                                                            <svg class="w-4 h-4 text-orange-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                                                            </svg>
                                                            <div>
                                                                <p class="text-sm font-medium text-orange-800 mb-1">What is Notification Email Address?</p>
                                                                <p class="text-xs text-orange-600 leading-relaxed">This email address will receive critical alerts about your ice machine's status. Make sure to enter a valid email address that is regularly monitored to ensure timely response to any issues.</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                ` : property.name === 'cloudtemp' ? `
                                                    <div class="mt-3 p-3 bg-blue-50 rounded-lg border border-blue-100">
                                                        <div class="flex items-start space-x-2">
                                                            <svg class="w-4 h-4 text-blue-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                                            </svg>
                                                            <div>
                                                                <p class="text-sm font-medium text-blue-800 mb-1">What is Temperature?</p>
                                                                <p class="text-xs text-blue-600 leading-relaxed">This is the real-time temperature reading from the sensor placed in your ice machine and helps determine the ice level in your machine.</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                ` : property.name === 'cloudflowrate' ? `
                                                    <div class="mt-3 p-3 bg-purple-50 rounded-lg border border-purple-100">
                                                        <div class="flex items-start space-x-2">
                                                            <svg class="w-4 h-4 text-purple-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                                            </svg>
                                                            <div>
                                                                <p class="text-sm font-medium text-purple-800 mb-1">What is Flow Rate?</p>
                                                                <p class="text-xs text-purple-600 leading-relaxed">This measures the real-time water flow rate in your ice machine. It helps monitor water usage and detect potential issues with water supply or ice production.</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                ` : property.name === 'Last_Maintenance' ? `
                                                    <div class="mt-3 p-3 bg-amber-50 rounded-lg border border-amber-100">
                                                        <div class="flex items-start space-x-2">
                                                            <svg class="w-4 h-4 text-amber-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                                            </svg>
                                                            <div>
                                                                <p class="text-sm font-medium text-amber-800 mb-1">What is Last Maintenance?</p>
                                                                <p class="text-xs text-amber-600 leading-relaxed">This tracks when your ice machine was last serviced. Regular maintenance every 6 months is recommended to ensure optimal performance, prevent issues, and extend the life of your machine.</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                ` : property.name === 'location' ? `
                                                    <div class="mt-3 p-3 bg-teal-50 rounded-lg border border-teal-100">
                                                        <div class="flex items-start space-x-2">
                                                            <svg class="w-4 h-4 text-teal-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                                            </svg>
                                                            <div>
                                                                <p class="text-sm font-medium text-teal-800 mb-1">What is Ice Machine Location?</p>
                                                                <p class="text-xs text-teal-600 leading-relaxed">This field helps identify where the ice machine is physically located. Enter a descriptive location (e.g., "Kitchen - North Wall", "Bar Area", "Cafeteria Room 101") to easily locate and service the machine.</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                ` : property.name === 'sensorplacement' ? `
                                                    <div class="mt-3 p-3 bg-indigo-50 rounded-lg border border-indigo-100">
                                                        <div class="flex items-start space-x-2">
                                                            <svg class="w-4 h-4 text-indigo-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                                                            </svg>
                                                            <div>
                                                                <p class="text-sm font-medium text-indigo-800 mb-1">What is Sensor Placement?</p>
                                                                <p class="text-xs text-indigo-600 leading-relaxed">This setting determines where the temperature sensor is placed in your ice machine, measured as a percentage from the bottom. This helps accurately track ice levels and ensures proper monitoring of your machine's performance.</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                ` : property.name === 'tempThresholdMax' ? `
                                                    <div class="mt-3 p-3 bg-blue-50 rounded-lg border border-blue-100">
                                                        <div class="flex items-start space-x-2">
                                                            <svg class="w-4 h-4 text-blue-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                                            </svg>
                                                            <div>
                                                                <p class="text-sm font-medium text-blue-800 mb-1">What is Temperature Threshold Max?</p>
                                                                <p class="text-xs text-blue-600 leading-relaxed">This setting determines the maximum temperature threshold for your ice machine. When the temperature rises above this threshold, it indicates that ice levels have dropped below the sensor level. Adjust this value to fine-tune ice level detection and alert sensitivity.</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                ` : property.name === 'noFlowCriticalTime' ? `
                                                    <div class="mt-3 p-3 bg-purple-50 rounded-lg border border-purple-100">
                                                        <div class="flex items-start space-x-2">
                                                            <svg class="w-4 h-4 text-purple-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                                            </svg>
                                                            <div>
                                                                <p class="text-sm font-medium text-purple-800 mb-1">What is No Flow Critical Time?</p>
                                                                <p class="text-xs text-purple-600 leading-relaxed">This setting determines how long (in hours) the system should wait without detecting water flow before triggering a critical alert. Adjust this value based on your ice machine's typical production cycles and usage patterns to avoid false alarms.</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                ` : ''}

                                            ${property.permission === 'READ_WRITE' ? `
                                                    <div class="mt-4">
                                                    ${property.name === 'sensorplacement' ? 
                                                        getSensorPlacementSelector(device.id, property)
                                                    : property.name === 'Last_Maintenance' ? `
                                                            <div class="flex space-x-3">
                                                            <input 
                                                                type="text"
                                                                class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500 bg-white"
                                                                value="${property.last_value || ''}"
                                                                placeholder="MM/DD/YYYY"
                                                                pattern="^(0[1-9]|1[0-2])/(0[1-9]|[12][0-9]|3[01])/[0-9]{4}$"
                                                                title="Please enter date in MM/DD/YYYY format"
                                                                data-device-id="${device.id}"
                                                                data-property='${JSON.stringify(property).replace(/'/g, "&apos;")}'
                                                                onkeydown="handlePropertyInputKeydown(event)"
                                                            />
                                                            <button 
                                                                onclick="handleUpdateButtonClick(event)"
                                                                data-device-id="${device.id}"
                                                                data-property='${JSON.stringify(property).replace(/'/g, "&apos;")}'
                                                                class="px-4 py-2 text-sm font-medium text-white bg-amber-600 rounded-lg hover:bg-amber-700 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-offset-1 transition-colors"
                                                                type="button"
                                                            >
                                                                Update
                                                            </button>
                                                        </div>
                                                        <p class="mt-2 text-xs text-amber-600">Enter the last maintenance date in MM/DD/YYYY format (e.g., 03/15/2024)</p>
                                                    ` : `
                                                            <div class="flex space-x-3">
                                                            <input 
                                                                type="${getPropertyInputType(property)}"
                                                                class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white"
                                                                value="${property.name.toLowerCase().includes('temp') ? celsiusToFahrenheit(property.last_value).toFixed(1) : property.last_value || ''}"
                                                                placeholder="Enter new value"
                                                                data-device-id="${device.id}"
                                                                data-property='${JSON.stringify(property).replace(/'/g, "&apos;")}'
                                                                onkeydown="handlePropertyInputKeydown(event)"
                                                                step="${getPropertyStep(property)}"
                                                                ${property.type === 'INT' || property.type === 'FLOAT' ? `min="0"` : ''}
                                                            />
                                                            <button 
                                                                onclick="handleUpdateButtonClick(event)"
                                                                data-device-id="${device.id}"
                                                                data-property='${JSON.stringify(property).replace(/'/g, "&apos;")}'
                                                                class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1 transition-colors"
                                                                type="button"
                                                            >
                                                                Update
                                                            </button>
                                                        </div>
                                                    `}
                                                </div>
                                            ` : `
                                                    <div class="mt-3">
                                                        <p class="text-2xl font-semibold ${getPropertyTextColor(property.name)}">
                                                            ${property.name.toLowerCase().includes('temp') ? 
                                                                `${celsiusToFahrenheit(property.last_value)?.toFixed(1)}°F` : 
                                                                property.name === 'cloudflowrate' ?
                                                                `${Number(property.last_value).toFixed(2)} L/min` :
                                                                formatPropertyValue(property)}
                                                        </p>
                                                        ${property.name === 'cloudflowrate' ? '' : ''}
                                                    </div>
                                                `}
                                                
                                                <div class="mt-4 pt-3 border-t border-gray-100">
                                                    <div class="flex items-center space-x-1 text-xs text-gray-500">
                                                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                                        </svg>
                                                        <span>Last Updated: ${new Date(device.last_activity_at).toLocaleString('en-US', {
                                                            dateStyle: 'medium',
                                                timeStyle: 'short'
                                                        })}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('') 
                                    : '<p class="text-gray-500">No properties available</p>'
                                }
                            </div>
                        </div>
                    ` : '<p class="text-gray-500">No thing data available</p>'}
                </div>
            `;

            // Initialize the graphs
            initializeGraphs(deviceIndex);

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function hideDeviceDetails() {
            const modal = document.getElementById('device-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        // Standardize all property update handlers
        async function handleUpdateButtonClick(event) {
            event.preventDefault(); // Prevent any default button behavior
            const button = event.target;
            const input = button.previousElementSibling;
            const deviceId = button.dataset.deviceId;
            
            try {
                const property = JSON.parse(button.dataset.property);
                
                // Add validation for Last_Maintenance property
                if (property.name === 'Last_Maintenance') {
                    if (!isValidMaintenanceDate(input.value)) {
                        showError('Please enter a valid date in MM/DD/YYYY format. Date cannot be in the future.');
                        return;
                    }
                }
                
                // Disable input and button during update
                input.disabled = true;
                button.disabled = true;
                const originalText = button.innerHTML;
                button.innerHTML = '<span class="animate-spin">⌛</span>';
                
                property.new_value = input.value;
                
                // Log the update attempt
                logToConsole({
                    message: 'Attempting to update property via button click',
                    deviceId: deviceId,
                    propertyName: property.name,
                    currentValue: property.last_value,
                    newValue: property.new_value
                }, 'info');
                
                await updatePropertyValue(deviceId, property);
                
                // Show success toast
                showToast('Property updated successfully. Refreshing...', 'success');
                
                // Small delay to show success state
                setTimeout(() => {
                    // Force reload from server, not cache
                    window.location.href = window.location.href.split('#')[0];
                    window.location.reload(true);
                }, 1000);
                
            } catch (error) {
                // Re-enable input and button
                input.disabled = false;
                button.disabled = false;
                button.innerHTML = originalText;
                
                logToConsole(`Error handling property input: ${error.message}`, 'error');
                showError(`Failed to update property: ${error.message}`);
            }
        }

        // Remove duplicate handlers
        function handlePropertyUpdate(event, deviceId, property) {
            return handlePropertyInputKeydown(event);
        }

        // Update showToast to ensure it's visible
        function showToast(message, type = 'info') {
            // Remove any existing toasts
            const existingToasts = document.querySelectorAll('.toast-notification');
            existingToasts.forEach(toast => toast.remove());
            
            const toast = document.createElement('div');
            toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg text-white ${
                type === 'error' ? 'bg-red-500' : 
                type === 'success' ? 'bg-green-500' : 
                'bg-blue-500'
            } shadow-lg z-50 toast-notification`;
            
            toast.innerHTML = `
                <div class="flex items-center space-x-2">
                    ${type === 'success' ? `
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                    ` : type === 'error' ? `
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    ` : `
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    `}
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Don't remove success toasts that indicate refresh
            if (!message.includes('Refreshing')) {
                setTimeout(() => toast.remove(), 3000);
            }
        }

        function showActiveDevices() {
            const devices = window.lastDevicesData || [];
            const modal = document.getElementById('active-devices-modal');
            const devicesList = document.getElementById('active-devices-list');

            devicesList.innerHTML = devices.map(device => {
                const statusEvent = device.events?.find(event => event.name === 'r_status');
                const isConnected = statusEvent?.value === 'CONNECTED';
                
                return `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100">
                        <div>
                            <h3 class="font-medium text-gray-800">${device.name || 'Unnamed Device'}</h3>
                            <p class="text-sm text-gray-500">
                                ID: ${device.id}
                            </p>
                        </div>
                        <span class="px-2 py-1 text-xs font-medium rounded-full ${isConnected ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                            ${isConnected ? 'Connected' : 'Disconnected'}
                        </span>
                    </div>
                `;
            }).join('') || '<p class="text-gray-500 text-center py-4">No active devices found</p>';

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function hideActiveDevices() {
            const modal = document.getElementById('active-devices-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function showConnectedDevices() {
            const devices = window.lastDevicesData || [];
            const modal = document.getElementById('connected-devices-modal');
            const devicesList = document.getElementById('connected-devices-list');

            const connectedDevices = devices.filter(device => {
                const statusEvent = device.events?.find(event => event.name === 'r_status');
                return statusEvent?.value === 'CONNECTED';
            });

            devicesList.innerHTML = connectedDevices.length > 0 ? 
                connectedDevices.map(device => `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100">
                        <div>
                            <h3 class="font-medium text-gray-800">${device.name || 'Unnamed Device'}</h3>
                            <p class="text-sm text-gray-500">
                                ID: ${device.id}
                            </p>
                        </div>
                        <span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">
                            Connected
                        </span>
                </div>
                `).join('') 
                : '<p class="text-gray-500 text-center py-4">No connected devices found</p>';

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function hideConnectedDevices() {
            const modal = document.getElementById('connected-devices-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function showGreatDevices() {
            const devices = window.lastDevicesData || [];
            const modal = document.getElementById('great-devices-modal');
            const devicesList = document.getElementById('great-devices-list');

            const greatDevices = devices.filter(device => calculateDeviceStatus(device).isGreat);

            devicesList.innerHTML = greatDevices.length > 0 ? 
                greatDevices.map(device => {
                    const status = calculateDeviceStatus(device);
                    return `
                        <div class="flex items-center justify-between p-3 bg-emerald-50 rounded-lg hover:bg-emerald-100">
                            <div>
                                <h3 class="font-medium text-emerald-800">${device.thing?.properties?.find(p => p.name === 'devicename')?.last_value || device.name || 'Unnamed Device'}</h3>
                                <p class="text-sm text-emerald-600">
                                    Cloud Temp: ${formatTemperature(status.cloudTemp, status.tempThresholdMax)} (Max: ${formatTemperature(status.tempThresholdMax)})<br>
                                    Time Since Flow: ${formatTimeDuration(status.timeSinceFlowMs)} (Critical: ${status.noFlowCriticalTime}h)
                                </p>
                            </div>
                            <span class="px-2 py-1 text-xs font-medium rounded-full bg-emerald-100 text-emerald-800">
                                Great
                            </span>
                        </div>
                    `;
                }).join('') 
                : '<p class="text-gray-500 text-center py-4">No devices in great condition found</p>';

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function hideGreatDevices() {
            const modal = document.getElementById('great-devices-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function showWarningDevices() {
            const devices = window.lastDevicesData || [];
            const modal = document.getElementById('warning-devices-modal');
            const devicesList = document.getElementById('warning-devices-list');

            const warningDevices = devices.filter(device => calculateDeviceStatus(device).isWarning);

            devicesList.innerHTML = warningDevices.length > 0 ? 
                warningDevices.map(device => {
                    const status = calculateDeviceStatus(device);
                    return `
                        <div class="flex items-center justify-between p-3 bg-yellow-50 rounded-lg hover:bg-yellow-100">
                            <div>
                                <h3 class="font-medium text-yellow-800">${device.thing?.properties?.find(p => p.name === 'devicename')?.last_value || device.name || 'Unnamed Device'}</h3>
                                <p class="text-sm text-yellow-600">
                                    Cloud Temp: ${formatTemperature(status.cloudTemp)} (${status.cloudTemp > 32 ? 'High' : 'Normal'})<br>
                                    Time Since Flow: ${formatTimeDuration(status.timeSinceFlowMs)} (Critical: ${status.noFlowCriticalTime}h)
                                </p>
                            </div>
                            <span class="px-2 py-1 text-xs font-medium rounded-full bg-yellow-100 text-yellow-800">
                                Warning
                            </span>
                        </div>
                    `;
                }).join('') 
                : '<p class="text-gray-500 text-center py-4">No devices in warning state found</p>';

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function hideWarningDevices() {
            const modal = document.getElementById('warning-devices-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function showCriticalDevices() {
            const devices = window.lastDevicesData || [];
            const modal = document.getElementById('critical-devices-modal');
            const devicesList = document.getElementById('critical-devices-list');

            const criticalDevices = devices.filter(device => calculateDeviceStatus(device).isCritical);

            devicesList.innerHTML = criticalDevices.length > 0 ? 
                criticalDevices.map(device => {
                    const status = calculateDeviceStatus(device);
                    return `
                        <div class="flex items-center justify-between p-3 bg-red-50 rounded-lg hover:bg-red-100">
                            <div>
                                <h3 class="font-medium text-red-800">${device.thing?.properties?.find(p => p.name === 'devicename')?.last_value || device.name || 'Unnamed Device'}</h3>
                                ${!status.isConnected ? `
                                    <p class="text-sm text-red-600">
                                        Disconnected since: ${new Date(status.lastConnectedTime).toLocaleString()}
                                    </p>
                                ` : `
                                    <p class="text-sm text-red-600">
                                        Cloud Temp: ${formatTemperature(status.cloudTemp)} (High)<br>
                                        Time Since Flow: ${formatTimeDuration(status.timeSinceFlowMs)} (Critical: ${status.noFlowCriticalTime}h)
                                    </p>
                                `}
                            </div>
                            <span class="px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-800">
                                Critical
                            </span>
                        </div>
                    `;
                }).join('') 
                : '<p class="text-gray-500 text-center py-4">No devices in critical state found</p>';

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function hideCriticalDevices() {
            const modal = document.getElementById('critical-devices-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function getSensorPlacementSelector(deviceId, property) {
            const currentValue = property.last_value ? property.last_value * 100 : null;
            return `
                <div class="flex flex-col space-y-2">
                    <div class="flex space-x-2">
                        <select 
                            class="w-full px-2 py-1 text-sm border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                            data-device-id="${deviceId}"
                            data-property='${JSON.stringify(property).replace(/'/g, "&apos;")}'
                            id="sensorPlacement_${deviceId}"
                        >
                            <option value="" ${!currentValue ? 'selected' : ''}>Select sensor placement</option>
                            <option value="10" ${currentValue === 10 ? 'selected' : ''}>10% from bottom</option>
                            <option value="25" ${currentValue === 25 ? 'selected' : ''}>25% from bottom</option>
                            <option value="50" ${currentValue === 50 ? 'selected' : ''}>50% from bottom</option>
                            <option value="75" ${currentValue === 75 ? 'selected' : ''}>75% from bottom</option>
                        </select>
                        <button 
                            onclick="handleSensorPlacementChange(document.getElementById('sensorPlacement_${deviceId}'))"
                            class="px-3 py-1 text-sm bg-blue-500 text-white rounded hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                            Update
                        </button>
                    </div>
                </div>
            `;
        }
