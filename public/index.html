<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IceAlert - Commercial & Residential Ice Machine Monitoring</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
        }

        .device-card {
            transition: all 0.2s ease-in-out;
            border: 1px solid rgba(226, 232, 240, 0.8);
            backdrop-filter: blur(8px);
            background: rgba(255, 255, 255, 0.98);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05), 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .device-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08), 0 6px 6px rgba(0, 0, 0, 0.12);
        }

        .device-card .property-card {
            transition: all 0.2s ease;
            border: 1px solid rgba(226, 232, 240, 0.8);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .device-card .property-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
        }

        .stat-card {
            transition: transform 0.2s ease;
        }

        .stat-card:hover {
            transform: scale(1.05);
        }

        .glass-nav {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(226, 232, 240, 0.8);
        }

        .property-card {
            transition: all 0.2s ease;
        }

        .property-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .connected-badge {
            animation: pulse 2s infinite;
        }

        .modal-content {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        }

        @keyframes flash-red {
            0%, 100% { 
                color: #991B1B; 
                background-color: #FEE2E2;
            }
            50% { 
                color: #DC2626; 
                background-color: #FEF2F2;
            }
        }

        .temp-warning {
            animation: flash-red 2s infinite;
            padding: 2px 6px;
            border-radius: 4px;
        }

        @keyframes flash-red-box {
            0%, 100% { 
                background: linear-gradient(to bottom right, #FEE2E2, #FEF2F2);
                border-color: #DC2626;
            }
            50% { 
                background: linear-gradient(to bottom right, #FEF2F2, #FEE2E2);
                border-color: #991B1B;
            }
        }

        .temp-warning-box, .flow-warning-box {
            animation: flash-red-box 2s infinite;
            border: 1px solid;
        }

        .temp-warning-box *, .flow-warning-box * {
            color: #991B1B !important;
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
            margin-bottom: 1rem;
        }

        .time-range-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .time-range-button {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .time-range-button.active {
            background-color: #2563eb;
            color: white;
        }

        .time-range-button:not(.active) {
            background-color: #e5e7eb;
            color: #374151;
        }

        .time-range-button:hover:not(.active) {
            background-color: #d1d5db;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="glass-nav sticky top-0 z-40">
        <div class="container mx-auto px-4 py-3">
            <div class="flex flex-col space-y-3">
                <!-- Top Row -->
                <div class="flex flex-col md:flex-row md:justify-between md:items-center space-y-3 md:space-y-0">
                    <div class="flex items-center space-x-3">
                        <svg class="w-8 h-8 text-blue-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 3v18M12 3l4 4M12 3L8 7M12 21l4-4M12 21l-4-4M3 12h18M3 12l4-4M3 12l4 4M21 12l-4-4M21 12l-4 4" 
                                  stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <div>
                            <h1 class="text-2xl font-bold text-gray-800">IceAlert</h1>
                            <p class="text-sm text-gray-600">Commercial & Residential Ice Machine Monitoring</p>
                            <div class="flex items-center mt-1">
                                <span class="bg-yellow-100 text-yellow-800 text-xs font-medium px-2 py-0.5 rounded">BETA</span>
                                <button 
                                    onclick="showDisclaimer()" 
                                    class="ml-2 text-xs text-blue-600 hover:text-blue-800 underline"
                                >
                                    View Disclaimer
                                </button>
                                <span class="mx-2 text-gray-300">|</span>
                                <button 
                                    onclick="showContact()" 
                                    class="text-xs text-blue-600 hover:text-blue-800 underline"
                                >
                                    Contact Us
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-col md:flex-row items-center space-y-2 md:space-y-0 md:space-x-4">
                        <div class="grid grid-cols-3 md:flex items-center gap-2 md:space-x-3 w-full md:w-auto">
                            <div class="stat-card text-center px-3 py-1 bg-blue-50 rounded-md cursor-pointer hover:bg-blue-100 transition-all shadow-sm" onclick="showActiveDevices()">
                                <p class="text-xs font-medium text-blue-600">Active</p>
                                <p class="text-lg font-bold text-blue-700" id="activeDevicesCount">-</p>
                            </div>
                            <div class="text-center px-3 py-1 bg-green-50 rounded-md cursor-pointer hover:bg-green-100 transition-colors" onclick="showConnectedDevices()">
                                <p class="text-xs font-medium text-green-600">Connected</p>
                                <p class="text-lg font-bold text-green-700" id="connectedDevicesCount">-</p>
                            </div>
                            <div class="text-center px-3 py-1 bg-emerald-50 rounded-md cursor-pointer hover:bg-emerald-100 transition-colors" onclick="showGreatDevices()">
                                <p class="text-xs font-medium text-emerald-600">Great</p>
                                <p class="text-lg font-bold text-emerald-700" id="greatDevicesCount">-</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 md:flex items-center gap-2 md:space-x-3 w-full md:w-auto">
                            <div class="text-center px-3 py-1 bg-yellow-50 rounded-md cursor-pointer hover:bg-yellow-100 transition-colors" onclick="showWarningDevices()">
                                <p class="text-xs font-medium text-yellow-600">Warning</p>
                                <p class="text-lg font-bold text-yellow-700" id="warningDevicesCount">-</p>
                            </div>
                            <div class="text-center px-3 py-1 bg-red-50 rounded-md cursor-pointer hover:bg-red-100 transition-colors" onclick="showCriticalDevices()">
                                <p class="text-xs font-medium text-red-600">Critical</p>
                                <p class="text-lg font-bold text-red-700" id="criticalDevicesCount">-</p>
                            </div>
                        </div>
                        <button onclick="toggleConsole()" class="w-full md:w-auto bg-gray-800 text-white px-3 py-1.5 rounded-md hover:bg-gray-700 text-sm font-medium transition-colors">
                            Debug Console
                        </button>
                    </div>
                </div>
                <!-- Bottom Row -->
                <div class="flex flex-col md:flex-row md:items-center md:justify-between border-t pt-2 space-y-2 md:space-y-0">
                    <p class="text-sm text-gray-600">Real-time monitoring and alerts for ice machines and water systems</p>
                    <div class="flex items-center text-sm text-gray-500">
                        <span>Last Update: </span>
                        <span id="lastUpdateTime" class="ml-1 text-gray-700">-</span>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-6">
        <!-- Debug Console -->
        <div id="debug-console" class="mb-4 hidden">
            <div class="bg-gray-900 text-green-400 p-4 rounded-lg shadow-lg font-mono text-sm overflow-auto border border-gray-700" style="max-height: 300px; backdrop-filter: blur(8px);">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-white font-bold">Debug Console</h3>
                    <button onclick="clearConsole()" class="text-gray-400 hover:text-white transition-colors">Clear</button>
                </div>
                <div id="console-output" class="whitespace-pre-wrap"></div>
            </div>
        </div>
        
        <!-- Loading and Error States -->
        <div id="status" class="mb-4 text-center hidden">
            <div class="inline-flex items-center px-4 py-2 bg-blue-50 rounded-lg">
                <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-2"></div>
                <p class="text-sm font-medium text-blue-600">Loading devices...</p>
            </div>
        </div>
        
        <div id="error" class="mb-4 hidden">
            <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg" role="alert">
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <div>
                        <p class="font-medium">Error</p>
                        <p class="text-sm" id="error-message"></p>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="devices" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
            <!-- Devices will be populated here -->
        </div>
    </div>

    <!-- Disclaimer Modal -->
    <div id="disclaimer-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 m-4 max-w-lg w-full">
            <div class="flex justify-between items-start mb-4">
                <h2 class="text-xl font-bold text-gray-800">Beta Version Disclaimer</h2>
                <button onclick="hideDisclaimer()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="text-gray-600 space-y-4">
                <p>Welcome to the IceAlert Beta version. Please be aware that:</p>
                <ul class="list-disc pl-5 space-y-2">
                    <li>This is a beta release and features may be incomplete or subject to change</li>
                    <li>Data accuracy and system reliability are being continuously improved</li>
                    <li>The interface and functionality may be updated without prior notice</li>
                    <li>We recommend verifying critical alerts through physical inspection</li>
                    <li>Your feedback is valuable in helping us improve the system</li>
                </ul>
                <p class="text-sm mt-4">
                    By using this beta version, you acknowledge that the system is under development and 
                    should not be solely relied upon for critical ice machine monitoring without appropriate backup measures.
                </p>
                <hr class="my-4 border-gray-200" />
                <div class="text-sm text-gray-500">
                    <p>This application is being developed for a specific undisclosed client.</p>
                    <div class="mt-4 space-y-3">
                        <div>
                            <p class="font-medium">Business & Sales Inquiries:</p>
                            <p class="mt-1">For information about purchasing units or exploring customized monitoring solutions for your business, please contact:</p>
                            <p class="font-medium mt-1">Aarya Shah</p>
                            <a href="mailto:icealertdevice@gmail.com" class="text-blue-600 hover:text-blue-800">icealertdevice@gmail.com</a>
                        </div>
                        <div>
                            <p class="font-medium">Technical Support & Development:</p>
                            <p class="mt-1">For questions about the system's features, hardware specifications, or technical capabilities, please contact:</p>
                            <p class="font-medium mt-1">Kunj Tapiawala</p>
                            <a href="mailto:icealertdevice@gmail.com" class="text-blue-600 hover:text-blue-800">icealertdevice@gmail.com</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Contact Modal -->
    <div id="contact-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 m-4 max-w-lg w-full">
            <div class="flex justify-between items-start mb-4">
                <h2 class="text-xl font-bold text-gray-800">Contact Us</h2>
                <button onclick="hideContact()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="text-gray-600 space-y-6">
                <div>
                    <h3 class="font-medium text-lg text-gray-800">Business & Sales Inquiries</h3>
                    <p class="mt-2">For information about purchasing units or exploring customized monitoring solutions for your business, please contact:</p>
                    <div class="mt-3">
                        <p class="font-medium">Aarya Shah</p>
                        <a href="mailto:icealertdevice@gmail.com" class="text-blue-600 hover:text-blue-800">icealertdevice@gmail.com</a>
                    </div>
                </div>
                <div>
                    <h3 class="font-medium text-lg text-gray-800">Technical Support & Development</h3>
                    <p class="mt-2">For questions about the system's features, hardware specifications, or technical capabilities, please contact:</p>
                    <div class="mt-3">
                        <p class="font-medium">Kunj Tapiawala</p>
                        <a href="mailto:icealertdevice@gmail.com" class="text-blue-600 hover:text-blue-800">icealertdevice@gmail.com</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Update this at the start of your script
        const API_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:3000'
            : 'https://icealert.up.railway.app';

        const statusEl = document.getElementById('status');
        const errorEl = document.getElementById('error');
        const errorMessageEl = document.getElementById('error-message');
        const devicesContainer = document.getElementById('devices');
        const consoleOutput = document.getElementById('console-output');
        const debugConsole = document.getElementById('debug-console');

        // Debug Console Functions
        function toggleConsole() {
            debugConsole.classList.toggle('hidden');
        }

        function clearConsole() {
            consoleOutput.innerHTML = '';
        }

        function logToConsole(data, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type === 'error' ? 'text-red-400' : 
                             type === 'warning' ? 'text-yellow-400' : 
                             'text-green-400';
            
            const logEntry = document.createElement('div');
            logEntry.className = colorClass;
            logEntry.innerHTML = `[${timestamp}] ${typeof data === 'object' ? JSON.stringify(data, null, 2) : data}`;
            
            consoleOutput.appendChild(logEntry);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }
        function parseTsArray(arr) {
  if (!Array.isArray(arr)) {
    logToConsole('parseTsArray received non-array input:', 'warning');
    logToConsole(arr, 'warning');
    return { times: [], values: [] };
  }

  const result = {
    times: arr.map(obj => obj.time || obj.timestamp),
    values: arr.map(obj => obj.value)
  };

  logToConsole('parseTsArray result:', 'info');
  logToConsole(`Times: ${result.times.length}, Values: ${result.values.length}`, 'info');

  return result;
}
        function showLoading() {
            statusEl.classList.remove('hidden');
            errorEl.classList.add('hidden');
            devicesContainer.innerHTML = '';
        }

        function showError(message) {
            statusEl.classList.add('hidden');
            errorEl.classList.remove('hidden');
            errorMessageEl.textContent = message;
            logToConsole(message, 'error');
        }

        function hideLoading() {
            statusEl.classList.add('hidden');
        }

        async function checkServerHealth() {
            try {
                const response = await fetch(`${API_URL}/health`);
                if (!response.ok) throw new Error('Server health check failed');
                return true;
            } catch (error) {
                console.error('Server health check failed:', error);
                logToConsole('Server health check failed: ' + error.message, 'error');
                return false;
            }
        }

        function updateLastUpdateTime() {
            const now = new Date();
            document.getElementById('lastUpdateTime').textContent = now.toLocaleTimeString();
        }

        async function fetchDevices() {
            showLoading();
            
            try {
                // First check if server is healthy
                const isHealthy = await checkServerHealth();
                if (!isHealthy) {
                    throw new Error('Server is not responding. Please make sure the server is running.');
                }

                const response = await fetch(`${API_URL}/api/devices`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const devices = await response.json();
                
                if (devices.error) {
                    throw new Error(devices.message || devices.error);
                }
                
                // Sort devices by name
                devices.sort((a, b) => {
                    // Extract numbers from device names (assuming format like "001", "002", etc.)
                    const aNum = parseInt(a.name.replace(/\D/g, '')) || 0;
                    const bNum = parseInt(b.name.replace(/\D/g, '')) || 0;
                    return aNum - bNum;
                });
                
                // Store the sorted devices data for modal use
                window.lastDevicesData = devices;
                
                // Update last update time
                updateLastUpdateTime();
                
                // Log raw device data to console
                logToConsole('Received device data (sorted):');
                logToConsole(devices);
                
                displayDevices(devices);
                hideLoading();
            } catch (error) {
                console.error('Error fetching devices:', error);
                showError(error.message || 'Failed to fetch devices. Please try again later.');
            }
        }

        function formatPropertyValue(property) {
            if (property.last_value === undefined || property.last_value === null) {
                return 'N/A';
            }

            switch(property.type) {
                case 'BOOL':
                    return property.last_value ? 'True' : 'False';
                case 'FLOAT':
                    if (property.name === 'sensorplacement') {
                        const percentage = property.last_value * 100;
                        return `${percentage}%`;
                    }
                    return Number(property.last_value).toFixed(2);
                case 'INT':
                    return property.last_value.toString();
                case 'STRING':
                    return property.last_value;
                default:
                    return property.last_value;
            }
        }

        function getPropertyInputType(property) {
            switch(property.type) {
                case 'BOOL':
                    return 'checkbox';
                case 'INT':
                case 'FLOAT':
                    return 'number';
                default:
                    return 'text';
            }
        }

        function getPropertyStep(property) {
            switch(property.type) {
                case 'FLOAT':
                    return '0.01';
                case 'INT':
                    return '1';
                default:
                    return 'any';
            }
        }

        function fahrenheitToCelsius(fahrenheit) {
            return (fahrenheit - 32) * 5/9;
        }

        async function updatePropertyValue(deviceId, property) {
            try {
                if (!deviceId || !property) {
                    throw new Error('Device ID and Property are required');
                }

                // Log the update attempt with all details
                logToConsole({
                    message: 'Attempting to update property',
                    deviceId: deviceId,
                    propertyName: property.name,
                    currentValue: property.last_value,
                    newValue: property.new_value,
                    propertyType: property.type
                }, 'info');

                // Format the value based on type
                let formattedValue;
                switch(property.type) {
                    case 'INT':
                        formattedValue = parseInt(property.new_value);
                        if (isNaN(formattedValue)) {
                            throw new Error('Invalid integer value');
                        }
                        break;
                    case 'FLOAT':
                        // Convert Fahrenheit to Celsius if this is a temperature property
                        if (property.name.toLowerCase().includes('temp')) {
                            formattedValue = fahrenheitToCelsius(parseFloat(property.new_value));
                        } else {
                            formattedValue = parseFloat(property.new_value);
                        }
                        if (isNaN(formattedValue)) {
                            throw new Error('Invalid float value');
                        }
                        break;
                    case 'BOOL':
                        // Convert to actual boolean instead of string
                        formattedValue = property.new_value === true || property.new_value === 'true';
                        break;
                    case 'CHARSTRING':
                    case 'STATUS':
                        formattedValue = String(property.new_value).trim();
                        if (!formattedValue) {
                            throw new Error('Value cannot be empty');
                        }
                        break;
                    default:
                        formattedValue = property.new_value;
                }

                // Using V2 API endpoint format and structure
                const apiUrl = `${API_URL}/api/iot/v2/devices/${deviceId}/properties`;

                // Construct payload exactly as per Arduino V2 API docs
                const requestBody = {
                    propertiesValues: {
                        input: true,
                        properties: [{
                            name: property.name,
                            type: property.type,
                            value: formattedValue // Send raw value without converting to string
                        }]
                    }
                };

                logToConsole({
                    message: 'Sending update request',
                    url: apiUrl,
                    body: requestBody
                }, 'info');

                const response = await fetch(apiUrl, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'X-Organization': property.organization_id || ''  // Add organization ID if available
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => null);
                    throw new Error(errorData?.error || `HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                logToConsole({
                    message: 'Update successful',
                    deviceId: deviceId,
                    propertyName: property.name,
                    response: result
                }, 'info');

                // Refresh the devices list to show the new value
                fetchDevices();
            } catch (error) {
                logToConsole({
                    message: 'Error updating property',
                    error: error.message,
                    deviceId: deviceId,
                    propertyName: property?.name
                }, 'error');
                showError(`Failed to update property: ${error.message}`);
            }
        }

        function handlePropertyUpdate(event, deviceId, property) {
            if (event.key === 'Enter') {
                const newValue = event.target.value;
                property.new_value = newValue;
                updatePropertyValue(deviceId, property);
            }
        }

        function handlePropertyInputKeydown(event) {
            if (event.key === 'Enter') {
                const input = event.target;
                const deviceId = input.dataset.deviceId;
                
                try {
                    const property = JSON.parse(input.dataset.property);
                    property.new_value = input.value;
                    
                    if (!deviceId) {
                        throw new Error('Device ID is missing');
                    }
                    
                    updatePropertyValue(deviceId, property);
                } catch (error) {
                    logToConsole(`Error handling property input: ${error.message}`, 'error');
                    showError(`Failed to handle property input: ${error.message}`);
                }
            }
        }

        function handlePropertyInputChange(event) {
            const input = event.target;
            const deviceId = input.dataset.deviceId;
            
            try {
                const property = JSON.parse(input.dataset.property);
                property.new_value = input.type === 'checkbox' ? input.checked : input.value;
                
                if (!deviceId) {
                    throw new Error('Device ID is missing');
                }
                
                updatePropertyValue(deviceId, property);
            } catch (error) {
                logToConsole(`Error handling property input: ${error.message}`, 'error');
                showError(`Failed to handle property input: ${error.message}`);
            }
        }

        function getPropertyBgColor(propertyName) {
            const colorMap = {
                'temp': 'bg-blue-50',
                'temperature': 'bg-blue-50',
                'humidity': 'bg-green-50',
                'flow': 'bg-purple-50',
                'pressure': 'bg-yellow-50',
                'level': 'bg-indigo-50',
                'status': 'bg-gray-50'
            };

            for (const [key, color] of Object.entries(colorMap)) {
                if (propertyName.toLowerCase().includes(key)) {
                    return color;
                }
            }
            return 'bg-gray-50';
        }

        function getPropertyTextColor(propertyName) {
            const colorMap = {
                'temp': 'text-blue-800',
                'temperature': 'text-blue-800',
                'humidity': 'text-green-800',
                'flow': 'text-purple-800',
                'pressure': 'text-yellow-800',
                'level': 'text-indigo-800',
                'status': 'text-gray-800'
            };

            for (const [key, color] of Object.entries(colorMap)) {
                if (propertyName.toLowerCase().includes(key)) {
                    return color;
                }
            }
            return 'text-gray-800';
        }

        function celsiusToFahrenheit(celsius) {
            if (celsius === undefined || celsius === null) return undefined;
            return (celsius * 9/5) + 32;
        }

        function formatTemperature(celsius, maxThreshold = null) {
            if (celsius === undefined || celsius === null) return 'N/A';
            const fahrenheit = celsiusToFahrenheit(celsius);
            const value = `${fahrenheit.toFixed(1)}°F`;
            
            if (maxThreshold !== null && celsius >= maxThreshold) {
                return `<span class="temp-warning">${value}</span>`;
            }
            return value;
        }

        function getTemperatureCardClass(temp, maxThreshold) {
            if (temp === undefined || temp === null || maxThreshold === undefined || maxThreshold === null) {
                return 'bg-gradient-to-br from-blue-50 to-blue-100';
            }
            return temp >= maxThreshold ? 'temp-warning-box' : 'bg-gradient-to-br from-blue-50 to-blue-100';
        }

        function formatTimeDuration(milliseconds) {
            if (!milliseconds) return 'N/A';
            
            const seconds = Math.floor(milliseconds / 1000);
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const remainingSeconds = seconds % 60;
            
            return `${hours}h ${minutes}m ${remainingSeconds}s`;
        }

        // Helper function to format durations for the status graph
        function formatDuration(milliseconds) {
            if (!milliseconds) return '0s';
            
            const seconds = Math.floor(milliseconds / 1000);
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const remainingSeconds = seconds % 60;
            
            let parts = [];
            if (hours > 0) parts.push(`${hours}h`);
            if (minutes > 0) parts.push(`${minutes}m`);
            if (remainingSeconds > 0 || parts.length === 0) parts.push(`${remainingSeconds}s`);
            
            return parts.join(' ');
        }

        // Store timers for cleanup
        let timeSinceFlowTimers = [];

        function clearTimeSinceFlowTimers() {
            timeSinceFlowTimers.forEach(timer => clearInterval(timer));
            timeSinceFlowTimers = [];
        }

        function getFlowCardClass(timeSinceFlowHours, criticalTime) {
            if (timeSinceFlowHours === null || criticalTime === undefined || criticalTime === null) {
                return 'bg-gradient-to-br from-green-50 to-green-100';
            }
            console.log('Time comparison:', { timeSinceFlowHours, criticalTime, isWarning: timeSinceFlowHours >= criticalTime });
            return parseFloat(timeSinceFlowHours) >= parseFloat(criticalTime) ? 'flow-warning-box' : 'bg-gradient-to-br from-green-50 to-green-100';
        }

        function updateTimeSinceFlow(element, startTime) {
            if (!startTime) {
                element.textContent = 'N/A';
                return null;
            }

            const criticalTime = parseFloat(element.dataset.criticalTime);
            const cardElement = element.closest('.property-card');
            const deviceId = element.dataset.deviceId; // Add device ID to track updates per device

            // Log initial state for debugging
            logToConsole(`Initializing flow timer for device ${deviceId}:`, {
                startTime,
                criticalTime,
                currentTime: new Date().toISOString()
            });

            const update = () => {
                const timeSinceFlowMs = new Date() - new Date(startTime);
                const timeSinceFlowHours = timeSinceFlowMs / (1000 * 60 * 60);
                element.textContent = formatTimeDuration(timeSinceFlowMs);
                
                // Update warning state
                cardElement.className = `property-card ${getFlowCardClass(timeSinceFlowHours, criticalTime)} p-2 rounded-lg`;
                
                // Log for debugging
                if (timeSinceFlowHours >= criticalTime) {
                    logToConsole(`Critical flow time reached for device ${deviceId}:`, {
                        timeSinceFlowHours,
                        criticalTime,
                        lastUpdate: startTime
                    });
                }
            };

            update(); // Initial update
            const timer = setInterval(update, 1000); // Update every second
            timeSinceFlowTimers.push(timer);
            return timer;
        }

        // Add cooldown tracking for warning and critical updates
        const lastStatusUpdate = {
            warning: {},
            critical: {}
        };

        const COOLDOWN_TIME = 5000; // 5 seconds in milliseconds

        function canUpdateStatus(deviceId, statusType) {
            const lastUpdate = lastStatusUpdate[statusType][deviceId];
            if (!lastUpdate) return true;
            
            const timeSinceLastUpdate = Date.now() - lastUpdate;
            return timeSinceLastUpdate >= COOLDOWN_TIME;
        }

        function updateLastStatusTime(deviceId, statusType) {
            lastStatusUpdate[statusType][deviceId] = Date.now();
            logToConsole(`Updated ${statusType} status for device ${deviceId}. Next update allowed after ${new Date(Date.now() + COOLDOWN_TIME).toLocaleTimeString()}`);
        }

        function calculateDeviceStatus(device) {
            // Find the r_status event to determine connection status
            const statusEvent = device.events?.find(event => event.name === 'r_status');
            const isConnected = statusEvent?.value === 'CONNECTED';
            const lastConnectedTime = statusEvent?.updated_at;

            // Find key properties
            const properties = device.thing?.properties || [];
            
            // Get current warning and critical states with normalized boolean values
            const warningProperty = properties.find(p => p.name === 'warning');
            const criticalProperty = properties.find(p => p.name === 'critical');
            
            // Helper function to normalize boolean values
            const normalizeBoolean = (value) => {
                if (value === 'true' || value === true) return true;
                if (value === 'false' || value === false) return false;
                return false; // default value
            };
            
            // Normalize current values
            const currentWarning = normalizeBoolean(warningProperty?.last_value);
            const currentCritical = normalizeBoolean(criticalProperty?.last_value);

            // Get cloud temperature
            const cloudTemp = properties.find(p => 
                p.name === 'cloudtemp'
            )?.last_value;

            // Get temperature threshold max
            const tempThresholdMax = properties.find(p => 
                p.name === 'tempThresholdMax'
            )?.last_value;

            // Get flow related properties
            const cloudFlowRate = properties.find(p => 
                p.name === 'cloudflowrate'
            );

            const noFlowCriticalTime = properties.find(p => 
                p.name === 'noFlowCriticalTime'
            )?.last_value;

            // Calculate time since last flow
            const flowLastUpdate = cloudFlowRate?.value_updated_at;
            const timeSinceFlowMs = flowLastUpdate ? new Date() - new Date(flowLastUpdate) : null;
            const timeSinceFlowHours = timeSinceFlowMs ? timeSinceFlowMs / (1000 * 60 * 60) : null;

            // Status conditions
            const isTemperatureBad = cloudTemp !== undefined && cloudTemp > tempThresholdMax;
            const isFlowBad = timeSinceFlowHours !== null && !isNaN(noFlowCriticalTime) && timeSinceFlowHours >= noFlowCriticalTime;

            // Great: Device must be connected AND temperature is below threshold AND flow time is below critical threshold
            const isGreat = isConnected && !isTemperatureBad && !isFlowBad;

            // Warning: Device must be connected AND exactly one condition is bad (temp XOR flow)
            const isWarning = isConnected && ((isTemperatureBad || isFlowBad) && !(isTemperatureBad && isFlowBad));

            // Critical: Device is disconnected OR both temperature and flow are bad
            const isCritical = !isConnected || (isTemperatureBad && isFlowBad);

            // Compare normalized boolean values
            const shouldUpdateWarning = currentWarning !== isWarning;
            const shouldUpdateCritical = currentCritical !== isCritical;

            // Debug logging
            if (shouldUpdateWarning || shouldUpdateCritical) {
                logToConsole('Status update check:', {
                    deviceId: device.id,
                    currentWarning,
                    isWarning,
                    currentCritical,
                    isCritical,
                    shouldUpdateWarning,
                    shouldUpdateCritical,
                    temperature: cloudTemp,
                    tempThreshold: tempThresholdMax,
                    timeSinceFlowHours,
                    noFlowCriticalTime
                });
            }

            // Only update if the values are actually different and cooldown period has elapsed
            if (shouldUpdateWarning && canUpdateStatus(device.id, 'warning')) {
                logToConsole(`Auto-updating warning status for device ${device.id} from ${currentWarning} to ${isWarning}`);
                handleManualStatusUpdate(device.id, 'warning', isWarning);
            }

            if (shouldUpdateCritical && canUpdateStatus(device.id, 'critical')) {
                logToConsole(`Auto-updating critical status for device ${device.id} from ${currentCritical} to ${isCritical}`);
                handleManualStatusUpdate(device.id, 'critical', isCritical);
            }

            // Get sensor placement
            const sensorPlacement = properties.find(p => 
                p.name === 'sensorplacement'
            )?.last_value;

            // Calculate ice level based on temperature and sensor placement
            const tempF = cloudTemp !== undefined ? celsiusToFahrenheit(cloudTemp) : undefined;
            const isIceAboveSensor = tempF !== undefined && tempF <= 34;

            // If temperature is ≤ 34°F, ice is above the sensor placement
            // If temperature is > 34°F, ice is below the sensor placement
            const iceLevel = {
                isAboveSensor: isIceAboveSensor,
                sensorPlacement: sensorPlacement
            };

            return {
                isConnected,
                isGreat,
                isWarning,
                isCritical,
                cloudTemp,
                tempThresholdMax,
                cloudFlowRate: cloudFlowRate?.last_value,
                timeSinceFlowMs,
                timeSinceFlowHours,
                noFlowCriticalTime,
                flowLastUpdate,
                lastConnectedTime,
                iceLevel,
                sensorPlacement
            };
        }

        // Update the ice level display in the device card
        function getIceLevelText(status) {
            if (status.sensorPlacement === undefined || status.sensorPlacement === null) {
                return 'Sensor placement not set';
            }
            
            const placement = (status.sensorPlacement * 100).toFixed(0);
            if (status.cloudTemp === undefined || status.tempThresholdMax === undefined) {
                return 'Temperature data unavailable';
            }

            // Compare with threshold temperature
            return status.cloudTemp <= status.tempThresholdMax ? 
                `More than ${placement}% full` : 
                `Less than ${placement}% full`;
        }

        // Add this sorting function before displayDevices
        function sortProperties(properties) {
            // Define priority properties
            const priorityProps = ['cloudtemp', 'cloudflowrate'];
            
            return [...properties].sort((a, b) => {
                // Get indices in priority array (-1 if not found)
                const aIndex = priorityProps.indexOf(a.name);
                const bIndex = priorityProps.indexOf(b.name);
                
                // If both are priority properties, sort by priority array order
                if (aIndex !== -1 && bIndex !== -1) {
                    return aIndex - bIndex;
                }
                
                // If only a is priority property, it goes first
                if (aIndex !== -1) return -1;
                
                // If only b is priority property, it goes first
                if (bIndex !== -1) return 1;
                
                // For non-priority properties, maintain original order
                return 0;
            });
        }

        function displayDevices(devices) {
            // Clear existing timers before updating display
            clearTimeSinceFlowTimers();

            // Update device counts
            const activeDevices = devices.length;
            const deviceStatuses = devices.map(device => calculateDeviceStatus(device));
            const connectedDevices = deviceStatuses.filter(status => status.isConnected).length;
            const greatDevices = deviceStatuses.filter(status => status.isGreat).length;
            const warningDevices = deviceStatuses.filter(status => status.isWarning).length;
            const criticalDevices = deviceStatuses.filter(status => status.isCritical).length;
            
            document.getElementById('activeDevicesCount').textContent = activeDevices;
            document.getElementById('connectedDevicesCount').textContent = connectedDevices;
            document.getElementById('greatDevicesCount').textContent = greatDevices;
            document.getElementById('warningDevicesCount').textContent = warningDevices;
            document.getElementById('criticalDevicesCount').textContent = criticalDevices;

            if (!Array.isArray(devices) || devices.length === 0) {
                devicesContainer.innerHTML = `
                    <div class="col-span-full text-center py-8">
                        <div class="max-w-sm mx-auto">
                            <svg class="w-12 h-12 mx-auto text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M12 12h.01M12 12h.01M12 12h.01M12 12h.01M12 12h.01M12 12h.01M12 12h.01M12 12h.01M12 12h.01M12 12h.01M12 12h.01M12 12h.01M12 12h.01M12 12h.01M12 12h.01M12 12h.01M12 12h.01M12 12h.01" />
                            </svg>
                            <p class="mt-4 text-gray-500 text-lg">No devices found</p>
                            <p class="mt-2 text-gray-400 text-sm">Connect a device to get started</p>
                        </div>
                    </div>
                `;
                logToConsole('No devices found', 'warning');
                return;
            }

            // Log each device's data individually with more detail
            devices.forEach((device, idx) => {
                logToConsole(`Device ${idx + 1} (${device.name || device.id}):`);
                if (device.thing && device.thing.properties) {
                    logToConsole('Properties found:');
                    device.thing.properties.forEach(prop => {
                        logToConsole(`- ${prop.name}: ${prop.last_value} (${prop.type})`);
                    });
                } else {
                    logToConsole('No properties found for this device');
                }
            });

            devicesContainer.innerHTML = devices.map((device, index) => {
                const status = calculateDeviceStatus(device);

                return `
                <div class="device-card bg-white rounded-xl shadow-sm border border-gray-200 p-4 relative overflow-hidden">
                    <!-- Device Header -->
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="text-base font-bold text-gray-800 mb-0.5">
                                Device ${device.name.replace(/[^0-9]/g, '')}
                            </h3>
                            <p class="text-xs text-gray-600 flex items-center">
                                <svg class="w-3 h-3 mr-1 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                                ${device.thing?.properties?.find(p => p.name === 'location')?.last_value || 'Location not set'}
                            </p>
                        </div>
                        <div class="flex flex-col items-end">
                            <span class="connected-badge px-2 py-0.5 text-xs font-medium rounded-full ${status.isConnected ? 'bg-green-100 text-green-800 border border-green-200' : 'bg-red-100 text-red-800 border border-red-200'} shadow-sm">
                                <div class="flex items-center">
                                    <div class="w-1.5 h-1.5 rounded-full ${status.isConnected ? 'bg-green-500' : 'bg-red-500'} mr-1"></div>
                                    ${status.isConnected ? 'Connected' : 'Disconnected'}
                                </div>
                            </span>
                            ${!status.isConnected && status.lastConnectedTime ? `
                                <p class="text-[10px] text-red-600 mt-1">Last Connected:<br>${new Date(status.lastConnectedTime).toLocaleString()}</p>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2 mb-3">
                        <!-- Ice Level -->
                        <div class="property-card bg-gradient-to-br from-indigo-50 to-indigo-100 p-2.5 rounded-lg">
                            <div class="flex items-center mb-1">
                                <svg class="w-3 h-3 text-indigo-600 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                                </svg>
                                <p class="text-indigo-800 font-medium text-xs">Ice Level</p>
                            </div>
                            <p class="text-sm font-bold text-indigo-900 leading-tight">
                                ${getIceLevelText(status)}
                            </p>
                        </div>
                        
                        <!-- Temperature -->
                        <div class="property-card ${getTemperatureCardClass(status.cloudTemp, status.tempThresholdMax)} p-2.5 rounded-lg">
                            <div class="flex items-center mb-1">
                                <svg class="w-3 h-3 text-blue-600 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                                </svg>
                                <p class="text-blue-800 font-medium text-xs">Temperature</p>
                            </div>
                            <p class="text-sm font-bold text-blue-900 leading-tight">${formatTemperature(status.cloudTemp)}</p>
                            <p class="text-[10px] text-blue-600 mt-0.5 flex items-center">
                                <svg class="w-2.5 h-2.5 mr-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                                </svg>
                                Max: ${formatTemperature(status.tempThresholdMax)}
                            </p>
                        </div>
                        
                        <!-- Time Since Flow -->
                        <div class="property-card ${getFlowCardClass(status.timeSinceFlowHours, status.noFlowCriticalTime)} p-2.5 rounded-lg">
                            <div class="flex items-center mb-1">
                                <svg class="w-3 h-3 text-green-600 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                </svg>
                                <p class="text-green-800 font-medium text-xs">Time Since Flow</p>
                            </div>
                            <p class="text-sm font-bold text-green-900 leading-tight time-since-flow" 
                               data-start-time="${status.flowLastUpdate || ''}" 
                               data-critical-time="${status.noFlowCriticalTime || ''}"
                               data-device-id="${device.id}">
                                ${formatTimeDuration(status.timeSinceFlowMs)}
                            </p>
                            <div class="text-[10px] text-green-600 mt-0.5">
                                <div class="flex items-center">
                                    <svg class="w-2.5 h-2.5 mr-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    Critical: ${status.noFlowCriticalTime !== undefined ? status.noFlowCriticalTime + 'h' : 'N/A'}
                                </div>
                                <div class="flex items-center mt-0.5">
                                    <svg class="w-2.5 h-2.5 mr-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                    </svg>
                                    Last: ${status.flowLastUpdate ? new Date(status.flowLastUpdate).toLocaleString('en-US', {
                                        year: 'numeric',
                                        month: 'numeric',
                                        day: 'numeric',
                                        hour: 'numeric',
                                        minute: 'numeric',
                                        hour12: true
                                    }) : 'N/A'}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Status -->
                        <div class="property-card bg-gradient-to-br from-gray-50 to-gray-100 p-2.5 rounded-lg">
                            <div class="flex items-center mb-1">
                                <svg class="w-3 h-3 text-gray-600 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <p class="text-gray-800 font-medium text-xs">Status</p>
                            </div>
                            <p class="text-sm font-bold leading-tight ${
                                status.isGreat ? 'text-emerald-600' : 
                                status.isWarning ? 'text-yellow-600' :
                                status.isCritical ? 'text-red-600' :
                                'text-gray-900'
                            }">
                                ${
                                    status.isGreat ? 'Great' :
                                    status.isWarning ? 'Warning' :
                                    status.isCritical ? 'Critical' :
                                    'Not Available'
                                }
                            </p>
                            <div class="text-[10px] mt-0.5">
                                ${(() => {
                                    const issues = [];
                                    if (!status.isConnected) {
                                        issues.push('Disconnected');
                                    }
                                    if (status.cloudTemp > status.tempThresholdMax) {
                                        issues.push('Temperature High');
                                    }
                                    if (status.timeSinceFlowHours >= status.noFlowCriticalTime) {
                                        issues.push('No Flow');
                                    }
                                    return issues.length > 0 ? 
                                        `<div class="flex items-center text-red-600">
                                            <svg class="w-2.5 h-2.5 mr-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                            </svg>
                                            ${issues.join(', ')}
                                        </div>` : 
                                        status.isGreat ? '<div class="flex items-center text-emerald-600"><svg class="w-2.5 h-2.5 mr-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>All Systems Normal</div>' : '';
                                })()}
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-end border-t pt-2">
                        <button 
                            onclick="showDeviceDetails(${index})"
                            class="inline-flex items-center px-2 py-1 bg-blue-600 text-white text-xs font-medium rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-blue-500 transition-colors shadow-sm"
                        >
                            <span>More Details</span>
                            <svg class="w-3 h-3 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                            </svg>
                        </button>
                    </div>
                </div>
                `;
            }).join('');

            // Start timers for all time-since-flow elements
            document.querySelectorAll('.time-since-flow').forEach(element => {
                const startTime = element.dataset.startTime;
                if (startTime) {
                    logToConsole(`Starting flow timer for device ${element.dataset.deviceId} with start time ${startTime}`);
                }
                updateTimeSinceFlow(element, startTime);
            });

            // Add the modal container if it doesn't exist
            if (!document.getElementById('device-modal')) {
                const modalContainer = document.createElement('div');
                modalContainer.id = 'device-modal';
                modalContainer.className = 'fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50';
                modalContainer.style.position = 'fixed';
                modalContainer.style.top = '0';
                modalContainer.style.left = '0';
                modalContainer.style.right = '0';
                modalContainer.style.bottom = '0';
                modalContainer.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl p-6 m-4 max-w-4xl w-full max-h-[90vh] overflow-y-auto relative">
                        <div class="flex justify-between items-start mb-4">
                            <h2 id="modal-title" class="text-2xl font-bold text-gray-800"></h2>
                            <button onclick="hideDeviceDetails()" class="text-gray-500 hover:text-gray-700">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div id="modal-content"></div>
                    </div>
                `;
                document.body.appendChild(modalContainer);
            }

            // Add the active devices modal if it doesn't exist
            if (!document.getElementById('active-devices-modal')) {
                const activeDevicesModal = document.createElement('div');
                activeDevicesModal.id = 'active-devices-modal';
                activeDevicesModal.className = 'fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50';
                activeDevicesModal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl p-6 m-4 max-w-xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-gray-800">Active Devices</h2>
                            <button onclick="hideActiveDevices()" class="text-gray-500 hover:text-gray-700">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div id="active-devices-list" class="space-y-2"></div>
                    </div>
                `;
                document.body.appendChild(activeDevicesModal);
            }

            // Add the connected devices modal if it doesn't exist
            if (!document.getElementById('connected-devices-modal')) {
                const connectedDevicesModal = document.createElement('div');
                connectedDevicesModal.id = 'connected-devices-modal';
                connectedDevicesModal.className = 'fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50';
                connectedDevicesModal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl p-6 m-4 max-w-xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-gray-800">Connected Devices</h2>
                            <button onclick="hideConnectedDevices()" class="text-gray-500 hover:text-gray-700">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div id="connected-devices-list" class="space-y-2"></div>
                    </div>
                `;
                document.body.appendChild(connectedDevicesModal);
            }

            // Add the great devices modal if it doesn't exist
            if (!document.getElementById('great-devices-modal')) {
                const greatDevicesModal = document.createElement('div');
                greatDevicesModal.id = 'great-devices-modal';
                greatDevicesModal.className = 'fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50';
                greatDevicesModal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl p-6 m-4 max-w-xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-gray-800">Devices in Great Condition</h2>
                            <button onclick="hideGreatDevices()" class="text-gray-500 hover:text-gray-700">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div id="great-devices-list" class="space-y-2"></div>
                    </div>
                `;
                document.body.appendChild(greatDevicesModal);
            }

            // Add the warning devices modal if it doesn't exist
            if (!document.getElementById('warning-devices-modal')) {
                const warningDevicesModal = document.createElement('div');
                warningDevicesModal.id = 'warning-devices-modal';
                warningDevicesModal.className = 'fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50';
                warningDevicesModal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl p-6 m-4 max-w-xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-gray-800">Devices with Warnings</h2>
                            <button onclick="hideWarningDevices()" class="text-gray-500 hover:text-gray-700">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div id="warning-devices-list" class="space-y-2"></div>
                    </div>
                `;
                document.body.appendChild(warningDevicesModal);
            }

            // Add the critical devices modal if it doesn't exist
            if (!document.getElementById('critical-devices-modal')) {
                const criticalDevicesModal = document.createElement('div');
                criticalDevicesModal.id = 'critical-devices-modal';
                criticalDevicesModal.className = 'fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50';
                criticalDevicesModal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl p-6 m-4 max-w-xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-gray-800">Devices in Critical State</h2>
                            <button onclick="hideCriticalDevices()" class="text-gray-500 hover:text-gray-700">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div id="critical-devices-list" class="space-y-2"></div>
                    </div>
                `;
                document.body.appendChild(criticalDevicesModal);
            }
        }

        function showDeviceDetails(deviceIndex) {
            const device = window.lastDevicesData[deviceIndex];
            const modal = document.getElementById('device-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalContent = document.getElementById('modal-content');
            const status = calculateDeviceStatus(device);

            modalTitle.textContent = device.name || 'Device Details';
            
            // Generate the detailed view with improved layout
            modalContent.innerHTML = `
                <div class="space-y-6">
                    <!-- Device Info -->
                    <div class="bg-white rounded-lg shadow-lg border border-gray-100 p-4 mb-6">
                        <div class="flex items-center space-x-2 mb-4">
                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" />
                            </svg>
                            <h3 class="text-xl font-semibold text-gray-900">Device Information</h3>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <!-- Basic Info Column -->
                            <div class="space-y-3">
                                <div>
                                    <p class="text-xs font-medium text-gray-500">Device Name</p>
                                    <p class="text-sm font-semibold text-gray-900">Device ${device.name.replace(/[^0-9]/g, '')}</p>
                                </div>
                                <div>
                                    <p class="text-xs font-medium text-gray-500">Location</p>
                                    <p class="text-sm font-semibold text-gray-900">${device.thing?.properties?.find(p => p.name === 'location')?.last_value || 'Location not set'}</p>
                                </div>
                                <div>
                                    <p class="text-xs font-medium text-gray-500">Ice Machine PN/SN</p>
                                    <p class="text-sm font-semibold text-gray-900">${device.thing?.properties?.find(p => p.name === 'Icemachine_PN_SN')?.last_value || 'N/A'}</p>
                                </div>
                            </div>

                            <!-- Status Column -->
                            <div class="space-y-3">
                                <div>
                                    <p class="text-xs font-medium text-gray-500">Connection Status</p>
                                    <div class="flex items-center mt-1">
                                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${
                                            status.isConnected ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                                        }">
                                            <span class="w-2 h-2 mr-1 rounded-full ${
                                                status.isConnected ? 'bg-green-400' : 'bg-red-400'
                                            }"></span>
                                            ${status.isConnected ? 'Connected' : 'Disconnected'}
                                        </span>
                                    </div>
                                    ${!status.isConnected && status.lastConnectedTime ? `
                                        <p class="text-xs text-red-600 mt-1">Last seen: ${new Date(status.lastConnectedTime).toLocaleString('en-US', {
                                            dateStyle: 'medium',
                                            timeStyle: 'short'
                                        })}</p>
                                    ` : ''}
                                </div>
                                <div>
                                    <p class="text-xs font-medium text-gray-500">Device Status</p>
                                    <span class="inline-flex items-center px-2 py-0.5 mt-1 rounded-full text-xs font-medium ${
                                        status.isGreat ? 'bg-emerald-100 text-emerald-800' :
                                        status.isWarning ? 'bg-yellow-100 text-yellow-800' :
                                        'bg-red-100 text-red-800'
                                    }">
                                        ${status.isGreat ? 'Great' : status.isWarning ? 'Warning' : 'Critical'}
                                    </span>
                                </div>
                                <div>
                                    <p class="text-xs font-medium text-gray-500">Device ID</p>
                                    <p class="text-xs font-mono bg-gray-50 px-2 py-1 rounded border border-gray-200 select-all">${device.id}</p>
                                </div>
                            </div>

                            <!-- Maintenance Column -->
                            <div class="col-span-2 md:col-span-1 space-y-3">
                                <div class="bg-gray-50 p-3 rounded-lg">
                                    <p class="text-xs font-medium text-gray-500">Last Maintenance</p>
                                    <p class="text-sm font-semibold text-gray-900 mt-1">${device.thing?.properties?.find(p => p.name === 'Last_Maintenance')?.last_value || 'Not recorded'}</p>
                                    ${(() => {
                                        const lastMaintenance = device.thing?.properties?.find(p => p.name === 'Last_Maintenance')?.last_value;
                                        if (lastMaintenance) {
                                            const [month, day, year] = lastMaintenance.split('/').map(num => parseInt(num));
                                            const maintenanceDate = new Date(year, month - 1, day); // month is 0-based in JS
                                            const now = new Date();
                                            
                                            // Calculate total months difference
                                            const monthsDiff = (now.getFullYear() - maintenanceDate.getFullYear()) * 12 + 
                                                                 (now.getMonth() - maintenanceDate.getMonth());
                                            
                                            // Calculate remaining days
                                            const tempDate = new Date(now.getFullYear(), now.getMonth(), maintenanceDate.getDate());
                                            const daysDiff = Math.floor((now - tempDate) / (1000 * 60 * 60 * 24));
                                            
                                            return `
                                                <div class="flex items-center mt-2 ${monthsDiff >= 6 ? 'bg-red-50 text-red-700 p-1.5 rounded' : ''}">
                                                    ${monthsDiff >= 6 ? '<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>' : ''}
                                                    <span class="text-xs ${monthsDiff >= 6 ? 'font-medium' : 'text-gray-600'}">
                                                        ${monthsDiff > 0 ? `${monthsDiff} month${monthsDiff > 1 ? 's' : ''}` : ''}
                                                        ${daysDiff > 0 ? `${monthsDiff > 0 ? ' and ' : ''}${daysDiff} day${daysDiff > 1 ? 's' : ''}` : ''}
                                                        since last maintenance
                                                        ${monthsDiff >= 6 ? ' (Due)' : ''}
                                                    </span>
                                                </div>
                                            `;
                                        }
                                        return '';
                                    })()}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recommendations Section -->
                    <div class="bg-white rounded-lg shadow-lg border border-gray-100 p-4 mb-6">
                        <div class="flex items-center space-x-2 mb-4">
                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                            </svg>
                            <h3 class="text-xl font-semibold text-gray-900">Recommendations</h3>
                        </div>
                        <div class="space-y-3">
                            ${(() => {
                                const recommendations = [];
                                
                                // Connection Status Recommendations
                                if (!status.isConnected) {
                                    recommendations.push({
                                        type: 'error',
                                        title: 'Connection Lost',
                                        message: 'Device is currently offline. Click below to view troubleshooting steps:',
                                        action: `<div class="space-y-2 mt-1">
                                            <details class="group bg-red-50 rounded-lg">
                                                <summary class="flex items-center justify-between p-2 font-medium cursor-pointer list-none hover:bg-red-100 rounded-lg transition-colors">
                                                    <div class="flex items-center space-x-2">
                                                        <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-red-100 text-red-800 text-xs font-bold">1</span>
                                                        <span>Verify Ice Machine Operation</span>
                                                    </div>
                                                    <svg class="w-5 h-5 text-red-700 transform group-open:rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                                    </svg>
                                                </summary>
                                                <div class="p-2 pt-0 text-red-700">
                                                    <ul class="mt-0.5 ml-4 list-disc text-sm space-y-0.5">
                                                        <li>Check if the ice machine is powered on and running</li>
                                                        <li>If the machine is off, turn it on and wait for it to start</li>
                                                    </ul>
                                                </div>
                                            </details>

                                            <details class="group bg-red-50 rounded-lg">
                                                <summary class="flex items-center justify-between p-2 font-medium cursor-pointer list-none hover:bg-red-100 rounded-lg transition-colors">
                                                    <div class="flex items-center space-x-2">
                                                        <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-red-100 text-red-800 text-xs font-bold">2</span>
                                                        <span>Check Power Supply</span>
                                                    </div>
                                                    <svg class="w-5 h-5 text-red-700 transform group-open:rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                                    </svg>
                                                </summary>
                                                <div class="p-2 pt-0 text-red-700">
                                                    <ul class="mt-0.5 ml-4 list-disc text-sm space-y-0.5">
                                                        <li>Ensure the Ice-Alert device is receiving power:
                                                            <ul class="ml-4 mt-0.5 list-circle space-y-0.5">
                                                                <li>Inspect the power cable to confirm it is securely connected</li>
                                                                <li>Check the wall socket where the power adapter is plugged in</li>
                                                                <li>Look for the LED indicator on the power supply—it should be lit</li>
                                                                <li>Try plugging the power supply into a different socket if needed</li>
                                                            </ul>
                                                        </li>
                                                    </ul>
                                                </div>
                                            </details>

                                            <details class="group bg-red-50 rounded-lg">
                                                <summary class="flex items-center justify-between p-2 font-medium cursor-pointer list-none hover:bg-red-100 rounded-lg transition-colors">
                                                    <div class="flex items-center space-x-2">
                                                        <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-red-100 text-red-800 text-xs font-bold">3</span>
                                                        <span>Verify WiFi Connection</span>
                                                    </div>
                                                    <svg class="w-5 h-5 text-red-700 transform group-open:rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                                    </svg>
                                                </summary>
                                                <div class="p-2 pt-0 text-red-700">
                                                    <ul class="mt-0.5 ml-4 list-disc text-sm space-y-0.5">
                                                        <li>Confirm network connectivity:
                                                            <ul class="ml-4 mt-0.5 list-circle space-y-0.5">
                                                                <li>Check if other devices on the same WiFi network are working</li>
                                                                <li>If WiFi is down, restart the router and wait for network recovery</li>
                                                                <li>Ensure the device is within range of the WiFi router</li>
                                                            </ul>
                                                        </li>
                                                    </ul>
                                                </div>
                                            </details>

                                            <details class="group bg-red-50 rounded-lg">
                                                <summary class="flex items-center justify-between p-2 font-medium cursor-pointer list-none hover:bg-red-100 rounded-lg transition-colors">
                                                    <div class="flex items-center space-x-2">
                                                        <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-red-100 text-red-800 text-xs font-bold">4</span>
                                                        <span>Restart Device</span>
                                                    </div>
                                                    <svg class="w-5 h-5 text-red-700 transform group-open:rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                                    </svg>
                                                </summary>
                                                <div class="p-2 pt-0 text-red-700">
                                                    <ul class="mt-0.5 ml-4 list-disc text-sm space-y-0.5">
                                                        <li>Perform a manual reboot:
                                                            <ul class="ml-4 mt-0.5 list-circle space-y-0.5">
                                                                <li>Unplug the power supply from the wall socket</li>
                                                                <li>Wait for 10 seconds</li>
                                                                <li>Plug the power supply back in</li>
                                                                <li>Allow the device to restart and monitor reconnection</li>
                                                            </ul>
                                                        </li>
                                                    </ul>
                                                </div>
                                            </details>

                                            <details class="group bg-red-50 rounded-lg">
                                                <summary class="flex items-center justify-between p-2 font-medium cursor-pointer list-none hover:bg-red-100 rounded-lg transition-colors">
                                                    <div class="flex items-center space-x-2">
                                                        <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-red-100 text-red-800 text-xs font-bold">5</span>
                                                        <span>Contact Support</span>
                                                    </div>
                                                    <svg class="w-5 h-5 text-red-700 transform group-open:rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                                    </svg>
                                                </summary>
                                                <div class="p-2 pt-0 text-red-700">
                                                    <ul class="mt-0.5 ml-4 list-disc text-sm space-y-0.5">
                                                        <li>If all previous steps fail:
                                                            <ul class="ml-4 mt-0.5 list-circle space-y-0.5">
                                                                <li>Support is for Ice-Alert device issues only</li>
                                                                <li>For ice machine issues, refer to machine troubleshooting guide</li>
                                                            </ul>
                                                        </li>
                                                        <li class="mt-0.5">Contact your maintenance team</li>
                                                    </ul>
                                                </div>
                                            </details>
                                        </div>`
                                    });
                                }

                                // Temperature Recommendations
                                if (status.cloudTemp > status.tempThresholdMax) {
                                    recommendations.push({
                                        type: 'warning',
                                        title: 'High Temperature Detected',
                                        message: 'High temperature likely means there is no ice at the sensor level. Follow these steps in order:',
                                        action: `<div class="space-y-2 mt-1">
                                            <details class="group bg-yellow-50 rounded-lg">
                                                <summary class="flex items-center justify-between p-2 font-medium cursor-pointer list-none hover:bg-yellow-100 rounded-lg transition-colors">
                                                    <div class="flex items-center space-x-2">
                                                        <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-yellow-100 text-yellow-800 text-xs font-bold">1</span>
                                                        <span>Check Ice Usage</span>
                                                    </div>
                                                    <svg class="w-5 h-5 text-yellow-700 transform group-open:rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                                    </svg>
                                                </summary>
                                                <div class="p-2 pt-0 text-yellow-700">
                                                    <div class="space-y-2">
                                                        <p class="text-sm">Has ice been used at a higher rate than usual?</p>
                                                        <ul class="mt-0.5 ml-4 list-disc text-sm space-y-0.5">
                                                            <li>If yes, the machine may not have had enough time to produce and replenish ice at the sensor level</li>
                                                            <li>Allow the ice machine to continue running and monitor if the ice level recovers</li>
                                                            <li>Check usage patterns to determine if demand has recently increased beyond the machine's capacity</li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </details>

                                            <details class="group bg-yellow-50 rounded-lg">
                                                <summary class="flex items-center justify-between p-2 font-medium cursor-pointer list-none hover:bg-yellow-100 rounded-lg transition-colors">
                                                    <div class="flex items-center space-x-2">
                                                        <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-yellow-100 text-yellow-800 text-xs font-bold">2</span>
                                                        <span>Inspect Ice Levels Manually</span>
                                                    </div>
                                                    <svg class="w-5 h-5 text-yellow-700 transform group-open:rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                                    </svg>
                                                </summary>
                                                <div class="p-2 pt-0 text-yellow-700">
                                                    <ul class="mt-0.5 ml-4 list-disc text-sm space-y-0.5">
                                                        <li>Open the ice machine bin and check if there is ice at the sensor level</li>
                                                        <li>If there is no ice at the sensor level, proceed to Step 3</li>
                                                        <li>If there is ice at the sensor level, but the system still detects high temperature, proceed to Step 4</li>
                                                    </ul>
                                                </div>
                                            </details>

                                            <details class="group bg-yellow-50 rounded-lg">
                                                <summary class="flex items-center justify-between p-2 font-medium cursor-pointer list-none hover:bg-yellow-100 rounded-lg transition-colors">
                                                    <div class="flex items-center space-x-2">
                                                        <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-yellow-100 text-yellow-800 text-xs font-bold">3</span>
                                                        <span>If No Ice is Present</span>
                                                    </div>
                                                    <svg class="w-5 h-5 text-yellow-700 transform group-open:rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                                    </svg>
                                                </summary>
                                                <div class="p-2 pt-0 text-yellow-700">
                                                    <div class="space-y-2">
                                                        <div>
                                                            <p class="font-medium">🔹 Machine Operation:</p>
                                                            <ul class="mt-0.5 ml-4 list-disc text-sm space-y-0.5">
                                                                <li>Verify the ice machine is powered on and operating</li>
                                                                <li>If the machine is off, turn it on and allow it to cycle</li>
                                                                <li>Check if the ice machine is producing ice</li>
                                                                <li>Listen for the sound of water filling and freezing</li>
                                                            </ul>
                                                        </div>
                                                        <div>
                                                            <p class="font-medium">🔹 Environmental Checks:</p>
                                                            <ul class="mt-0.5 ml-4 list-disc text-sm space-y-0.5">
                                                                <li>Ensure proper airflow and ventilation</li>
                                                                <li>Check for blocked vents that could cause overheating</li>
                                                                <li>Inspect the water supply and pressure</li>
                                                                <li>Look for clogged filters that might restrict water flow</li>
                                                            </ul>
                                                        </div>
                                                        <div>
                                                            <p class="font-medium">🔹 Monitor Progress:</p>
                                                            <ul class="mt-0.5 ml-4 list-disc text-sm space-y-0.5">
                                                                <li>Watch the next production cycle</li>
                                                                <li>If ice production resumes, the issue may have been temporary</li>
                                                                <li>If ice is still not being produced, maintenance may be required</li>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </div>
                                            </details>

                                            <details class="group bg-yellow-50 rounded-lg">
                                                <summary class="flex items-center justify-between p-2 font-medium cursor-pointer list-none hover:bg-yellow-100 rounded-lg transition-colors">
                                                    <div class="flex items-center space-x-2">
                                                        <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-yellow-100 text-yellow-800 text-xs font-bold">4</span>
                                                        <span>If Ice is Present but Temperature High</span>
                                                    </div>
                                                    <svg class="w-5 h-5 text-yellow-700 transform group-open:rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                                    </svg>
                                                </summary>
                                                <div class="p-2 pt-0 text-yellow-700">
                                                    <div class="space-y-2">
                                                        <p class="text-sm">This suggests a false high-temperature reading due to an incorrect threshold setting.</p>
                                                        <div>
                                                            <p class="font-medium">🔹 Adjust Temperature Threshold:</p>
                                                            <ul class="mt-0.5 ml-4 list-disc text-sm space-y-0.5">
                                                                <li>Navigate to the Ice-Alert Properties Section in the system settings</li>
                                                                <li>Locate the Temperature Threshold setting</li>
                                                                <li>Increase the threshold slightly to reduce false alerts</li>
                                                                <li>Save the settings and monitor to ensure proper functionality</li>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </div>
                                            </details>

                                            <details class="group bg-yellow-50 rounded-lg">
                                                <summary class="flex items-center justify-between p-2 font-medium cursor-pointer list-none hover:bg-yellow-100 rounded-lg transition-colors">
                                                    <div class="flex items-center space-x-2">
                                                        <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-yellow-100 text-yellow-800 text-xs font-bold">5</span>
                                                        <span>If Issue Persists</span>
                                                    </div>
                                                    <svg class="w-5 h-5 text-yellow-700 transform group-open:rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                                    </svg>
                                                </summary>
                                                <div class="p-2 pt-0 text-yellow-700">
                                                    <div class="space-y-2">
                                                        <div>
                                                            <p class="font-medium">🔹 Full Machine Inspection:</p>
                                                            <ul class="mt-0.5 ml-4 list-disc text-sm space-y-0.5">
                                                                <li>Clean the machine thoroughly, including:</li>
                                                                <ul class="ml-4 list-circle">
                                                                    <li>Sensors and vents</li>
                                                                    <li>Ice bin and production area</li>
                                                                    <li>Ultrasonic sensor position and clearance</li>
                                                                </ul>
                                                            </ul>
                                                        </div>
                                                        <div>
                                                            <p class="font-medium">🔹 Check for Mechanical Issues:</p>
                                                            <ul class="mt-0.5 ml-4 list-disc text-sm space-y-0.5">
                                                                <li>Inspect for problems with:</li>
                                                                <ul class="ml-4 list-circle">
                                                                    <li>Compressor operation</li>
                                                                    <li>Thermostat function</li>
                                                                    <li>Internal components</li>
                                                                </ul>
                                                            </ul>
                                                        </div>
                                                        <div>
                                                            <p class="font-medium">🔹 Next Steps:</p>
                                                            <ul class="mt-0.5 ml-4 list-disc text-sm space-y-0.5">
                                                                <li>If troubleshooting doesn't resolve the issue:</li>
                                                                <ul class="ml-4 list-circle">
                                                                    <li>Schedule a maintenance inspection</li>
                                                                    <li>Contact your maintenance team</li>
                                                                </ul>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </div>
                                            </details>
                                        </div>`
                                    });
                                }

                                // Maintenance Recommendations
                                const lastMaintenance = device.thing?.properties?.find(p => p.name === 'Last_Maintenance')?.last_value;
                                if (lastMaintenance) {
                                    const maintenanceDate = new Date(lastMaintenance);
                                    const now = new Date();
                                    const diffDays = Math.ceil(Math.abs(now - maintenanceDate) / (1000 * 60 * 60 * 24));
                                    
                                    if (diffDays > 180) {
                                        recommendations.push({
                                            type: 'warning',
                                            title: 'Maintenance Overdue',
                                            message: 'Regular maintenance is overdue by ' + (diffDays - 180) + ' days.',
                                            action: 'Schedule maintenance service as soon as possible to ensure optimal performance.'
                                        });
                                    } else if (diffDays > 150) {
                                        recommendations.push({
                                            type: 'info',
                                            title: 'Maintenance Due Soon',
                                            message: 'Regular maintenance will be due in ' + (180 - diffDays) + ' days.',
                                            action: 'Plan to schedule maintenance service in the coming weeks.'
                                        });
                                    }
                                }

                                if (recommendations.length === 0 && status.isGreat) {
                                    recommendations.push({
                                        type: 'success',
                                        title: 'System Operating Normally',
                                        message: 'All parameters are within normal ranges.',
                                        action: 'Continue regular monitoring and maintenance schedule.'
                                    });
                                }

                                // No Flow Recommendations
                                if (status.timeSinceFlowHours >= status.noFlowCriticalTime) {
                                    recommendations.push({
                                        type: 'warning',
                                        title: 'No Flow Detected',
                                        message: 'No water flow has been detected for an extended period. Follow these steps to troubleshoot:',
                                        action: `<div class="space-y-2 mt-1">
                                            <details class="group bg-yellow-50 rounded-lg">
                                                <summary class="flex items-center justify-between p-2 font-medium cursor-pointer list-none hover:bg-yellow-100 rounded-lg transition-colors">
                                                    <div class="flex items-center space-x-2">
                                                        <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-yellow-100 text-yellow-800 text-xs font-bold">1</span>
                                                        <span>Check Water Supply</span>
                                                    </div>
                                                    <svg class="w-5 h-5 text-yellow-700 transform group-open:rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                                    </svg>
                                                </summary>
                                                <div class="p-2 pt-0 text-yellow-700">
                                                    <div class="space-y-2">
                                                        <div>
                                                            <p class="font-medium">🔹 Verify Water Source:</p>
                                                            <ul class="mt-0.5 ml-4 list-disc text-sm space-y-0.5">
                                                                <li>Check if the main water supply valve is open</li>
                                                                <li>Verify water pressure is adequate</li>
                                                                <li>Look for any visible leaks in supply lines</li>
                                                                <li>Ensure no maintenance work is affecting water supply</li>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </div>
                                            </details>

                                            <details class="group bg-yellow-50 rounded-lg">
                                                <summary class="flex items-center justify-between p-2 font-medium cursor-pointer list-none hover:bg-yellow-100 rounded-lg transition-colors">
                                                    <div class="flex items-center space-x-2">
                                                        <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-yellow-100 text-yellow-800 text-xs font-bold">2</span>
                                                        <span>Inspect for Blockages</span>
                                                    </div>
                                                    <svg class="w-5 h-5 text-yellow-700 transform group-open:rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                                    </svg>
                                                </summary>
                                                <div class="p-2 pt-0 text-yellow-700">
                                                    <div class="space-y-2">
                                                        <div>
                                                            <p class="font-medium">🔹 Check Common Blockage Points:</p>
                                                            <ul class="mt-0.5 ml-4 list-disc text-sm space-y-0.5">
                                                                <li>Inspect and clean the water filter if necessary</li>
                                                                <li>Check for kinked or bent water lines</li>
                                                                <li>Look for mineral buildup in water lines</li>
                                                                <li>Verify the water inlet valve is functioning</li>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </div>
                                            </details>

                                            <details class="group bg-yellow-50 rounded-lg">
                                                <summary class="flex items-center justify-between p-2 font-medium cursor-pointer list-none hover:bg-yellow-100 rounded-lg transition-colors">
                                                    <div class="flex items-center space-x-2">
                                                        <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-yellow-100 text-yellow-800 text-xs font-bold">3</span>
                                                        <span>Test Water Flow</span>
                                                    </div>
                                                    <svg class="w-5 h-5 text-yellow-700 transform group-open:rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                                    </svg>
                                                </summary>
                                                <div class="p-2 pt-0 text-yellow-700">
                                                    <div class="space-y-2">
                                                        <div>
                                                            <p class="font-medium">🔹 Flow Testing Steps:</p>
                                                            <ul class="mt-0.5 ml-4 list-disc text-sm space-y-0.5">
                                                                <li>Initiate a manual water fill cycle if possible</li>
                                                                <li>Listen for water flow sounds</li>
                                                                <li>Check if water is reaching the ice making unit</li>
                                                                <li>Measure water pressure if a gauge is available</li>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </div>
                                            </details>

                                            <details class="group bg-yellow-50 rounded-lg">
                                                <summary class="flex items-center justify-between p-2 font-medium cursor-pointer list-none hover:bg-yellow-100 rounded-lg transition-colors">
                                                    <div class="flex items-center space-x-2">
                                                        <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-yellow-100 text-yellow-800 text-xs font-bold">4</span>
                                                        <span>Reset and Monitor</span>
                                                    </div>
                                                    <svg class="w-5 h-5 text-yellow-700 transform group-open:rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                                    </svg>
                                                </summary>
                                                <div class="p-2 pt-0 text-yellow-700">
                                                    <div class="space-y-2">
                                                        <div>
                                                            <p class="font-medium">🔹 Reset Procedure:</p>
                                                            <ul class="mt-0.5 ml-4 list-disc text-sm space-y-0.5">
                                                                <li>Power cycle the ice machine:</li>
                                                                <ul class="ml-4 list-circle">
                                                                    <li>Turn off the machine</li>
                                                                    <li>Wait for 5 minutes</li>
                                                                    <li>Turn the machine back on</li>
                                                                </ul>
                                                                <li>Monitor for normal operation</li>
                                                                <li>Check if water flow resumes</li>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </div>
                                            </details>

                                            <details class="group bg-yellow-50 rounded-lg">
                                                <summary class="flex items-center justify-between p-2 font-medium cursor-pointer list-none hover:bg-yellow-100 rounded-lg transition-colors">
                                                    <div class="flex items-center space-x-2">
                                                        <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-yellow-100 text-yellow-800 text-xs font-bold">5</span>
                                                        <span>If Issue Persists</span>
                                                    </div>
                                                    <svg class="w-5 h-5 text-yellow-700 transform group-open:rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                                    </svg>
                                                </summary>
                                                <div class="p-2 pt-0 text-yellow-700">
                                                    <div class="space-y-2">
                                                        <div>
                                                            <p class="font-medium">🔹 Next Steps:</p>
                                                            <ul class="mt-0.5 ml-4 list-disc text-sm space-y-0.5">
                                                                <li>If all troubleshooting steps fail:</li>
                                                                <ul class="ml-4 list-circle">
                                                                    <li>Contact your maintenance team</li>
                                                                    <li>Schedule a professional inspection</li>
                                                                    <li>Document all steps taken for maintenance reference</li>
                                                                </ul>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </div>
                                            </details>
                                        </div>`
                                    });
                                }

                                return recommendations.length > 0 ? recommendations.map(rec => `
                                    <div class="flex items-start p-3 rounded-lg ${
                                        rec.type === 'error' ? 'bg-red-50 border border-red-200' :
                                        rec.type === 'warning' ? 'bg-yellow-50 border border-yellow-200' :
                                        rec.type === 'info' ? 'bg-blue-50 border border-blue-200' :
                                        'bg-emerald-50 border border-emerald-200'
                                    }">
                                        <div class="flex-shrink-0">
                                            <svg class="w-5 h-5 ${
                                                rec.type === 'error' ? 'text-red-600' :
                                                rec.type === 'warning' ? 'text-yellow-600' :
                                                rec.type === 'info' ? 'text-blue-600' :
                                                'text-emerald-600'
                                            }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                ${rec.type === 'error' ? 
                                                    '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />' :
                                                    rec.type === 'warning' ?
                                                    '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />' :
                                                    rec.type === 'info' ?
                                                    '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />' :
                                                    '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />'
                                                }
                                            </svg>
                                        </div>
                                        <div class="ml-3 flex-1">
                                            <h5 class="text-sm font-medium ${
                                                rec.type === 'error' ? 'text-red-800' :
                                                rec.type === 'warning' ? 'text-yellow-800' :
                                                rec.type === 'info' ? 'text-blue-800' :
                                                'text-emerald-800'
                                            }">${rec.title}</h5>
                                            <p class="mt-1 text-xs ${
                                                rec.type === 'error' ? 'text-red-700' :
                                                rec.type === 'warning' ? 'text-yellow-700' :
                                                rec.type === 'info' ? 'text-blue-700' :
                                                'text-emerald-700'
                                            }">${rec.message}</p>
                                            <p class="mt-1 text-xs font-medium ${
                                                rec.type === 'error' ? 'text-red-900' :
                                                rec.type === 'warning' ? 'text-yellow-900' :
                                                rec.type === 'info' ? 'text-blue-900' :
                                                'text-emerald-900'
                                            }">Recommended Action: ${rec.action}</p>
                                        </div>
                                    </div>
                                `).join('') : '<p class="text-gray-500 text-sm">No recommendations at this time.</p>';
                            })()}
                        </div>
                    </div>

                    <!-- Time Series Graphs Section -->
                    <div class="bg-white rounded-lg shadow-lg border border-gray-100 p-4 mb-6">
                        <div class="flex items-center space-x-2 mb-4">
                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                            </svg>
                            <h3 class="text-xl font-semibold text-gray-900">Time Series Data</h3>
                        </div>
                        
                        <!-- Temperature & Ice Level Graph -->
                        <div class="mb-6">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="text-sm font-medium text-gray-700">Temperature & Ice Level</h4>
                                <div class="flex items-center space-x-4 mb-4">
                                <div class="time-range-selector" id="temp-time-range">
                                        <button class="time-range-button active" data-days="0" onclick="toggleTempGraph(window.currentDeviceIndex || 0, 0)">Today</button>
                                        <button class="time-range-button" data-days="1" onclick="toggleTempGraph(window.currentDeviceIndex || 0, 1)">Yesterday</button>
                                        <button class="time-range-button" data-days="2" onclick="toggleTempGraph(window.currentDeviceIndex || 0, 2)">2 Days Ago</button>
                                    </div>
                                    <div class="flex items-center space-x-4">
                                        <label class="flex items-center space-x-2 cursor-pointer">
                                            <input 
                                                type="checkbox" 
                                                id="temp-line-toggle" 
                                                class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500"
                                                onclick="toggleTempLine()"
                                                checked
                                            >
                                            <span class="text-sm text-gray-700">Show Temperature</span>
                                        </label>
                                        <label class="flex items-center space-x-2 cursor-pointer">
                                            <input 
                                                type="checkbox" 
                                                id="ice-level-toggle" 
                                                class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500"
                                                onclick="toggleIceLevel()"
                                                checked
                                            >
                                            <span class="text-sm text-gray-700">Show Ice Level</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <!-- Add Statistics Summary Box -->
                            <div id="tempStats" class="grid grid-cols-1 gap-4 mb-4 p-4 bg-gray-50 rounded-lg">
                                <!-- Info Message -->
                                <div class="col-span-full mb-2">
                                    <p class="text-xs text-gray-600 italic">
                                        Note: Statistics are only available when a single time period is selected.
                                        Multi-day selections will disable these statistics.
                                    </p>
                                </div>
                                
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="stat-box">
                                        <h5 class="text-xs font-medium text-gray-500">
                                            Daily Range
                                            <span class="ml-1 cursor-help group relative">
                                                <svg class="w-3 h-3 inline text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                                </svg>
                                                <span class="hidden group-hover:block absolute bottom-full left-0 w-48 p-2 bg-gray-800 text-xs text-white rounded shadow-lg mb-2">
                                                    Shows min-max temperature range from 12:01 AM to 11:59 PM. Calculated using available data for the selected day.
                                                </span>
                                            </span>
                                        </h5>
                                    <p class="text-sm font-bold text-gray-900" id="tempRange">-</p>
                                </div>
                                <div class="stat-box">
                                        <h5 class="text-xs font-medium text-gray-500">Daily Average</h5>
                                    <p class="text-sm font-bold text-gray-900" id="tempAvg">-</p>
                                </div>
                                <div class="stat-box">
                                    <h5 class="text-xs font-medium text-gray-500">Std Deviation</h5>
                                    <p class="text-sm font-bold text-gray-900" id="tempStdDev">-</p>
                                </div>
                                <div class="stat-box">
                                    <h5 class="text-xs font-medium text-gray-500">Mode</h5>
                                    <p class="text-sm font-bold text-gray-900" id="tempMode">-</p>
                                    </div>
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas id="tempChart"></canvas>
                            </div>
                        </div>

                        <!-- Status Graph -->
                        <div class="mb-6">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="text-sm font-medium text-gray-700">Device Status</h4>
                                <div class="time-range-selector" id="status-time-range">
                                    <button class="time-range-button active" data-days="0" onclick="updateStatusGraph(${deviceIndex}, 0)">Today</button>
                                    <button class="time-range-button" data-days="1" onclick="updateStatusGraph(${deviceIndex}, 1)">Yesterday</button>
                                    <button class="time-range-button" data-days="2" onclick="updateStatusGraph(${deviceIndex}, 2)">2 Days Ago</button>
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas id="statusChart"></canvas>
                            </div>
                        </div>

                        <!-- Flow Time Graph -->
                        <div class="mb-6">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="text-sm font-medium text-gray-700">Flow Rate</h4>
                                <div class="time-range-selector" id="flow-time-range">
                                    <button class="time-range-button active" data-days="0" onclick="updateFlowGraph(${deviceIndex}, 0)">Today</button>
                                    <button class="time-range-button" data-days="1" onclick="updateFlowGraph(${deviceIndex}, 1)">Yesterday</button>
                                    <button class="time-range-button" data-days="2" onclick="updateFlowGraph(${deviceIndex}, 2)">2 Days Ago</button>
                                </div>
                            </div>
                            <!-- Add Flow Rate Statistics Summary Box -->
                            <div id="flowStats" class="grid grid-cols-1 gap-4 mb-4 p-4 bg-gray-50 rounded-lg">
                                <!-- Info Message -->
                                <div class="col-span-full mb-2">
                                    <p class="text-xs text-gray-600 italic">
                                        Note: Statistics are only available when a single time period is selected.
                                        Multi-day selections will disable these statistics.
                                    </p>
                                </div>
                                
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div class="stat-box">
                                        <h5 class="text-xs font-medium text-gray-500">
                                            Daily Range
                                            <span class="ml-1 cursor-help group relative">
                                                <svg class="w-3 h-3 inline text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                                </svg>
                                                <span class="hidden group-hover:block absolute bottom-full left-0 w-48 p-2 bg-gray-800 text-xs text-white rounded shadow-lg mb-2">
                                                    Shows min-max flow rate from 12:01 AM to 11:59 PM. Calculated using available data for the selected day.
                                                </span>
                                            </span>
                                        </h5>
                                        <p class="text-sm font-bold text-gray-900" id="flowRange">-</p>
                                    </div>
                                    <div class="stat-box">
                                        <h5 class="text-xs font-medium text-gray-500">Total Flow</h5>
                                        <p class="text-sm font-bold text-gray-900" id="flowTotal">-</p>
                                    </div>
                                    <div class="stat-box">
                                        <h5 class="text-xs font-medium text-gray-500">Std Deviation</h5>
                                        <p class="text-sm font-bold text-gray-900" id="flowStdDev">-</p>
                                    </div>
                                    <div class="stat-box">
                                        <h5 class="text-xs font-medium text-gray-500">Frequency</h5>
                                        <p class="text-sm font-bold text-gray-900" id="flowFrequency">-</p>
                                    </div>
                                    <div class="stat-box col-span-2 md:col-span-1">
                                        <h5 class="text-xs font-medium text-gray-500">Time Since Last Flow</h5>
                                        <p class="text-sm font-bold text-gray-900" id="timeSinceLastFlow">-</p>
                                    </div>
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas id="flowChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Status Controls -->
                    ${device.thing ? getStatusControls(device.id, device.thing.properties || []) : ''}

                    <!-- Properties Section -->
                    ${device.thing ? `
                        <div class="bg-white rounded-lg shadow-lg border border-gray-100 p-4">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">Properties</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                ${device.thing?.properties ? 
                                    sortProperties(device.thing.properties).map(property => `
                                        <div class="property-card ${getPropertyBgColor(property.name)} p-4 rounded-lg">
                                            <div class="flex justify-between items-start mb-2">
                                                <div>
                                                    <p class="${getPropertyTextColor(property.name)} font-medium">${property.name}</p>
                                                    <p class="text-xs text-gray-500">Type: ${property.type}</p>
                                                </div>
                                                ${property.permission === 'READ_WRITE' ? 
                                                    `<span class="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full">Editable</span>` : 
                                                    `<span class="px-2 py-1 text-xs font-medium bg-gray-100 text-gray-800 rounded-full">Read Only</span>`
                                                }
                                            </div>
                                            ${property.permission === 'READ_WRITE' ? `
                                                <div class="mt-3">
                                                    ${property.name === 'sensorplacement' ? 
                                                        getSensorPlacementSelector(device.id, property)
                                                    : property.type === 'BOOL' || property.type === 'STATUS' ? `
                                                        <label class="inline-flex items-center">
                                                            <input 
                                                                type="checkbox"
                                                                class="form-checkbox h-5 w-5 text-blue-600 rounded"
                                                                ${property.last_value === true || property.last_value === 'true' ? 'checked' : ''}
                                                                data-device-id="${device.id}"
                                                                data-property='${JSON.stringify(property).replace(/'/g, "&apos;")}'
                                                                onchange="handlePropertyInputChange(event)"
                                                            />
                                                            <span class="ml-2 text-sm text-gray-700">
                                                                ${property.last_value === true || property.last_value === 'true' ? 'On' : 'Off'}
                                                            </span>
                                                        </label>
                                                    ` : `
                                                        <div class="flex space-x-2">
                                                            <input 
                                                                type="${getPropertyInputType(property)}"
                                                                class="flex-1 px-3 py-2 text-sm border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                                value="${property.last_value || ''}"
                                                                placeholder="Enter new value"
                                                                data-device-id="${device.id}"
                                                                data-property='${JSON.stringify(property).replace(/'/g, "&apos;")}'
                                                                onkeydown="handlePropertyInputKeydown(event)"
                                                                step="${getPropertyStep(property)}"
                                                                ${property.type === 'INT' || property.type === 'FLOAT' ? `min="0"` : ''}
                                                            />
                                                            <button 
                                                                onclick="handleUpdateButtonClick(event)"
                                                                data-device-id="${device.id}"
                                                                data-property='${JSON.stringify(property).replace(/'/g, "&apos;")}'
                                                                class="px-4 py-2 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors"
                                                            >
                                                                Update
                                                            </button>
                                                        </div>
                                                    `}
                                                </div>
                                            ` : `
                                                <p class="mt-2 text-lg font-medium ${getPropertyTextColor(property.name)}">${formatPropertyValue(property)}</p>
                                            `}
                                            <p class="text-xs text-gray-500 mt-2">Last Updated: ${new Date(device.last_activity_at).toLocaleString('en-US', {
                                                dateStyle: 'short',
                                                timeStyle: 'short'
                                            })}</p>
                                        </div>
                                    `).join('') 
                                    : '<p class="text-gray-500">No properties available</p>'
                                }
                            </div>
                        </div>
                    ` : '<p class="text-gray-500">No thing data available</p>'}
                </div>
            `;

            // Initialize the graphs
            initializeGraphs(deviceIndex);

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function hideDeviceDetails() {
            const modal = document.getElementById('device-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function handleUpdateButtonClick(event) {
            const button = event.target;
            const deviceId = button.dataset.deviceId;
            const input = button.previousElementSibling;
            
            try {
                const property = JSON.parse(button.dataset.property);
                property.new_value = input.value;
                
                if (!deviceId) {
                    throw new Error('Device ID is missing');
                }
                
                updatePropertyValue(deviceId, property);
            } catch (error) {
                logToConsole(`Error handling update button click: ${error.message}`, 'error');
                showError(`Failed to handle update: ${error.message}`);
            }
        }

        function showActiveDevices() {
            const devices = window.lastDevicesData || [];
            const modal = document.getElementById('active-devices-modal');
            const devicesList = document.getElementById('active-devices-list');

            devicesList.innerHTML = devices.map(device => {
                const statusEvent = device.events?.find(event => event.name === 'r_status');
                const isConnected = statusEvent?.value === 'CONNECTED';
                
                return `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100">
                        <div>
                            <h3 class="font-medium text-gray-800">${device.name || 'Unnamed Device'}</h3>
                            <p class="text-sm text-gray-500">
                                ID: ${device.id}
                            </p>
                        </div>
                        <span class="px-2 py-1 text-xs font-medium rounded-full ${isConnected ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                            ${isConnected ? 'Connected' : 'Disconnected'}
                        </span>
                    </div>
                `;
            }).join('') || '<p class="text-gray-500 text-center py-4">No active devices found</p>';

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function hideActiveDevices() {
            const modal = document.getElementById('active-devices-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function showConnectedDevices() {
            const devices = window.lastDevicesData || [];
            const modal = document.getElementById('connected-devices-modal');
            const devicesList = document.getElementById('connected-devices-list');

            const connectedDevices = devices.filter(device => {
                const statusEvent = device.events?.find(event => event.name === 'r_status');
                return statusEvent?.value === 'CONNECTED';
            });

            devicesList.innerHTML = connectedDevices.length > 0 ? 
                connectedDevices.map(device => `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100">
                        <div>
                            <h3 class="font-medium text-gray-800">${device.name || 'Unnamed Device'}</h3>
                            <p class="text-sm text-gray-500">
                                ID: ${device.id}
                            </p>
                        </div>
                        <span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">
                            Connected
                        </span>
                </div>
                `).join('') 
                : '<p class="text-gray-500 text-center py-4">No connected devices found</p>';

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function hideConnectedDevices() {
            const modal = document.getElementById('connected-devices-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function showGreatDevices() {
            const devices = window.lastDevicesData || [];
            const modal = document.getElementById('great-devices-modal');
            const devicesList = document.getElementById('great-devices-list');

            const greatDevices = devices.filter(device => calculateDeviceStatus(device).isGreat);

            devicesList.innerHTML = greatDevices.length > 0 ? 
                greatDevices.map(device => {
                    const status = calculateDeviceStatus(device);
                    return `
                        <div class="flex items-center justify-between p-3 bg-emerald-50 rounded-lg hover:bg-emerald-100">
                            <div>
                                <h3 class="font-medium text-emerald-800">${device.name || 'Unnamed Device'}</h3>
                                <p class="text-sm text-emerald-600">
                                    Cloud Temp: ${formatTemperature(status.cloudTemp, status.tempThresholdMax)} (Max: ${formatTemperature(status.tempThresholdMax)})<br>
                                    Time Since Flow: ${formatTimeDuration(status.timeSinceFlowMs)} (Critical: ${status.noFlowCriticalTime}h)
                                </p>
                            </div>
                            <span class="px-2 py-1 text-xs font-medium rounded-full bg-emerald-100 text-emerald-800">
                                Great
                            </span>
                        </div>
                    `;
                }).join('') 
                : '<p class="text-gray-500 text-center py-4">No devices in great condition found</p>';

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function hideGreatDevices() {
            const modal = document.getElementById('great-devices-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function showWarningDevices() {
            const devices = window.lastDevicesData || [];
            const modal = document.getElementById('warning-devices-modal');
            const devicesList = document.getElementById('warning-devices-list');

            const warningDevices = devices.filter(device => calculateDeviceStatus(device).isWarning);

            devicesList.innerHTML = warningDevices.length > 0 ? 
                warningDevices.map(device => {
                    const status = calculateDeviceStatus(device);
                    return `
                        <div class="flex items-center justify-between p-3 bg-yellow-50 rounded-lg hover:bg-yellow-100">
                            <div>
                                <h3 class="font-medium text-yellow-800">${device.name || 'Unnamed Device'}</h3>
                                <p class="text-sm text-yellow-600">
                                    Cloud Temp: ${formatTemperature(status.cloudTemp)} (${status.cloudTemp > 32 ? 'High' : 'Normal'})<br>
                                    Time Since Flow: ${formatTimeDuration(status.timeSinceFlowMs)} (Critical: ${status.noFlowCriticalTime}h)
                                </p>
                            </div>
                            <span class="px-2 py-1 text-xs font-medium rounded-full bg-yellow-100 text-yellow-800">
                                Warning
                            </span>
                        </div>
                    `;
                }).join('') 
                : '<p class="text-gray-500 text-center py-4">No devices in warning state found</p>';

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function hideWarningDevices() {
            const modal = document.getElementById('warning-devices-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function showCriticalDevices() {
            const devices = window.lastDevicesData || [];
            const modal = document.getElementById('critical-devices-modal');
            const devicesList = document.getElementById('critical-devices-list');

            const criticalDevices = devices.filter(device => calculateDeviceStatus(device).isCritical);

            devicesList.innerHTML = criticalDevices.length > 0 ? 
                criticalDevices.map(device => {
                    const status = calculateDeviceStatus(device);
                    return `
                        <div class="flex items-center justify-between p-3 bg-red-50 rounded-lg hover:bg-red-100">
                            <div>
                                <h3 class="font-medium text-red-800">${device.name || 'Unnamed Device'}</h3>
                                ${!status.isConnected ? `
                                    <p class="text-sm text-red-600">
                                        Disconnected since: ${new Date(status.lastConnectedTime).toLocaleString()}
                                    </p>
                                ` : `
                                    <p class="text-sm text-red-600">
                                        Cloud Temp: ${formatTemperature(status.cloudTemp)} (High)<br>
                                        Time Since Flow: ${formatTimeDuration(status.timeSinceFlowMs)} (Critical: ${status.noFlowCriticalTime}h)
                                    </p>
                                `}
                            </div>
                            <span class="px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-800">
                                Critical
                            </span>
                        </div>
                    `;
                }).join('') 
                : '<p class="text-gray-500 text-center py-4">No devices in critical state found</p>';

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function hideCriticalDevices() {
            const modal = document.getElementById('critical-devices-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function getSensorPlacementSelector(deviceId, property) {
            const currentValue = property.last_value ? property.last_value * 100 : null;
            return `
                <div class="flex flex-col space-y-2">
                    <div class="flex space-x-2">
                        <select 
                            class="w-full px-2 py-1 text-sm border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                            data-device-id="${deviceId}"
                            data-property='${JSON.stringify(property).replace(/'/g, "&apos;")}'
                            id="sensorPlacement_${deviceId}"
                        >
                            <option value="" ${!currentValue ? 'selected' : ''}>Select sensor placement</option>
                            <option value="10" ${currentValue === 10 ? 'selected' : ''}>10% from bottom</option>
                            <option value="25" ${currentValue === 25 ? 'selected' : ''}>25% from bottom</option>
                            <option value="50" ${currentValue === 50 ? 'selected' : ''}>50% from bottom</option>
                            <option value="75" ${currentValue === 75 ? 'selected' : ''}>75% from bottom</option>
                        </select>
                        <button 
                            onclick="handleSensorPlacementChange(document.getElementById('sensorPlacement_${deviceId}'))"
                            class="px-3 py-1 text-sm bg-blue-500 text-white rounded hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                            Update
                        </button>
                    </div>
                    <p class="text-xs text-gray-600">
                        Select where the temperature sensor is placed in the ice machine (percentage from bottom).
                        This will be used to determine ice level based on temperature readings.
                    </p>
                </div>
            `;
        }

        function handleSensorPlacementChange(select) {
            const deviceId = select.dataset.deviceId;
            const percentage = parseFloat(select.value);
            
            if (isNaN(percentage)) {
                logToConsole('Please select a valid sensor placement percentage', 'error');
                return;
            }
            
            try {
                const property = JSON.parse(select.dataset.property);
                const decimalValue = percentage / 100; // Convert percentage to decimal
                
                if (!deviceId) {
                    throw new Error('Device ID is missing');
                }

                // Log the update attempt
                logToConsole(`Updating sensor placement for device ${deviceId} to ${percentage}% (${decimalValue})`);

                // Use the same API endpoint and structure that works for other variables
                const apiUrl = `${API_URL}/api/iot/v2/devices/${deviceId}/properties`;
                
                fetch(apiUrl, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        propertiesValues: {
                            input: true,
                            properties: [{
                                name: 'sensorplacement',
                                type: 'FLOAT',
                                value: decimalValue
                            }]
                        }
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    logToConsole(`Successfully updated sensor placement to ${percentage}%`);
                    // Refresh devices to show updated value
                    fetchDevices();
                })
                .catch(error => {
                    logToConsole(`Error updating sensor placement: ${error.message}`, 'error');
                    showError(`Failed to update sensor placement: ${error.message}`);
                });
            } catch (error) {
                logToConsole(`Error handling sensor placement: ${error.message}`, 'error');
                showError(`Failed to handle sensor placement: ${error.message}`);
            }
        }

        function handleManualStatusUpdate(deviceId, statusType, value) {
            // Check cooldown before updating
            if (!canUpdateStatus(deviceId, statusType)) {
                logToConsole(`Skipping ${statusType} update for device ${deviceId} - cooldown period not elapsed`);
                return;
            }

            try {
                logToConsole(`Attempting to update ${statusType} to ${value} for device ${deviceId}`);

                const apiUrl = `${API_URL}/api/iot/v2/devices/${deviceId}/properties`;
                
                fetch(apiUrl, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        propertiesValues: {
                            input: true,
                            properties: [{
                                name: statusType,
                                type: 'STATUS',
                                value: value
                            }]
                        }
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    updateLastStatusTime(deviceId, statusType);
                    logToConsole(`Successfully updated ${statusType} to ${value}`);
                    // Refresh devices to show updated value after a short delay
                    setTimeout(fetchDevices, 1000);
                })
                .catch(error => {
                    logToConsole(`Error updating ${statusType}: ${error.message}`, 'error');
                    showError(`Failed to update ${statusType}: ${error.message}`);
                });
            } catch (error) {
                logToConsole(`Error handling ${statusType} update: ${error.message}`, 'error');
                showError(`Failed to handle ${statusType} update: ${error.message}`);
            }
        }

        function getStatusControls(deviceId, properties) {
            const warningProp = properties.find(p => p.name === 'warning');
            const criticalProp = properties.find(p => p.name === 'critical');
            
            // Convert string values to boolean for comparison
            const warningValue = warningProp?.last_value === true || warningProp?.last_value === 'true';
            const criticalValue = criticalProp?.last_value === true || criticalProp?.last_value === 'true';

            // Get calculated status
            const device = window.lastDevicesData.find(d => d.id === deviceId);
            const calculatedStatus = calculateDeviceStatus(device);

            // Determine which buttons should be highlighted
            const shouldBeWarning = calculatedStatus.isWarning;
            const shouldBeCritical = calculatedStatus.isCritical;

            // Highlight classes
            const warningHighlight = 'ring-2 ring-yellow-500 animate-pulse';
            const criticalHighlight = 'ring-2 ring-red-500 animate-pulse';
            
            return `
                <div class="mt-4 p-4 bg-gray-50 rounded-lg">
                    <h3 class="font-medium text-gray-700 mb-3">Manual Status Controls</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <!-- Warning Control -->
                        <div class="p-3 bg-yellow-50 rounded-lg ${warningValue !== shouldBeWarning ? 'ring-2 ring-yellow-500' : ''}">
                            <p class="text-yellow-800 font-medium mb-2">Warning Status</p>
                            <div class="flex space-x-2">
                                <button 
                                    onclick="handleManualStatusUpdate('${deviceId}', 'warning', true)"
                                    class="px-3 py-1 text-sm bg-yellow-500 text-white rounded hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-500 ${shouldBeWarning && !warningValue ? warningHighlight : ''}"
                                >
                                    Set True
                                </button>
                                <button 
                                    onclick="handleManualStatusUpdate('${deviceId}', 'warning', false)"
                                    class="px-3 py-1 text-sm bg-gray-500 text-white rounded hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 ${!shouldBeWarning && warningValue ? warningHighlight : ''}"
                                >
                                    Set False
                                </button>
                            </div>
                            <p class="text-sm text-yellow-600 mt-2">
                                Current: ${warningValue ? 'True' : 'False'}
                                ${warningValue !== shouldBeWarning ? 
                                    `<br><span class="text-yellow-700 font-medium">Should be: ${shouldBeWarning ? 'True' : 'False'}</span>` 
                                    : ''}
                            </p>
                        </div>
                        
                        <!-- Critical Control -->
                        <div class="p-3 bg-red-50 rounded-lg ${criticalValue !== shouldBeCritical ? 'ring-2 ring-red-500' : ''}">
                            <p class="text-red-800 font-medium mb-2">Critical Status</p>
                            <div class="flex space-x-2">
                                <button 
                                    onclick="handleManualStatusUpdate('${deviceId}', 'critical', true)"
                                    class="px-3 py-1 text-sm bg-red-500 text-white rounded hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 ${shouldBeCritical && !criticalValue ? criticalHighlight : ''}"
                                >
                                    Set True
                                </button>
                                <button 
                                    onclick="handleManualStatusUpdate('${deviceId}', 'critical', false)"
                                    class="px-3 py-1 text-sm bg-gray-500 text-white rounded hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 ${!shouldBeCritical && criticalValue ? criticalHighlight : ''}"
                                >
                                    Set False
                                </button>
                            </div>
                            <p class="text-sm text-red-600 mt-2">
                                Current: ${criticalValue ? 'True' : 'False'}
                                ${criticalValue !== shouldBeCritical ? 
                                    `<br><span class="text-red-700 font-medium">Should be: ${shouldBeCritical ? 'True' : 'False'}</span>` 
                                    : ''}
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Add these new functions for graph handling
        function initializeGraphs(deviceIndex) {
            // Initialize with only today's data visible
            updateTempGraph(deviceIndex, [0]);
            updateStatusGraph(deviceIndex, 0);
            updateFlowGraph(deviceIndex, 0);
        }

        function toggleTempGraph(deviceIndex, day) {
            const button = document.querySelector(`#temp-time-range button[data-days="${day}"]`);
            const wasActive = button.classList.contains('active');
            
            // If this was the only active button and it's being deactivated, don't allow it
            const activeButtons = document.querySelectorAll('#temp-time-range button.active');
            if (activeButtons.length === 1 && wasActive && activeButtons[0] === button) {
                return; // Keep at least one day selected
            }
            
            button.classList.toggle('active');
            
            // Get all active days
            const activeDays = Array.from(document.querySelectorAll('#temp-time-range button.active'))
                .map(btn => parseInt(btn.dataset.days))
                .sort((a, b) => a - b); // Sort days in order
            
            // Update graph with active days
            updateTempGraph(deviceIndex, activeDays);
        }

        // Add function to toggle ice level visibility
        function toggleIceLevel() {
            const checkbox = document.getElementById('ice-level-toggle');
            const isVisible = checkbox.checked;
            
            // Store the visibility state
            window.iceLevelVisible = isVisible;
            
            // Get the current device index and active days
            const deviceIndex = window.currentDeviceIndex || 0;
            const activeDays = Array.from(document.querySelectorAll('#temp-time-range button.active'))
                .map(btn => parseInt(btn.dataset.days));
            
            // Update graph
            updateTempGraph(deviceIndex, activeDays);
        }

        // Add function to toggle temperature line visibility
        function toggleTempLine() {
            const checkbox = document.getElementById('temp-line-toggle');
            const isVisible = checkbox.checked;
            
            // Store the visibility state
            window.tempLineVisible = isVisible;
            
            // Get the current device index and active days
            const deviceIndex = window.currentDeviceIndex || 0;
            const activeDays = Array.from(document.querySelectorAll('#temp-time-range button.active'))
                .map(btn => parseInt(btn.dataset.days));
            
            // Update graph
            updateTempGraph(deviceIndex, activeDays);
        }

        // Update the updateTempGraph function to handle both toggles
        function updateTempGraph(deviceIndex, selectedDays) {
            if (!Array.isArray(selectedDays)) {
                selectedDays = [selectedDays];
            }

            // Store current device index for toggle function
            window.currentDeviceIndex = deviceIndex;

            // Get the stats container
            const statsContainer = document.getElementById('tempStats');

            // Hide or show stats based on number of selected days
            if (selectedDays.length > 1) {
                statsContainer.classList.add('opacity-50', 'pointer-events-none');
                // Clear stats when multiple days are selected
                document.getElementById('tempRange').textContent = '-';
                document.getElementById('tempAvg').textContent = '-';
                document.getElementById('tempStdDev').textContent = '-';
                document.getElementById('tempMode').textContent = '-';
            } else {
                statsContainer.classList.remove('opacity-50', 'pointer-events-none');
            }

            const device = window.lastDevicesData[deviceIndex];

            fetchTimeSeriesData(device.id, 72).then(data => {
                if (!data) {
                    logToConsole('No data returned from fetchTimeSeriesData', 'error');
                    return;
                }

                // Destroy existing chart if it exists
                const existingChart = Chart.getChart('tempChart');
                if (existingChart) {
                    existingChart.destroy();
                }

                // Process temperature data for each selected day
                const allDatasets = [];
                let deviceThreshold = 34; // Default value
                let hasAnyData = false;

                for (const day of selectedDays) {
                    const { datasets, thresholdF, noData } = processTemperatureByHour(data.timestamps, data.temperature, day);
                    
                    if (noData) {
                        // Add a text annotation for this day
                        const dayLabel = day === 0 ? 'Today' : day === 1 ? 'Yesterday' : '2 Days Ago';
                        logToConsole(`No data available for ${dayLabel}`, 'warning');
                    } else {
                        hasAnyData = true;
                        // Filter out datasets based on visibility toggles
                        const filteredDatasets = datasets.filter(d => {
                            if (d.label === 'Ice Level' && window.iceLevelVisible === false) return false;
                            if (d.label.includes('Temperature') && d.label !== 'Temperature Threshold' && window.tempLineVisible === false) return false;
                            return true;
                        });
                        
                        allDatasets.push(...filteredDatasets);
                        deviceThreshold = thresholdF;
                    }
                }

                // Create hour labels (00:00 to 23:00)
                const hourLabels = Array.from({ length: 24 }, (_, i) => 
                    `${i.toString().padStart(2, '0')}:00`
                );

                // Get the canvas context
                const ctx = document.getElementById('tempChart').getContext('2d');
                
                // Build the new chart with updated options
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: hourLabels,
                        datasets: allDatasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    title: (context) => {
                                        const hour = parseInt(context[0].label);
                                        const nextHour = (hour + 1) % 24;
                                        return `Hour: ${hour}:00 - ${nextHour.toString().padStart(2, '0')}:00`;
                                    },
                                    label: (context) => {
                                        const value = context.raw;
                                        if (value === null) return `${context.dataset.label}: No data`;
                                        
                                        if (context.dataset.yAxisID === 'y-ice') {
                                            // Only show ice level if there's data
                                            if (value === 1 || value === 0) {
                                                const device = window.lastDevicesData.find(d => d.thing?.properties?.some(p => p.name === 'cloudtemp'));
                                                const sensorPlacement = device?.thing?.properties?.find(p => p.name === 'sensorplacement')?.last_value || 0;
                                                const placement = (sensorPlacement * 100).toFixed(0);
                                                return `Ice Level: ${value === 1 ? `More than ${placement}%` : `Less than ${placement}%`} full`;
                                            }
                                            return null; // Don't show anything if no data
                                        }
                                        
                                        // Check if this is the threshold line
                                        if (context.dataset.label === 'Temperature Threshold') {
                                            return `Temperature Threshold: ${value.toFixed(1)}°F`;
                                        }
                                        
                                        const temp = value.toFixed(1);
                                        return `Temperature: ${temp}°F`;
                                    }
                                },
                                titleAlign: 'center',
                                bodyAlign: 'left',
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleFont: { size: 13, weight: 'bold' },
                                bodyFont: { size: 12 },
                                padding: 12
                            },
                            legend: {
                                position: 'top',
                                labels: {
                                    usePointStyle: true,
                                    padding: 15
                                }
                              }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Hour of Day'
                                },
                                grid: {
                                    display: true,
                                    drawOnChartArea: true
                                }
                            },
                            'y-temp': {
                                type: 'linear',
                                display: window.tempLineVisible !== false,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'Temperature (°F)'
                                },
                                grid: {
                                    display: true,
                                    drawOnChartArea: true
                                },
                                ticks: {
                                    callback: value => `${value}°F`
                                }
                            },
                            'y-ice': {
                                type: 'linear',
                                display: window.iceLevelVisible !== false,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'Ice Level'
                                },
                                min: -0.1,
                                max: 1.1,
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    callback: value => value === 1 ? 'Above' : value === 0 ? 'Below' : '',
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });

                // If there's no data for any selected day, show a message
                if (!hasAnyData) {
                    const chartContainer = document.getElementById('tempChart').parentElement;
                    // Remove any existing no-data message
                    const existingMessage = chartContainer.querySelector('.no-data-message');
                    if (existingMessage) {
                        existingMessage.remove();
                    }
                    
                    const noDataMessage = document.createElement('div');
                    noDataMessage.className = 'absolute inset-0 flex items-center justify-center no-data-message';
                    noDataMessage.innerHTML = `
                        <div class="text-gray-500 text-center">
                            <p class="text-lg font-medium">No temperature data available</p>
                            <p class="text-sm">for the selected time period${selectedDays.length > 1 ? 's' : ''}</p>
                        </div>
                    `;
                    chartContainer.appendChild(noDataMessage);
                } else {
                    // If we have data, make sure to remove any existing no-data message
                    const chartContainer = document.getElementById('tempChart').parentElement;
                    const existingMessage = chartContainer.querySelector('.no-data-message');
                    if (existingMessage) {
                        existingMessage.remove();
                    }
                }
            });
        }

        function processTemperatureByHour(timestamps, temperatures, selectedDay) {
            logToConsole('Processing temperature data:', 'info');
            logToConsole(`Timestamps received: ${timestamps.length}`, 'info');
            logToConsole(`Temperature values received: ${temperatures.length}`, 'info');
            logToConsole(`Selected day: ${selectedDay === 0 ? 'Today' : selectedDay === 1 ? 'Yesterday' : '2 Days Ago'}`, 'info');

            const hourlyData = {};
            const now = new Date();
            const currentHour = now.getHours();
            
            const dayStart = new Date(now);
            dayStart.setDate(dayStart.getDate() - selectedDay);
            dayStart.setHours(0, 0, 0, 0);
            
            const dayEnd = new Date(dayStart);
            dayEnd.setHours(23, 59, 59, 999);

            // Get the device's temperature threshold
            const device = window.lastDevicesData.find(d => d.thing?.properties?.some(p => p.name === 'cloudtemp'));
            const tempThresholdMax = device?.thing?.properties?.find(p => p.name === 'tempThresholdMax')?.last_value;
            const thresholdF = tempThresholdMax !== undefined ? (tempThresholdMax * 9/5 + 32) : 34;

            // Track if we have any data for this day
            let hasDataForDay = false;
            let allTempsForDay = [];

            // Process each temperature reading
            for (let i = 0; i < timestamps.length; i++) {
                const timestamp = new Date(timestamps[i]);
                const temp = temperatures[i];
                
                if (temp === null || temp === undefined) continue;
                
                if (timestamp < dayStart || timestamp > dayEnd) continue;
                
                const hour = timestamp.getHours();
                if (selectedDay === 0 && hour > currentHour) continue;
                
                hasDataForDay = true;
                
                // Convert Celsius to Fahrenheit for stats
                const tempF = (temp * 9/5) + 32;
                allTempsForDay.push(tempF);
                
                if (!hourlyData[hour]) {
                    hourlyData[hour] = {
                        temps: [],
                        iceAboveSensor: [],
                        hour,
                        date: new Date(timestamp)
                    };
                }
                
                // If temperature is below threshold, ice is above sensor
                const isIceAboveSensor = tempF <= thresholdF;
                
                hourlyData[hour].temps.push(tempF);
                hourlyData[hour].iceAboveSensor.push(isIceAboveSensor);
            }

            // Update statistics if this is a single day view and we have data
            if (hasDataForDay) {
                // Calculate daily range
                const minTemp = Math.min(...allTempsForDay);
                const maxTemp = Math.max(...allTempsForDay);
                document.getElementById('tempRange').innerHTML = 
                    `${minTemp.toFixed(1)}°F - ${maxTemp.toFixed(1)}°F`;

                // Calculate daily average
                const avgTemp = allTempsForDay.reduce((a, b) => a + b, 0) / allTempsForDay.length;
                document.getElementById('tempAvg').innerHTML = 
                    formatTempValue(avgTemp.toFixed(1));

                // Calculate standard deviation
                const stdDev = calculateStdDev(allTempsForDay);
                document.getElementById('tempStdDev').innerHTML = 
                    `±${stdDev.toFixed(1)}°F`;

                // Calculate mode
                const mode = calculateMode(allTempsForDay);
                document.getElementById('tempMode').innerHTML = 
                    formatTempValue(mode.toFixed(1));
            }

            // If no data for this day, return null
            if (!hasDataForDay) {
                return {
                    datasets: [],
                    thresholdF,
                    noData: true
                };
            }

            // Helper function to calculate statistics
            function calculateStats(values) {
                if (!values || values.length === 0) return null;
                
                const sum = values.reduce((a, b) => a + b, 0);
                const avg = sum / values.length;
                
                // Calculate standard deviation
                const squareDiffs = values.map(value => {
                    const diff = value - avg;
                    return diff * diff;
                });
                const avgSquareDiff = squareDiffs.reduce((a, b) => a + b, 0) / values.length;
                const stdDev = Math.sqrt(avgSquareDiff);
                
                // Calculate mode
                const frequency = {};
                let maxFreq = 0;
                let mode = null;
                values.forEach(value => {
                    const rounded = Math.round(value * 10) / 10;
                    frequency[rounded] = (frequency[rounded] || 0) + 1;
                    if (frequency[rounded] > maxFreq) {
                        maxFreq = frequency[rounded];
                        mode = rounded;
                    }
                });

                return { avg, stdDev, mode };
            }

            // Create dataset for temperature with dynamic coloring
            const tempData = {
                label: `${selectedDay === 0 ? 'Today' : selectedDay === 1 ? 'Yesterday' : '2 Days Ago'} (Temperature)`,
                data: Array(24).fill(null),
                yAxisID: 'y-temp',
                borderColor: function(context) {
                    const value = context.raw;
                    return value > thresholdF ? 'rgb(239, 68, 68)' : 'rgb(34, 197, 94)';
                },
                backgroundColor: function(context) {
                    const value = context.raw;
                    return value > thresholdF ? 'rgba(239, 68, 68, 0.1)' : 'rgba(34, 197, 94, 0.1)';
                },
                tension: 0.1,
                fill: true,
                segment: {
                    borderColor: ctx => {
                        const value = ctx.p1.parsed.y;
                        return value > thresholdF ? 'rgb(239, 68, 68)' : 'rgb(34, 197, 94)';
                    }
                },
                order: 1
            };

            // Create dataset for ice level indicator
            const iceLevelData = {
                label: 'Ice Level',
                data: Array(24).fill(null),
                yAxisID: 'y-ice',
                borderColor: function(context) {
                    const value = context.raw;
                    return value === 0 ? 'rgb(239, 68, 68)' : 'rgba(147, 197, 253, 0.8)';
                },
                backgroundColor: function(context) {
                    const value = context.raw;
                    return value === 0 ? 'rgba(239, 68, 68, 0.1)' : 'rgba(147, 197, 253, 0.2)';
                },
                tension: 0.1,
                fill: true,
                order: 2,
                stepped: true,
                segment: {
                    borderColor: ctx => {
                        const value = ctx.p1.parsed.y;
                        return value === 0 ? 'rgb(239, 68, 68)' : 'rgba(147, 197, 253, 0.8)';
                    }
                }
            };

            const thresholdData = {
                label: 'Temperature Threshold',
                data: Array(24).fill(thresholdF),
                yAxisID: 'y-temp',
                borderColor: 'rgba(0, 0, 0, 0.5)',
                borderDash: [5, 5],
                tension: 0,
                fill: false,
                order: 0
            };

            // Fill in the data for each hour
            let allTemps = [];

            for (let hour = 0; hour < 24; hour++) {
                if (selectedDay === 0 && hour > currentHour) continue;

                const hourData = hourlyData[hour];
                
                if (hourData && hourData.temps.length > 0) {
                    const tempStats = calculateStats(hourData.temps);
                    
                    if (tempStats) {
                        tempData.data[hour] = tempStats.avg;
                        allTemps = allTemps.concat(hourData.temps);
                        
                        // Calculate ice level based on average temperature
                        iceLevelData.data[hour] = tempStats.avg <= thresholdF ? 1 : 0;
                    }
                }
            }

            // Update statistics display
            const overallTempStats = calculateStats(allTemps);
            if (overallTempStats) {
                document.getElementById('tempStdDev').innerHTML = 
                    `±${overallTempStats.stdDev.toFixed(1)}°F`;
                document.getElementById('tempMode').innerHTML = 
                    formatTempValue(overallTempStats.mode);
            }

            return {
                datasets: [thresholdData, tempData, iceLevelData],
                thresholdF
            };
        }

        // Helper function to format temperature value with conditional red color
        function formatTempValue(value) {
            const device = window.lastDevicesData.find(d => d.thing?.properties?.some(p => p.name === 'cloudtemp'));
            const tempThresholdMax = device?.thing?.properties?.find(p => p.name === 'tempThresholdMax')?.last_value;
            const thresholdF = tempThresholdMax !== undefined ? (tempThresholdMax * 9/5 + 32) : 34;
            
            return parseFloat(value) > thresholdF ? 
                `<span class="text-red-600">${value}°F</span>` : 
                `${value}°F`;
        }

        // Helper function to calculate standard deviation
        function calculateStdDev(values) {
            const mean = values.reduce((a, b) => a + b, 0) / values.length;
            const squareDiffs = values.map(value => {
                const diff = value - mean;
                return diff * diff;
            });
            const avgSquareDiff = squareDiffs.reduce((a, b) => a + b, 0) / values.length;
            return Math.sqrt(avgSquareDiff);
        }

        // Helper function to calculate mode
        function calculateMode(values) {
            const rounded = values.map(v => Math.round(v * 10) / 10);
            const frequency = {};
            let maxFreq = 0;
            let mode = rounded[0];

            rounded.forEach(value => {
                frequency[value] = (frequency[value] || 0) + 1;
                if (frequency[value] > maxFreq) {
                    maxFreq = frequency[value];
                    mode = value;
                }
            });

            return mode;
        }

        async function fetchTimeSeriesData(deviceId, hours) {
  try {
    const now = new Date();
    const from = new Date(now - hours * 60 * 60 * 1000);

    // 1) Identify the device & its properties
    const device = window.lastDevicesData.find(d => d.id === deviceId);
    if (!device?.thing?.id) {
      throw new Error("Device or Thing not found");
    }
    const thingId = device.thing.id;
    const properties = device.thing.properties || [];

    // Helper function to check if a property is numeric
    function isNumericProperty(prop) {
      const numericTypes = [
        'FLOAT', 'INT', 'NUMBER', 'DOUBLE', 'LONG',
        'TEMPERATURE', // Add custom numeric types
        'FLOW_RATE'
      ];
      return numericTypes.includes(prop.type?.toUpperCase());
    }

    // Find relevant properties, ensuring they are numeric
    const tempProperty = properties.find(p => p.name === 'cloudtemp');
    const flowProperty = properties.find(p => p.name === 'cloudflowrate');

    // Log property types for debugging
    logToConsole('Property types:', 'info');
    properties.forEach(p => {
      logToConsole(`${p.name}: ${p.type}`, 'info');
    });

    if (!tempProperty) {
      logToConsole('Temperature property not found', 'warning');
    } else if (!isNumericProperty(tempProperty)) {
      logToConsole(`Temperature property type ${tempProperty.type} is not numeric`, 'warning');
    }

    if (!flowProperty) {
      logToConsole('Flow rate property not found', 'warning');
    } else if (!isNumericProperty(flowProperty)) {
      logToConsole(`Flow rate property type ${flowProperty.type} is not numeric`, 'warning');
    }

    // 2) Compute interval to stay under 1000 points
    const timeRangeSeconds = hours * 3600;
    const interval = Math.max(Math.ceil(timeRangeSeconds / 1000), 60);

    // 3) Basic fetch options with required headers
    const fetchOptions = {
      method: 'GET',
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      }
    };

    // Helper function to build the query string according to API specs
    function buildQuery() {
      return new URLSearchParams({
        interval: interval.toString(),
        from: from.toISOString(),
        to: now.toISOString(),
        aggregation: 'AVG',
        desc: 'false'
      }).toString();
    }

    // Log the request details for debugging
    logToConsole(`Fetching time series data for thing ${thingId}:`, 'info');
    if (tempProperty) logToConsole(`Temperature property ID: ${tempProperty.id} (${tempProperty.type})`, 'info');
    if (flowProperty) logToConsole(`Flow rate property ID: ${flowProperty.id} (${flowProperty.type})`, 'info');

    // 4) Make parallel fetch calls for each numeric property
    const [tempData, flowData] = await Promise.all([
      // Temperature
      tempProperty
        ? fetch(
            `${API_URL}/api/proxy/timeseries/${thingId}/${tempProperty.id}?${buildQuery()}`,
            fetchOptions
          ).then(async res => {
            if (!res.ok) {
              const errorText = await res.text();
              throw new Error(`Temperature fetch failed: ${res.status} - ${errorText}`);
            }
            return res.json();
          })
        : Promise.resolve({ data: [] }),

      // Flow Rate
      flowProperty
        ? fetch(
            `${API_URL}/api/proxy/timeseries/${thingId}/${flowProperty.id}?${buildQuery()}`,
            fetchOptions
          ).then(async res => {
            if (!res.ok) {
              const errorText = await res.text();
              throw new Error(`Flow rate fetch failed: ${res.status} - ${errorText}`);
            }
            return res.json();
          })
        : Promise.resolve({ data: [] })
    ]);

    // Log raw response data
    logToConsole('Raw temperature response:', 'info');
    logToConsole(tempData, 'info');

    // Add logging for flow rate data
    logToConsole('Raw flow rate response:', 'info');
    logToConsole(flowData, 'info');
    logToConsole('Flow data details:', 'info');
    logToConsole({
        endpoint: `${API_URL}/api/proxy/timeseries/${thingId}/${flowProperty?.id}?${buildQuery()}`,
        flowPropertyId: flowProperty?.id,
        responseStatus: flowData ? 'Success' : 'No data',
        dataPoints: flowData?.data?.length || 0,
        flowProperty: flowProperty,
        rawResponse: flowData
    }, 'info');

    // 5) Process the data using parseTsArray
    const tempResult = parseTsArray(tempData.data || []);
    const flowResult = parseTsArray(flowData.data || []);

    // Log processed results
    logToConsole('Processed flow data:', 'info');
    logToConsole({
        flowTimes: flowResult.times.length,
        flowValues: flowResult.values.length,
        sampleTimes: flowResult.times.slice(0, 3),
        sampleValues: flowResult.values.slice(0, 3),
        rawFlowData: flowData.data
    }, 'info');

    // For warning and critical status, we'll use the current values since they're boolean
    const warningProperty = properties.find(p => p.name === 'warning');
    const criticalProperty = properties.find(p => p.name === 'critical');
    
    // Convert boolean values to 1 or 0 for the graph
    const currentWarningValue = warningProperty?.last_value === true || warningProperty?.last_value === "true" ? 1 : 0;
    const currentCriticalValue = criticalProperty?.last_value === true || criticalProperty?.last_value === "true" ? 1 : 0;

    // Log the boolean values for debugging
    logToConsole('Status values:', {
        warningRaw: warningProperty?.last_value,
        warningConverted: currentWarningValue,
        criticalRaw: criticalProperty?.last_value,
        criticalConverted: currentCriticalValue
    }, 'info');

    // 6) Use the first available time series for timestamps
    const primaryTimes = tempResult.times.length ? tempResult.times :
                        flowResult.times.length ? flowResult.times : 
                        [new Date().toISOString()];

    // Log processed data
    logToConsole('Processed data:', 'info');
    logToConsole(`Temperature times: ${tempResult.times.length}`, 'info');
    logToConsole(`Temperature values: ${tempResult.values.length}`, 'info');
    logToConsole(`Flow rate times: ${flowResult.times.length}`, 'info');
    logToConsole(`Flow rate values: ${flowResult.values.length}`, 'info');
    logToConsole('Warning status:', warningProperty?.last_value, 'info');
    logToConsole('Critical status:', criticalProperty?.last_value, 'info');

    // Add detailed flow rate data logging
    logToConsole('Flow rate data details:', 'info');
    if (flowResult.times.length > 0) {
        const flowDataDetails = flowResult.times.map((time, index) => ({
            timestamp: new Date(time).toLocaleString(),
            value: flowResult.values[index]
        }));
        logToConsole(flowDataDetails, 'info');
    } else {
        logToConsole('No flow rate data available', 'warning');
    }

    // 7) Return formatted data for the charts
    return {
      timestamps: primaryTimes.map(t => new Date(t).toLocaleString()),
      temperature: tempResult.values,
      timeSinceFlow: flowResult.values,
      // For boolean properties, return arrays with the current value repeated
      warningStatus: new Array(primaryTimes.length).fill(currentWarningValue),
      criticalStatus: new Array(primaryTimes.length).fill(currentCriticalValue),
      iceLevel: tempResult.values?.map(celsius => {
        if (celsius === null || celsius === undefined) return null;
        const f = (celsius * 9) / 5 + 32;
        return f <= 34 ? 100 : 0;
      }) || []
    };
  } catch (error) {
    logToConsole(`Error fetching timeseries: ${error.message}`, 'error');
    return null;
  }
}

        function updateStatusGraph(deviceIndex, selectedDay) {
            const device = window.lastDevicesData[deviceIndex];
            updateTimeRangeButtons('status-time-range', selectedDay);
            
            logToConsole('Starting updateStatusGraph:', {
                deviceIndex,
                selectedDay,
                deviceId: device.id
            });
            
            fetchTimeSeriesData(device.id, 72).then(data => {
                if (!data) {
                    logToConsole('No data returned from fetchTimeSeriesData', 'error');
                    return;
                }

                // Get the start and end of the selected day
                const now = new Date();
                const dayStart = new Date(now);
                dayStart.setDate(dayStart.getDate() - selectedDay);
                dayStart.setHours(0, 0, 0, 0);
                
                const dayEnd = new Date(dayStart);
                dayEnd.setHours(23, 59, 59, 999);

                // For today, only show data up to current time
                const currentTime = selectedDay === 0 ? now : dayEnd;

                // Process the data
                const processedData = [];
                const timestamps = data.timestamps || [];
                const warningStatus = data.warningStatus || [];
                const criticalStatus = data.criticalStatus || [];

                // Log raw data for debugging
                logToConsole('Raw status data:', {
                    timestamps: timestamps.length,
                    warningStatus: warningStatus.length,
                    criticalStatus: criticalStatus.length,
                    sampleData: {
                        timestamps: timestamps.slice(0, 5),
                        warning: warningStatus.slice(0, 5),
                        critical: criticalStatus.slice(0, 5)
                    }
                });

                // Process each data point
                for (let i = 0; i < timestamps.length; i++) {
                    const timestamp = new Date(timestamps[i]);
                    if (timestamp >= dayStart && timestamp <= currentTime) {
                        const warning = warningStatus[i];
                        const critical = criticalStatus[i];
                        
                        processedData.push({
                            timestamp: timestamp,
                            warning: warning,
                            critical: critical,
                            great: (!warning && !critical) ? 1 : 0
                        });
                    }
                }

                // Log processed data
                logToConsole('Processed status data:', {
                    totalPoints: processedData.length,
                    samplePoints: processedData.slice(0, 3),
                    timeRange: {
                        start: dayStart.toLocaleString(),
                        end: currentTime.toLocaleString()
                    }
                });

                // Sort data by timestamp
                processedData.sort((a, b) => a.timestamp - b.timestamp);

                // Create datasets with improved styling
                const datasets = [
                    {
                        label: 'Great',
                        data: processedData.map(d => d.great),
                        borderColor: 'rgb(16, 185, 129)',
                        backgroundColor: 'rgba(16, 185, 129, 0.2)',
                        borderWidth: 2,
                        tension: 0.1,
                        fill: true,
                        stepped: 'before',
                        pointStyle: 'circle',
                        pointRadius: 3,
                        pointHoverRadius: 5,
                        spanGaps: true,
                        order: 3
                    },
                    {
                        label: 'Warning',
                        data: processedData.map(d => d.warning),
                        borderColor: 'rgb(234, 179, 8)',
                        backgroundColor: 'rgba(234, 179, 8, 0.2)',
                        borderWidth: 2,
                        tension: 0.1,
                        fill: true,
                        stepped: 'before',
                        pointStyle: 'circle',
                        pointRadius: 3,
                        pointHoverRadius: 5,
                        spanGaps: true,
                        order: 2
                    },
                    {
                        label: 'Critical',
                        data: processedData.map(d => d.critical),
                        borderColor: 'rgb(239, 68, 68)',
                        backgroundColor: 'rgba(239, 68, 68, 0.2)',
                        borderWidth: 2,
                        tension: 0.1,
                        fill: true,
                        stepped: 'before',
                        pointStyle: 'circle',
                        pointRadius: 3,
                        pointHoverRadius: 5,
                        spanGaps: true,
                        order: 1
                    }
                ];

                // Format timestamps for display
                const labels = processedData.map(d => {
                    return d.timestamp.toLocaleTimeString([], { 
                        hour: '2-digit', 
                        minute: '2-digit'
                    });
                });

                // Destroy existing chart if it exists
                const chartElement = document.getElementById('statusChart');
                const existingChart = Chart.getChart(chartElement);
                if (existingChart) {
                    existingChart.destroy();
                }

                // Create new chart
                const ctx = chartElement.getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'nearest',
                            axis: 'x',
                            intersect: false
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    title: (context) => {
                                        return `Time: ${context[0].label}`;
                                    },
                                    label: (context) => {
                                        const value = context.raw;
                                        const status = context.dataset.label;
                                        return `${status}: ${value === 1 ? 'Yes' : 'No'}`;
                                    }
                                },
                                titleAlign: 'center',
                                bodyAlign: 'left',
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 12,
                                titleFont: { size: 13, weight: 'bold' },
                                bodyFont: { size: 12 }
                            },
                            legend: {
                                position: 'top',
                                labels: {
                                    usePointStyle: true,
                                    padding: 15,
                                    font: { size: 12 }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Time',
                                    font: { size: 12 }
                                },
                                grid: {
                                    display: true,
                                    drawOnChartArea: true,
                                    color: 'rgba(0, 0, 0, 0.1)'
                                },
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45,
                                    font: { size: 11 }
                                }
                            },
                            y: {
                                min: -0.1,
                                max: 1.1,
                                title: {
                                    display: true,
                                    text: 'State',
                                    font: { size: 12 }
                                },
                                grid: {
                                    display: true,
                                    drawOnChartArea: true,
                                    color: 'rgba(0, 0, 0, 0.1)'
                                },
                                ticks: {
                                    callback: value => {
                                        if (value <= 0) return 'No';
                                        if (value >= 1) return 'Yes';
                                        return '';
                                    },
                                    stepSize: 1,
                                    font: { size: 11 }
                                }
                            }
                        }
                    }
                });

                // Calculate time in each state
                const timeInStates = {
                    great: 0,
                    warning: 0,
                    critical: 0
                };

                for (let i = 0; i < processedData.length - 1; i++) {
                    const duration = processedData[i + 1].timestamp - processedData[i].timestamp;
                    if (processedData[i].critical) {
                        timeInStates.critical += duration;
                    } else if (processedData[i].warning) {
                        timeInStates.warning += duration;
                    } else {
                        timeInStates.great += duration;
                    }
                }

                const totalTime = processedData.length > 0 ? 
                    processedData[processedData.length - 1].timestamp - processedData[0].timestamp : 0;

                // Add status summary below the graph
                const summaryDiv = document.createElement('div');
                summaryDiv.className = 'mt-4 grid grid-cols-3 gap-4';
                summaryDiv.innerHTML = `
                    <div class="p-3 bg-emerald-50 rounded-lg">
                        <h5 class="text-sm font-medium text-emerald-800">Great State</h5>
                        <p class="text-xs text-emerald-600 mt-1">Duration: ${formatDuration(timeInStates.great)}</p>
                        <p class="text-xs text-emerald-600">${totalTime ? Math.round((timeInStates.great / totalTime) * 100) : 0}% of time</p>
                    </div>
                    <div class="p-3 bg-yellow-50 rounded-lg">
                        <h5 class="text-sm font-medium text-yellow-800">Warning State</h5>
                        <p class="text-xs text-yellow-600 mt-1">Duration: ${formatDuration(timeInStates.warning)}</p>
                        <p class="text-xs text-yellow-600">${totalTime ? Math.round((timeInStates.warning / totalTime) * 100) : 0}% of time</p>
                    </div>
                    <div class="p-3 bg-red-50 rounded-lg">
                        <h5 class="text-sm font-medium text-red-800">Critical State</h5>
                        <p class="text-xs text-red-600 mt-1">Duration: ${formatDuration(timeInStates.critical)}</p>
                        <p class="text-xs text-red-600">${totalTime ? Math.round((timeInStates.critical / totalTime) * 100) : 0}% of time</p>
                    </div>
                `;

                // Update the summary on the page
                const chartContainer = chartElement.parentElement;
                const existingSummary = chartContainer.nextElementSibling;
                if (existingSummary && existingSummary.classList.contains('mt-4')) {
                    existingSummary.remove();
                }
                chartContainer.after(summaryDiv);

                // Log time in states calculation
                logToConsole('Time in states calculation:', {
                    totalDuration: formatDuration(totalTime),
                    breakdown: {
                        great: {
                            duration: formatDuration(timeInStates.great),
                            percentage: totalTime ? Math.round((timeInStates.great / totalTime) * 100) : 0
                        },
                        warning: {
                            duration: formatDuration(timeInStates.warning),
                            percentage: totalTime ? Math.round((timeInStates.warning / totalTime) * 100) : 0
                        },
                        critical: {
                            duration: formatDuration(timeInStates.critical),
                            percentage: totalTime ? Math.round((timeInStates.critical / totalTime) * 100) : 0
                        }
                    }
                });
            }).catch(error => {
                logToConsole(`Error updating status graph: ${error.message}`, 'error');
            });
        }

        // Helper function to fetch property time series data
        async function fetchPropertyTimeSeries(deviceId, propertyName, hours) {
            try {
                const endTime = new Date();
                const startTime = new Date(endTime);
                startTime.setHours(startTime.getHours() - hours);

                // Find the property ID from the device's properties
                const device = window.lastDevicesData.find(d => d.id === deviceId);
                const property = device.thing?.properties?.find(p => p.name === propertyName);
                
                if (!property) {
                    throw new Error(`Property ${propertyName} not found`);
                }

                // Use the property ID in the API call
                const response = await fetch(`${API_URL}/api/iot/v2/devices/${deviceId}/properties/${property.id}/timeseries?from=${startTime.toISOString()}&to=${endTime.toISOString()}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                return {
                    timestamps: data.timestamps || [],
                    values: data.values || []
                };
            } catch (error) {
                logToConsole(`Error fetching property timeseries: ${error.message}`, 'error');
                return null;
            }
        }

        function updateFlowGraph(deviceIndex, selectedDay) {
            const device = window.lastDevicesData[deviceIndex];
            updateTimeRangeButtons('flow-time-range', selectedDay);
            
            // Get the stats container
            const statsContainer = document.getElementById('flowStats');

            // Hide or show stats based on number of selected days
            const selectedDays = Array.from(document.querySelectorAll('#flow-time-range button.active'))
                .map(btn => parseInt(btn.dataset.days));
            
            if (selectedDays.length > 1) {
                statsContainer.classList.add('opacity-50', 'pointer-events-none');
                // Clear stats when multiple days are selected
                document.getElementById('flowRange').textContent = '-';
                document.getElementById('flowTotal').textContent = '-';
                document.getElementById('flowStdDev').textContent = '-';
                document.getElementById('flowFrequency').textContent = '-';
                } else {
                statsContainer.classList.remove('opacity-50', 'pointer-events-none');
            }
            
            fetchTimeSeriesData(device.id, 72).then(data => {
                if (!data) {
                    logToConsole('No data returned from fetchTimeSeriesData', 'error');
                    return;
                }

                // Destroy existing chart if it exists
                const chartElement = document.getElementById('flowChart');
                const existingChart = Chart.getChart(chartElement);
                if (existingChart) {
                    existingChart.destroy();
                }

                // Remove any existing no-data message
                const chartContainer = chartElement.parentElement;
                const existingMessage = chartContainer.querySelector('.no-data-message');
                if (existingMessage) {
                    existingMessage.remove();
                }

                // Get the start and end of the selected day
            const now = new Date();
            const dayStart = new Date(now);
            dayStart.setDate(dayStart.getDate() - selectedDay);
            dayStart.setHours(0, 0, 0, 0);
            
            const dayEnd = new Date(dayStart);
            dayEnd.setHours(23, 59, 59, 999);

                // For today, only show data up to current time
                const currentTime = selectedDay === 0 ? now : dayEnd;

                // Filter data for the selected day
                const dayData = [];
                const timestamps = data.timestamps || [];
                const flowValues = data.timeSinceFlow || [];
                let allFlowValues = [];

                for (let i = 0; i < timestamps.length; i++) {
                    const timestamp = new Date(timestamps[i]);
                    if (timestamp >= dayStart && timestamp <= currentTime) {
                        const value = flowValues[i];
                        if (value !== null && value !== undefined) {
                            dayData.push({
                                timestamp: timestamp,
                                value: value
                            });
                            allFlowValues.push(value);
                        }
                    }
                }

                // Update statistics if we have data for a single day
                if (selectedDays.length === 1 && allFlowValues.length > 0) {
                    // Calculate daily range
                    const minFlow = Math.min(...allFlowValues);
                    const maxFlow = Math.max(...allFlowValues);
                    document.getElementById('flowRange').textContent = 
                        `${minFlow.toFixed(3)} - ${maxFlow.toFixed(3)}`;

                    // Calculate total flow for the day
                    const totalFlow = allFlowValues.reduce((a, b) => a + b, 0);
                    document.getElementById('flowTotal').textContent = 
                        totalFlow.toFixed(3);
                
                // Calculate standard deviation
                    const stdDev = calculateStdDev(allFlowValues);
                    document.getElementById('flowStdDev').textContent = 
                        `±${stdDev.toFixed(3)}`;

                    // Calculate frequency (number of data points)
                    document.getElementById('flowFrequency').textContent = 
                        `${allFlowValues.length} points`;
                } else {
                    // Clear stats when no data or multiple days selected
                    document.getElementById('flowRange').textContent = '-';
                    document.getElementById('flowTotal').textContent = '-';
                    document.getElementById('flowStdDev').textContent = '-';
                    document.getElementById('flowFrequency').textContent = '-';
                }

                // Check if we have any data for the selected day
                if (dayData.length === 0) {
                    // Show no data message
                    const noDataMessage = document.createElement('div');
                    noDataMessage.className = 'absolute inset-0 flex items-center justify-center no-data-message';
                    noDataMessage.innerHTML = `
                        <div class="text-gray-500 text-center">
                            <p class="text-lg font-medium">No flow rate data available</p>
                            <p class="text-sm">for ${selectedDay === 0 ? 'today' : selectedDay === 1 ? 'yesterday' : '2 days ago'}</p>
                        </div>
                    `;
                    chartContainer.appendChild(noDataMessage);
                    return;
                }

                // Sort data by timestamp
                dayData.sort((a, b) => a.timestamp - b.timestamp);

                // Create the chart
                const ctx = chartElement.getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: dayData.map(d => d.timestamp.toLocaleTimeString([], { 
                            hour: '2-digit', 
                            minute: '2-digit'
                        })),
                        datasets: [{
                            label: 'Flow Rate',
                            data: dayData.map(d => d.value),
                            borderColor: 'rgb(34, 197, 94)',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                tension: 0.1,
                fill: true,
                            pointRadius: 3,
                            pointHoverRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    title: (context) => {
                                        return `Time: ${context[0].label}`;
                                    },
                                    label: (context) => {
                                        const value = context.raw;
                                        return `Flow Rate: ${value?.toFixed(3) || 'No data'}`;
                                    }
                                },
                                titleAlign: 'center',
                                bodyAlign: 'left',
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleFont: { size: 13, weight: 'bold' },
                                bodyFont: { size: 12 },
                                padding: 12
                            },
                            legend: {
                                position: 'top',
                                labels: {
                                    usePointStyle: true,
                                    padding: 15
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Time'
                                },
                                grid: {
                                    display: true,
                                    drawOnChartArea: true
                                },
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            },
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Flow Rate'
                                },
                                grid: {
                                    display: true,
                                    drawOnChartArea: true
                                }
                            }
                        }
                    }
                });

                // Update time since last flow stat
                const timeSinceLastFlowEl = document.getElementById('timeSinceLastFlow');
                if (selectedDay === 0 && dayData.length > 0) {
                    // Get the most recent flow data point
                    const lastFlowTime = dayData[dayData.length - 1].timestamp;
                    const timeSinceFlow = now - lastFlowTime;
                    timeSinceLastFlowEl.textContent = formatTimeDuration(timeSinceFlow);
                } else {
                    // For past days or no data, show disabled state
                    timeSinceLastFlowEl.textContent = selectedDay === 0 ? '-' : 'N/A for past days';
                }
            }).catch(error => {
                logToConsole(`Error updating flow graph: ${error.message}`, 'error');
            });
        }

        function updateTimeRangeButtons(containerId, selectedDay) {
            const container = document.getElementById(containerId);
            container.querySelectorAll('.time-range-button').forEach(button => {
                const days = parseInt(button.dataset.days);
                if (days === selectedDay) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });
        }

        // Fetch devices immediately and then every 6 hours (6 * 60 * 60 * 1000 ms)
        fetchDevices();
        const interval = setInterval(fetchDevices, 21600000);  // 6 hours in milliseconds

        // Cleanup interval when page is unloaded
        window.addEventListener('unload', () => {
            clearInterval(interval);
        });

        function showDisclaimer() {
            const modal = document.getElementById('disclaimer-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function hideDisclaimer() {
            const modal = document.getElementById('disclaimer-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function showContact() {
            const modal = document.getElementById('contact-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function hideContact() {
            const modal = document.getElementById('contact-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
    </script>
</body>
</html> 