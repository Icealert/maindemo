<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IceAlert - Commercial & Residential Ice Machine Monitoring</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
        }

        .device-card {
            transition: all 0.2s ease-in-out;
            border: 1px solid rgba(226, 232, 240, 0.8);
            backdrop-filter: blur(8px);
            background: rgba(255, 255, 255, 0.9);
        }

        .device-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }

        .stat-card {
            transition: transform 0.2s ease;
        }

        .stat-card:hover {
            transform: scale(1.05);
        }

        .glass-nav {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(226, 232, 240, 0.8);
        }

        .property-card {
            transition: all 0.2s ease;
        }

        .property-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .connected-badge {
            animation: pulse 2s infinite;
        }

        .modal-content {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        }

        @keyframes flash-red {
            0%, 100% { 
                color: #991B1B; 
                background-color: #FEE2E2;
            }
            50% { 
                color: #DC2626; 
                background-color: #FEF2F2;
            }
        }

        .temp-warning {
            animation: flash-red 2s infinite;
            padding: 2px 6px;
            border-radius: 4px;
        }

        @keyframes flash-red-box {
            0%, 100% { 
                background: linear-gradient(to bottom right, #FEE2E2, #FEF2F2);
                border-color: #DC2626;
            }
            50% { 
                background: linear-gradient(to bottom right, #FEF2F2, #FEE2E2);
                border-color: #991B1B;
            }
        }

        .temp-warning-box, .flow-warning-box {
            animation: flash-red-box 2s infinite;
            border: 1px solid;
        }

        .temp-warning-box *, .flow-warning-box * {
            color: #991B1B !important;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="glass-nav sticky top-0 z-40">
        <div class="container mx-auto px-4 py-3">
            <div class="flex flex-col space-y-3">
                <!-- Top Row -->
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-3">
                        <svg class="w-8 h-8 text-blue-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 3v18M12 3l4 4M12 3L8 7M12 21l4-4M12 21l-4-4M3 12h18M3 12l4-4M3 12l4 4M21 12l-4-4M21 12l-4 4" 
                                  stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <div>
                            <h1 class="text-2xl font-bold text-gray-800">IceAlert</h1>
                            <p class="text-sm text-gray-600">Commercial & Residential Ice Machine Monitoring</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-3">
                            <div class="stat-card text-center px-3 py-1 bg-blue-50 rounded-md cursor-pointer hover:bg-blue-100 transition-all shadow-sm" onclick="showActiveDevices()">
                                <p class="text-xs font-medium text-blue-600">Active Devices</p>
                                <p class="text-lg font-bold text-blue-700" id="activeDevicesCount">-</p>
                            </div>
                            <div class="text-center px-3 py-1 bg-green-50 rounded-md cursor-pointer hover:bg-green-100 transition-colors" onclick="showConnectedDevices()">
                                <p class="text-xs font-medium text-green-600">Connected</p>
                                <p class="text-lg font-bold text-green-700" id="connectedDevicesCount">-</p>
                            </div>
                            <div class="text-center px-3 py-1 bg-emerald-50 rounded-md cursor-pointer hover:bg-emerald-100 transition-colors" onclick="showGreatDevices()">
                                <p class="text-xs font-medium text-emerald-600">Great</p>
                                <p class="text-lg font-bold text-emerald-700" id="greatDevicesCount">-</p>
                            </div>
                            <div class="text-center px-3 py-1 bg-yellow-50 rounded-md cursor-pointer hover:bg-yellow-100 transition-colors" onclick="showWarningDevices()">
                                <p class="text-xs font-medium text-yellow-600">Warning</p>
                                <p class="text-lg font-bold text-yellow-700" id="warningDevicesCount">-</p>
                            </div>
                            <div class="text-center px-3 py-1 bg-red-50 rounded-md cursor-pointer hover:bg-red-100 transition-colors" onclick="showCriticalDevices()">
                                <p class="text-xs font-medium text-red-600">Critical</p>
                                <p class="text-lg font-bold text-red-700" id="criticalDevicesCount">-</p>
                            </div>
                        </div>
                        <button onclick="toggleConsole()" class="bg-gray-800 text-white px-3 py-1.5 rounded-md hover:bg-gray-700 text-sm font-medium transition-colors">
                            Debug Console
                        </button>
                    </div>
                </div>
                <!-- Bottom Row -->
                <div class="flex items-center justify-between border-t pt-2">
                    <p class="text-sm text-gray-600">Real-time monitoring and alerts for ice machines and water systems</p>
                    <div class="flex items-center text-sm text-gray-500">
                        <span>Last Update: </span>
                        <span id="lastUpdateTime" class="ml-1 text-gray-700">-</span>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-6">
        <!-- Debug Console -->
        <div id="debug-console" class="mb-4 hidden">
            <div class="bg-gray-900 text-green-400 p-4 rounded-lg shadow-lg font-mono text-sm overflow-auto border border-gray-700" style="max-height: 300px; backdrop-filter: blur(8px);">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-white font-bold">Debug Console</h3>
                    <button onclick="clearConsole()" class="text-gray-400 hover:text-white transition-colors">Clear</button>
                </div>
                <div id="console-output" class="whitespace-pre-wrap"></div>
            </div>
        </div>
        
        <!-- Loading and Error States -->
        <div id="status" class="mb-4 text-center hidden">
            <div class="inline-flex items-center px-4 py-2 bg-blue-50 rounded-lg">
                <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-2"></div>
                <p class="text-sm font-medium text-blue-600">Loading devices...</p>
            </div>
        </div>
        
        <div id="error" class="mb-4 hidden">
            <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg" role="alert">
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <div>
                        <p class="font-medium">Error</p>
                        <p class="text-sm" id="error-message"></p>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="devices" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Devices will be populated here -->
        </div>
    </div>

    <script>
        const statusEl = document.getElementById('status');
        const errorEl = document.getElementById('error');
        const errorMessageEl = document.getElementById('error-message');
        const devicesContainer = document.getElementById('devices');
        const consoleOutput = document.getElementById('console-output');
        const debugConsole = document.getElementById('debug-console');

        // Debug Console Functions
        function toggleConsole() {
            debugConsole.classList.toggle('hidden');
        }

        function clearConsole() {
            consoleOutput.innerHTML = '';
        }

        function logToConsole(data, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type === 'error' ? 'text-red-400' : 
                             type === 'warning' ? 'text-yellow-400' : 
                             'text-green-400';
            
            const logEntry = document.createElement('div');
            logEntry.className = colorClass;
            logEntry.innerHTML = `[${timestamp}] ${typeof data === 'object' ? JSON.stringify(data, null, 2) : data}`;
            
            consoleOutput.appendChild(logEntry);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        function showLoading() {
            statusEl.classList.remove('hidden');
            errorEl.classList.add('hidden');
            devicesContainer.innerHTML = '';
        }

        function showError(message) {
            statusEl.classList.add('hidden');
            errorEl.classList.remove('hidden');
            errorMessageEl.textContent = message;
            logToConsole(message, 'error');
        }

        function hideLoading() {
            statusEl.classList.add('hidden');
        }

        async function checkServerHealth() {
            try {
                const response = await fetch('http://localhost:3000/health');
                if (!response.ok) throw new Error('Server health check failed');
                return true;
            } catch (error) {
                console.error('Server health check failed:', error);
                logToConsole('Server health check failed: ' + error.message, 'error');
                return false;
            }
        }

        function updateLastUpdateTime() {
            const now = new Date();
            document.getElementById('lastUpdateTime').textContent = now.toLocaleTimeString();
        }

        async function fetchDevices() {
            showLoading();
            
            try {
                // First check if server is healthy
                const isHealthy = await checkServerHealth();
                if (!isHealthy) {
                    throw new Error('Server is not responding. Please make sure the server is running.');
                }

                const response = await fetch('http://localhost:3000/api/devices');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const devices = await response.json();
                
                if (devices.error) {
                    throw new Error(devices.message || devices.error);
                }
                
                // Sort devices by name
                devices.sort((a, b) => {
                    // Extract numbers from device names (assuming format like "001", "002", etc.)
                    const aNum = parseInt(a.name.replace(/\D/g, '')) || 0;
                    const bNum = parseInt(b.name.replace(/\D/g, '')) || 0;
                    return aNum - bNum;
                });
                
                // Store the sorted devices data for modal use
                window.lastDevicesData = devices;
                
                // Update last update time
                updateLastUpdateTime();
                
                // Log raw device data to console
                logToConsole('Received device data (sorted):');
                logToConsole(devices);
                
                displayDevices(devices);
                hideLoading();
            } catch (error) {
                console.error('Error fetching devices:', error);
                showError(error.message || 'Failed to fetch devices. Please try again later.');
            }
        }

        function formatPropertyValue(property) {
            if (property.last_value === undefined || property.last_value === null) {
                return 'N/A';
            }

            switch(property.type) {
                case 'BOOL':
                    return property.last_value ? 'True' : 'False';
                case 'FLOAT':
                    // Format float values to 2 decimal places
                    return Number(property.last_value).toFixed(2);
                case 'INT':
                    return property.last_value.toString();
                case 'STRING':
                    return property.last_value;
                default:
                    return property.last_value;
            }
        }

        function getPropertyInputType(property) {
            switch(property.type) {
                case 'BOOL':
                    return 'checkbox';
                case 'INT':
                case 'FLOAT':
                    return 'number';
                default:
                    return 'text';
            }
        }

        function getPropertyStep(property) {
            switch(property.type) {
                case 'FLOAT':
                    return '0.01';
                case 'INT':
                    return '1';
                default:
                    return 'any';
            }
        }

        function fahrenheitToCelsius(fahrenheit) {
            return (fahrenheit - 32) * 5/9;
        }

        async function updatePropertyValue(deviceId, property) {
            try {
                if (!deviceId || !property) {
                    throw new Error('Device ID and Property are required');
                }

                // Log the update attempt with all details
                logToConsole({
                    message: 'Attempting to update property',
                    deviceId: deviceId,
                    propertyName: property.name,
                    currentValue: property.last_value,
                    newValue: property.new_value,
                    propertyType: property.type
                }, 'info');

                // Format the value based on type
                let formattedValue;
                switch(property.type) {
                    case 'INT':
                        formattedValue = parseInt(property.new_value);
                        if (isNaN(formattedValue)) {
                            throw new Error('Invalid integer value');
                        }
                        break;
                    case 'FLOAT':
                        // Convert Fahrenheit to Celsius if this is a temperature property
                        if (property.name.toLowerCase().includes('temp')) {
                            formattedValue = fahrenheitToCelsius(parseFloat(property.new_value));
                        } else {
                            formattedValue = parseFloat(property.new_value);
                        }
                        if (isNaN(formattedValue)) {
                            throw new Error('Invalid float value');
                        }
                        break;
                    case 'BOOL':
                        formattedValue = String(property.new_value).toLowerCase() === 'true';
                        break;
                    case 'CHARSTRING':
                    case 'STATUS':
                        formattedValue = String(property.new_value).trim();
                        if (!formattedValue) {
                            throw new Error('Value cannot be empty');
                        }
                        break;
                    default:
                        formattedValue = property.new_value;
                }

                // Using V2 API endpoint format and structure
                const apiUrl = `http://localhost:3000/api/iot/v2/devices/${deviceId}/properties`;

                // Construct payload exactly as per Arduino V2 API docs
                const requestBody = {
                    propertiesValues: {
                        input: true,
                        properties: [{
                            name: property.name,
                            type: property.type,
                            value: formattedValue
                        }]
                    }
                };

                logToConsole({
                    message: 'Sending update request',
                    url: apiUrl,
                    body: requestBody
                }, 'info');

                const response = await fetch(apiUrl, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'X-Organization': property.organization_id || ''  // Add organization ID if available
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => null);
                    throw new Error(errorData?.error || `HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                logToConsole({
                    message: 'Update successful',
                    deviceId: deviceId,
                    propertyName: property.name,
                    response: result
                }, 'info');

                // Refresh the devices list to show the new value
                fetchDevices();
            } catch (error) {
                logToConsole({
                    message: 'Error updating property',
                    error: error.message,
                    deviceId: deviceId,
                    propertyName: property?.name
                }, 'error');
                showError(`Failed to update property: ${error.message}`);
            }
        }

        function handlePropertyUpdate(event, deviceId, property) {
            if (event.key === 'Enter') {
                const newValue = event.target.value;
                property.new_value = newValue;
                updatePropertyValue(deviceId, property);
            }
        }

        function handlePropertyInputKeydown(event) {
            if (event.key === 'Enter') {
                const input = event.target;
                const deviceId = input.dataset.deviceId;
                
                try {
                    const property = JSON.parse(input.dataset.property);
                    property.new_value = input.value;
                    
                    if (!deviceId) {
                        throw new Error('Device ID is missing');
                    }
                    
                    updatePropertyValue(deviceId, property);
                } catch (error) {
                    logToConsole(`Error handling property input: ${error.message}`, 'error');
                    showError(`Failed to handle property input: ${error.message}`);
                }
            }
        }

        function handlePropertyInputChange(event) {
            const input = event.target;
            const deviceId = input.dataset.deviceId;
            
            try {
                const property = JSON.parse(input.dataset.property);
                property.new_value = input.type === 'checkbox' ? input.checked : input.value;
                
                if (!deviceId) {
                    throw new Error('Device ID is missing');
                }
                
                updatePropertyValue(deviceId, property);
            } catch (error) {
                logToConsole(`Error handling property input: ${error.message}`, 'error');
                showError(`Failed to handle property input: ${error.message}`);
            }
        }

        function getPropertyBgColor(propertyName) {
            const colorMap = {
                'temp': 'bg-blue-50',
                'temperature': 'bg-blue-50',
                'humidity': 'bg-green-50',
                'flow': 'bg-purple-50',
                'pressure': 'bg-yellow-50',
                'level': 'bg-indigo-50',
                'status': 'bg-gray-50'
            };

            for (const [key, color] of Object.entries(colorMap)) {
                if (propertyName.toLowerCase().includes(key)) {
                    return color;
                }
            }
            return 'bg-gray-50';
        }

        function getPropertyTextColor(propertyName) {
            const colorMap = {
                'temp': 'text-blue-800',
                'temperature': 'text-blue-800',
                'humidity': 'text-green-800',
                'flow': 'text-purple-800',
                'pressure': 'text-yellow-800',
                'level': 'text-indigo-800',
                'status': 'text-gray-800'
            };

            for (const [key, color] of Object.entries(colorMap)) {
                if (propertyName.toLowerCase().includes(key)) {
                    return color;
                }
            }
            return 'text-gray-800';
        }

        function celsiusToFahrenheit(celsius) {
            if (celsius === undefined || celsius === null) return undefined;
            return (celsius * 9/5) + 32;
        }

        function formatTemperature(celsius, maxThreshold = null) {
            if (celsius === undefined || celsius === null) return 'N/A';
            const fahrenheit = celsiusToFahrenheit(celsius);
            const value = `${fahrenheit.toFixed(1)}Â°F`;
            
            if (maxThreshold !== null && celsius >= maxThreshold) {
                return `<span class="temp-warning">${value}</span>`;
            }
            return value;
        }

        function getTemperatureCardClass(temp, maxThreshold) {
            if (temp === undefined || temp === null || maxThreshold === undefined || maxThreshold === null) {
                return 'bg-gradient-to-br from-blue-50 to-blue-100';
            }
            return temp >= maxThreshold ? 'temp-warning-box' : 'bg-gradient-to-br from-blue-50 to-blue-100';
        }

        function formatTimeDuration(milliseconds) {
            if (!milliseconds) return 'N/A';
            
            const seconds = Math.floor(milliseconds / 1000);
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const remainingSeconds = seconds % 60;
            
            return `${hours}h ${minutes}m ${remainingSeconds}s`;
        }

        // Store timers for cleanup
        let timeSinceFlowTimers = [];

        function clearTimeSinceFlowTimers() {
            timeSinceFlowTimers.forEach(timer => clearInterval(timer));
            timeSinceFlowTimers = [];
        }

        function getFlowCardClass(timeSinceFlowHours, criticalTime) {
            if (timeSinceFlowHours === null || criticalTime === undefined || criticalTime === null) {
                return 'bg-gradient-to-br from-green-50 to-green-100';
            }
            console.log('Time comparison:', { timeSinceFlowHours, criticalTime, isWarning: timeSinceFlowHours >= criticalTime });
            return parseFloat(timeSinceFlowHours) >= parseFloat(criticalTime) ? 'flow-warning-box' : 'bg-gradient-to-br from-green-50 to-green-100';
        }

        function updateTimeSinceFlow(element, startTime) {
            if (!startTime) {
                element.textContent = 'N/A';
                return null;
            }

            const criticalTime = parseFloat(element.dataset.criticalTime);
            const cardElement = element.closest('.property-card');

            const update = () => {
                const timeSinceFlowMs = new Date() - new Date(startTime);
                const timeSinceFlowHours = timeSinceFlowMs / (1000 * 60 * 60);
                element.textContent = formatTimeDuration(timeSinceFlowMs);
                
                // Update warning state
                cardElement.className = `property-card ${getFlowCardClass(timeSinceFlowHours, criticalTime)} p-2 rounded-lg`;
                
                // Log for debugging
                console.log('Flow status:', {
                    timeSinceFlowHours,
                    criticalTime,
                    isWarning: timeSinceFlowHours >= criticalTime
                });
            };

            update(); // Initial update
            const timer = setInterval(update, 1000); // Update every second
            timeSinceFlowTimers.push(timer);
            return timer;
        }

        function calculateDeviceStatus(device) {
            // Find the r_status event to determine connection status
            const statusEvent = device.events?.find(event => event.name === 'r_status');
            const isConnected = statusEvent?.value === 'CONNECTED';

            // Find key properties
            const properties = device.thing?.properties || [];
            
            // Get cloud temperature
            const cloudTemp = properties.find(p => 
                p.name === 'cloudtemp'
            )?.last_value;

            // Get temperature threshold max
            const tempThresholdMax = properties.find(p => 
                p.name === 'tempThresholdMax'
            )?.last_value;

            // Get ultrasonic sensor value
            const ultrasonic = properties.find(p => 
                p.name === 'ultrasonic'
            )?.last_value;

            // Get flow related properties
            const cloudFlowRate = properties.find(p => 
                p.name === 'cloudflowrate'
            );

            const flowThresholdMin = properties.find(p => 
                p.name === 'flowThresholdMin'
            )?.last_value;

            // Calculate time since last flow based on cloudflowrate's value_updated_at
            const flowLastUpdate = cloudFlowRate?.value_updated_at;
            const timeSinceFlowMs = flowLastUpdate ? 
                (new Date() - new Date(flowLastUpdate)) : 
                null;
            
            // Convert to hours for comparison with critical time
            const timeSinceFlowHours = timeSinceFlowMs ? 
                timeSinceFlowMs / (1000 * 60 * 60) : 
                null;

            const noFlowCriticalTime = parseFloat(properties.find(p => 
                p.name === 'noFlowCriticalTime'
            )?.last_value);

            // Get alert email
            const alertEmail = properties.find(p => 
                p.name === 'alertEmail'
            )?.last_value;

            // Device is great if and only if:
            // 1. It is connected
            // 2. Cloud temperature is less than temperature threshold max
            // 3. Time since flow is less than no flow critical time
            const isGreat = isConnected && 
                           cloudTemp !== undefined && 
                           tempThresholdMax !== undefined && 
                           cloudTemp < tempThresholdMax &&
                           timeSinceFlowHours !== null && 
                           !isNaN(noFlowCriticalTime) && 
                           timeSinceFlowHours < noFlowCriticalTime;

            return {
                isConnected,
                isGreat,
                cloudTemp,
                tempThresholdMax,
                ultrasonic,
                cloudFlowRate: cloudFlowRate?.last_value,
                flowThresholdMin,
                timeSinceFlowMs,
                timeSinceFlowHours,
                noFlowCriticalTime,
                alertEmail,
                flowLastUpdate
            };
        }

        function displayDevices(devices) {
            // Clear existing timers before updating display
            clearTimeSinceFlowTimers();

            // Update device counts
            const activeDevices = devices.length;
            const deviceStatuses = devices.map(device => calculateDeviceStatus(device));
            const connectedDevices = deviceStatuses.filter(status => status.isConnected).length;
            const greatDevices = deviceStatuses.filter(status => status.isGreat).length;
            
            document.getElementById('activeDevicesCount').textContent = activeDevices;
            document.getElementById('connectedDevicesCount').textContent = connectedDevices;
            document.getElementById('greatDevicesCount').textContent = greatDevices;

            if (!Array.isArray(devices) || devices.length === 0) {
                devicesContainer.innerHTML = `
                    <div class="col-span-full text-center py-8">
                        <div class="max-w-sm mx-auto">
                            <svg class="w-12 h-12 mx-auto text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M12 12h.01M12 12h.01M12 12h.01M12 12h.01M12 12h.01M12 12h.01M12 12h.01M12 12h.01M12 12h.01" />
                            </svg>
                            <p class="mt-4 text-gray-500 text-lg">No devices found</p>
                            <p class="mt-2 text-gray-400 text-sm">Connect a device to get started</p>
                        </div>
                    </div>
                `;
                logToConsole('No devices found', 'warning');
                return;
            }

            // Log each device's data individually with more detail
            devices.forEach((device, idx) => {
                logToConsole(`Device ${idx + 1} (${device.name || device.id}):`);
                if (device.thing && device.thing.properties) {
                    logToConsole('Properties found:');
                    device.thing.properties.forEach(prop => {
                        logToConsole(`- ${prop.name}: ${prop.last_value} (${prop.type})`);
                    });
                } else {
                    logToConsole('No properties found for this device');
                }
            });

            devicesContainer.innerHTML = devices.map((device, index) => {
                const status = calculateDeviceStatus(device);

                return `
                <div class="device-card bg-white rounded-lg shadow-sm border border-gray-200 p-3 hover:shadow-md transition-all">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h2 class="text-base font-semibold text-gray-800">${device.name || 'Unnamed Device'}</h2>
                            <p class="text-xs text-gray-500">ID: ${device.id.slice(0, 8)}...</p>
                            ${status.alertEmail ? `<p class="text-xs text-blue-600">Alert Email: ${status.alertEmail}</p>` : ''}
                        </div>
                        <span class="connected-badge px-1.5 py-0.5 text-xs font-medium rounded-full ${status.isConnected ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                            ${status.isConnected ? 'Connected' : 'Disconnected'}
                        </span>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <!-- Ultrasonic -->
                        <div class="property-card bg-gradient-to-br from-purple-50 to-purple-100 p-2 rounded-lg">
                            <p class="text-purple-800 font-medium text-xs">Ultrasonic</p>
                            <p class="text-lg font-bold text-purple-900 leading-tight">${status.ultrasonic !== undefined ? status.ultrasonic + ' cm' : 'N/A'}</p>
                        </div>
                        
                        <!-- Temperature -->
                        <div class="property-card ${getTemperatureCardClass(status.cloudTemp, status.tempThresholdMax)} p-2 rounded-lg">
                            <p class="text-blue-800 font-medium text-xs">Temperature</p>
                            <p class="text-lg font-bold text-blue-900 leading-tight">${formatTemperature(status.cloudTemp)}</p>
                            <p class="text-xs text-blue-600">
                                Max: ${formatTemperature(status.tempThresholdMax)}
                            </p>
                        </div>
                        
                        <!-- Time Since Flow -->
                        <div class="property-card ${getFlowCardClass(status.timeSinceFlowHours, status.noFlowCriticalTime)} p-2 rounded-lg">
                            <p class="text-green-800 font-medium text-xs">Time Since Flow</p>
                            <p class="text-lg font-bold text-green-900 leading-tight time-since-flow" data-start-time="${status.flowLastUpdate || ''}" data-critical-time="${status.noFlowCriticalTime || ''}">
                                ${formatTimeDuration(status.timeSinceFlowMs)}
                            </p>
                            <p class="text-xs text-green-600">
                                Critical: ${status.noFlowCriticalTime !== undefined ? status.noFlowCriticalTime + 'h' : 'N/A'}<br>
                                Last: ${status.flowLastUpdate ? new Date(status.flowLastUpdate).toLocaleTimeString() : 'N/A'}
                            </p>
                        </div>
                        
                        <!-- Status -->
                        <div class="property-card bg-gradient-to-br from-gray-50 to-gray-100 p-2 rounded-lg">
                            <p class="text-gray-800 font-medium text-xs">Status</p>
                            <p class="text-lg font-bold ${status.isGreat ? 'text-emerald-600' : 'text-gray-900'} leading-tight">
                                ${status.isGreat ? 'Great' : 'Not Great'}
                            </p>
                        </div>
                    </div>

                    <div class="flex justify-end border-t pt-2">
                        <button 
                            onclick="showDeviceDetails(${index})"
                            class="inline-flex items-center px-2 py-1 bg-blue-600 text-white text-xs font-medium rounded hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-blue-500 transition-colors"
                        >
                            <span>More Details</span>
                            <svg class="w-3 h-3 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                            </svg>
                        </button>
                    </div>
                </div>
                `;
            }).join('');

            // Start timers for all time-since-flow elements
            document.querySelectorAll('.time-since-flow').forEach(element => {
                const startTime = element.dataset.startTime;
                updateTimeSinceFlow(element, startTime);
            });

            // Add the modal container if it doesn't exist
            if (!document.getElementById('device-modal')) {
                const modalContainer = document.createElement('div');
                modalContainer.id = 'device-modal';
                modalContainer.className = 'fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50';
                modalContainer.style.position = 'fixed';
                modalContainer.style.top = '0';
                modalContainer.style.left = '0';
                modalContainer.style.right = '0';
                modalContainer.style.bottom = '0';
                modalContainer.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl p-6 m-4 max-w-4xl w-full max-h-[90vh] overflow-y-auto relative">
                        <div class="flex justify-between items-start mb-4">
                            <h2 id="modal-title" class="text-2xl font-bold text-gray-800"></h2>
                            <button onclick="hideDeviceDetails()" class="text-gray-500 hover:text-gray-700">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div id="modal-content"></div>
                    </div>
                `;
                document.body.appendChild(modalContainer);
            }

            // Add the active devices modal if it doesn't exist
            if (!document.getElementById('active-devices-modal')) {
                const activeDevicesModal = document.createElement('div');
                activeDevicesModal.id = 'active-devices-modal';
                activeDevicesModal.className = 'fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50';
                activeDevicesModal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl p-6 m-4 max-w-xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-gray-800">Active Devices</h2>
                            <button onclick="hideActiveDevices()" class="text-gray-500 hover:text-gray-700">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div id="active-devices-list" class="space-y-2"></div>
                    </div>
                `;
                document.body.appendChild(activeDevicesModal);
            }

            // Add the connected devices modal if it doesn't exist
            if (!document.getElementById('connected-devices-modal')) {
                const connectedDevicesModal = document.createElement('div');
                connectedDevicesModal.id = 'connected-devices-modal';
                connectedDevicesModal.className = 'fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50';
                connectedDevicesModal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl p-6 m-4 max-w-xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-gray-800">Connected Devices</h2>
                            <button onclick="hideConnectedDevices()" class="text-gray-500 hover:text-gray-700">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div id="connected-devices-list" class="space-y-2"></div>
                    </div>
                `;
                document.body.appendChild(connectedDevicesModal);
            }

            // Add the great devices modal if it doesn't exist
            if (!document.getElementById('great-devices-modal')) {
                const greatDevicesModal = document.createElement('div');
                greatDevicesModal.id = 'great-devices-modal';
                greatDevicesModal.className = 'fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50';
                greatDevicesModal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl p-6 m-4 max-w-xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-gray-800">Devices in Great Condition</h2>
                            <button onclick="hideGreatDevices()" class="text-gray-500 hover:text-gray-700">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div id="great-devices-list" class="space-y-2"></div>
                    </div>
                `;
                document.body.appendChild(greatDevicesModal);
            }

            // Add the warning devices modal if it doesn't exist
            if (!document.getElementById('warning-devices-modal')) {
                const warningDevicesModal = document.createElement('div');
                warningDevicesModal.id = 'warning-devices-modal';
                warningDevicesModal.className = 'fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50';
                warningDevicesModal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl p-6 m-4 max-w-xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-gray-800">Devices with Warnings</h2>
                            <button onclick="hideWarningDevices()" class="text-gray-500 hover:text-gray-700">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div id="warning-devices-list" class="space-y-2"></div>
                    </div>
                `;
                document.body.appendChild(warningDevicesModal);
            }

            // Add the critical devices modal if it doesn't exist
            if (!document.getElementById('critical-devices-modal')) {
                const criticalDevicesModal = document.createElement('div');
                criticalDevicesModal.id = 'critical-devices-modal';
                criticalDevicesModal.className = 'fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50';
                criticalDevicesModal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl p-6 m-4 max-w-xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-gray-800">Devices in Critical State</h2>
                            <button onclick="hideCriticalDevices()" class="text-gray-500 hover:text-gray-700">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div id="critical-devices-list" class="space-y-2"></div>
                    </div>
                `;
                document.body.appendChild(criticalDevicesModal);
            }
        }

        function showDeviceDetails(deviceIndex) {
            const device = window.lastDevicesData[deviceIndex];
            const modal = document.getElementById('device-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalContent = document.getElementById('modal-content');

            modalTitle.textContent = device.name || 'Device Details';
            
            // Generate the detailed view similar to the original display
            modalContent.innerHTML = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <p class="text-gray-600">ID: ${device.id || 'N/A'}</p>
                        <p class="text-gray-600">Type: ${device.type || 'N/A'}</p>
                    </div>
                        
                        ${device.thing ? `
                        <div class="mt-4">
                            <h3 class="font-medium text-gray-700 mb-2">Properties:</h3>
                            <div class="grid grid-cols-2 gap-4">
                                    ${device.thing.properties ? 
                                        device.thing.properties.map(prop => `
                                        <div class="${getPropertyBgColor(prop.name)} p-3 rounded">
                                            <p class="${getPropertyTextColor(prop.name)} font-medium">${prop.name}</p>
                                                ${prop.permission === 'READ_WRITE' ? `
                                                <div class="flex items-center space-x-2 mt-2">
                                                        ${prop.type === 'BOOL' ? `
                                                            <label class="inline-flex items-center">
                                                                <input 
                                                                    type="checkbox"
                                                                    class="form-checkbox h-5 w-5 text-blue-600"
                                                                    ${prop.last_value ? 'checked' : ''}
                                                                    data-device-id="${device.id}"
                                                                    data-property='${JSON.stringify(prop).replace(/'/g, "&apos;")}'
                                                                    onchange="handlePropertyInputChange(event)"
                                                                />
                                                                <span class="ml-2">${prop.last_value ? 'On' : 'Off'}</span>
                                                            </label>
                                                        ` : `
                                                    <div class="flex space-x-2">
                                                        <input 
                                                                type="${getPropertyInputType(prop)}"
                                                            class="w-full px-2 py-1 text-sm border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                            value="${prop.last_value || ''}"
                                                            placeholder="Enter new value"
                                                            data-device-id="${device.id}"
                                                            data-property='${JSON.stringify(prop).replace(/'/g, "&apos;")}'
                                                            onkeydown="handlePropertyInputKeydown(event)"
                                                                step="${getPropertyStep(prop)}"
                                                                ${prop.type === 'INT' || prop.type === 'FLOAT' ? `min="0"` : ''}
                                                        />
                                                        <button 
                                                            onclick="handleUpdateButtonClick(event)"
                                                            data-device-id="${device.id}"
                                                            data-property='${JSON.stringify(prop).replace(/'/g, "&apos;")}'
                                                            class="px-3 py-1 text-sm bg-blue-500 text-white rounded hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                        >
                                                            Update
                                                        </button>
                                                    </div>
                                                        `}
                                                    </div>
                                                ` : `
                                                <p class="font-medium mt-2">${formatPropertyValue(prop)}</p>
                                                `}
                                            <p class="text-xs text-gray-500 mt-2">Updated: ${new Date(prop.value_updated_at || prop.updated_at).toLocaleString()}</p>
                                            </div>
                                        `).join('') 
                                        : '<p class="text-gray-500">No properties available</p>'
                                    }
                                </div>
                            </div>
                        ` : '<p class="text-gray-500">No thing data available</p>'}
                        
                        <p class="text-xs text-gray-500 mt-4">Device Last Updated: ${new Date(device.thing?.updated_at || device.created_at).toLocaleString()}</p>
                    </div>
            `;

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function hideDeviceDetails() {
            const modal = document.getElementById('device-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function handleUpdateButtonClick(event) {
            const button = event.target;
            const deviceId = button.dataset.deviceId;
            const input = button.previousElementSibling;
            
            try {
                const property = JSON.parse(button.dataset.property);
                property.new_value = input.value;
                
                if (!deviceId) {
                    throw new Error('Device ID is missing');
                }
                
                updatePropertyValue(deviceId, property);
            } catch (error) {
                logToConsole(`Error handling update button click: ${error.message}`, 'error');
                showError(`Failed to handle update: ${error.message}`);
            }
        }

        function showActiveDevices() {
            const devices = window.lastDevicesData || [];
            const modal = document.getElementById('active-devices-modal');
            const devicesList = document.getElementById('active-devices-list');

            devicesList.innerHTML = devices.map(device => {
                const statusEvent = device.events?.find(event => event.name === 'r_status');
                const isConnected = statusEvent?.value === 'CONNECTED';
                
                return `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100">
                        <div>
                            <h3 class="font-medium text-gray-800">${device.name || 'Unnamed Device'}</h3>
                            <p class="text-sm text-gray-500">
                                ID: ${device.id}
                            </p>
                        </div>
                        <span class="px-2 py-1 text-xs font-medium rounded-full ${isConnected ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                            ${isConnected ? 'Connected' : 'Disconnected'}
                        </span>
                    </div>
                `;
            }).join('') || '<p class="text-gray-500 text-center py-4">No active devices found</p>';

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function hideActiveDevices() {
            const modal = document.getElementById('active-devices-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function showConnectedDevices() {
            const devices = window.lastDevicesData || [];
            const modal = document.getElementById('connected-devices-modal');
            const devicesList = document.getElementById('connected-devices-list');

            const connectedDevices = devices.filter(device => {
                const statusEvent = device.events?.find(event => event.name === 'r_status');
                return statusEvent?.value === 'CONNECTED';
            });

            devicesList.innerHTML = connectedDevices.length > 0 ? 
                connectedDevices.map(device => `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100">
                        <div>
                            <h3 class="font-medium text-gray-800">${device.name || 'Unnamed Device'}</h3>
                            <p class="text-sm text-gray-500">
                                ID: ${device.id}
                            </p>
                        </div>
                        <span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">
                            Connected
                        </span>
                </div>
                `).join('') 
                : '<p class="text-gray-500 text-center py-4">No connected devices found</p>';

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function hideConnectedDevices() {
            const modal = document.getElementById('connected-devices-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function showGreatDevices() {
            const devices = window.lastDevicesData || [];
            const modal = document.getElementById('great-devices-modal');
            const devicesList = document.getElementById('great-devices-list');

            const greatDevices = devices.filter(device => calculateDeviceStatus(device).isGreat);

            devicesList.innerHTML = greatDevices.length > 0 ? 
                greatDevices.map(device => {
                    const status = calculateDeviceStatus(device);
                    return `
                        <div class="flex items-center justify-between p-3 bg-emerald-50 rounded-lg hover:bg-emerald-100">
                            <div>
                                <h3 class="font-medium text-emerald-800">${device.name || 'Unnamed Device'}</h3>
                                <p class="text-sm text-emerald-600">
                                    Cloud Temp: ${formatTemperature(status.cloudTemp, status.tempThresholdMax)} (Max: ${formatTemperature(status.tempThresholdMax)})<br>
                                    Time Since Flow: ${formatTimeDuration(status.timeSinceFlowMs)} (Critical: ${status.noFlowCriticalTime}h)
                                </p>
                            </div>
                            <span class="px-2 py-1 text-xs font-medium rounded-full bg-emerald-100 text-emerald-800">
                                Great
                            </span>
                        </div>
                    `;
                }).join('') 
                : '<p class="text-gray-500 text-center py-4">No devices in great condition found</p>';

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function hideGreatDevices() {
            const modal = document.getElementById('great-devices-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function showWarningDevices() {
            const modal = document.getElementById('warning-devices-modal');
            const devicesList = document.getElementById('warning-devices-list');
            devicesList.innerHTML = '<p class="text-gray-500 text-center py-4">Status detection coming soon</p>';
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function hideWarningDevices() {
            const modal = document.getElementById('warning-devices-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function showCriticalDevices() {
            const modal = document.getElementById('critical-devices-modal');
            const devicesList = document.getElementById('critical-devices-list');
            devicesList.innerHTML = '<p class="text-gray-500 text-center py-4">Status detection coming soon</p>';
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function hideCriticalDevices() {
            const modal = document.getElementById('critical-devices-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        // Fetch devices immediately and then every 30 seconds
        fetchDevices();
        const interval = setInterval(fetchDevices, 30000);

        // Cleanup interval when page is unloaded
        window.addEventListener('unload', () => {
            clearInterval(interval);
        });
    </script>
</body>
</html> 